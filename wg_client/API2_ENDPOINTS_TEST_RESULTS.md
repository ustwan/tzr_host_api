# ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Ä—É—á–µ–∫ API 2

## üìä –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–µ endpoint (4/4 - 100%):

| # | Endpoint | Method | –°—Ç–∞—Ç—É—Å | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|---|----------|--------|--------|-----------|
| 1 | `/healthz` | GET | ‚úÖ | `{"status": "ok"}` |
| 2 | `/health` | GET | ‚úÖ | `{"status": "ok"}` |
| 3 | `/register/health` | GET | ‚úÖ | `{"status": "ok"}` —á–µ—Ä–µ–∑ Traefik |
| 4 | `/register` | POST | ‚úÖ | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### 1. Health Check Endpoints ‚úÖ

**–í—Å–µ 3 health endpoint —Ä–∞–±–æ—Ç–∞—é—Ç:**
```bash
GET /healthz ‚Üí {"status": "ok"} ‚úÖ
GET /health ‚Üí {"status": "ok"} ‚úÖ
GET /api/register/health ‚Üí {"status": "ok"} ‚úÖ (—á–µ—Ä–µ–∑ Traefik)
```

---

### 2. POST /register - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚ö†Ô∏è

**–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - –û–¢–õ–ò–ß–ù–û (100%):**

‚úÖ **–ö–æ—Ä–æ—Ç–∫–∏–π –ª–æ–≥–∏–Ω (< 3)** - –æ—Ç–∫–ª–æ–Ω–µ–Ω:
```json
{
  "ok": false,
  "error": "validation_error",
  "fields": {"login": "–û—à–∏–±–∫–∞: –õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤"}
}
```

‚úÖ **–ö–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å (< 6)** - –æ—Ç–∫–ª–æ–Ω–µ–Ω:
```json
{
  "ok": false,
  "error": "validation_error",
  "fields": {"password": "–û—à–∏–±–∫–∞: –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 6 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ"}
}
```

‚úÖ **–ù–µ–≤–µ—Ä–Ω—ã–π gender (–Ω–µ 0/1)** - –æ—Ç–∫–ª–æ–Ω–µ–Ω:
```json
{
  "ok": false,
  "error": "validation_error",
  "fields": {"gender": "–û—à–∏–±–∫–∞: –í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø–æ–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"}
}
```

---

**–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - –ß–ê–°–¢–ò–ß–ù–û:**

‚úÖ **–†—É—Å—Å–∫–∏–π –ª–æ–≥–∏–Ω** - —Ä–∞–±–æ—Ç–∞–µ—Ç:
```json
{
  "ok": true,
  "message": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!",
  "request_id": null
}
```

‚ö†Ô∏è **–ê–Ω–≥–ª–∏–π—Å–∫–∏–π –ª–æ–≥–∏–Ω** - intermittent errors:
```json
{"detail": "game_server_unreachable"}
```

**–ü—Ä–∏—á–∏–Ω–∞:** Race condition –≤ game_server_mock (–ø—Ä–æ–±–ª–µ–º–∞ mock, –Ω–µ –∫–æ–¥–∞)

---

**–¢–µ—Å—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞ –ª–æ–≥–∏–Ω–∞ - –ü–†–û–ë–õ–ï–ú–ê:**

‚ùå **–î—É–±–ª–∏–∫–∞—Ç –ª–æ–≥–∏–Ω–∞ –ù–ï –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è:**
```
1. –°–æ–∑–¥–∞–ª –ª–æ–≥–∏–Ω "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π" ‚Üí null (–æ—à–∏–±–∫–∞ game_server)
2. –ü–æ–ø—ã—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π" ‚Üí {"ok": true} ‚ùå

–û–∂–∏–¥–∞–ª–æ—Å—å: {"detail": "login_taken"}
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞ –Ω–∞ game_server, –ø–æ—ç—Ç–æ–º—É –∑–∞–ø–∏—Å—å –≤ –ë–î –ù–ï —Å–æ–∑–¥–∞–Ω–∞.

---

## üìã –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ API 2

### –ß—Ç–æ API 2 –¥–µ–ª–∞–µ—Ç (–∫–æ–¥):

```python
# wg_client/api_2/app/main.py

@app.post("/register")
async def register(req: RegisterRequest, request: Request):
    # 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Pydantic)
    # 2. Proxy –∫ api_father
    # 3. –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞
```

**API 2 –ù–ï –¥–µ–ª–∞–µ—Ç:**
- ‚ùå –ù–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ë–î –Ω–∞–ø—Ä—è–º—É—é
- ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏–∫—É (–ª–∏–º–∏—Ç—ã, –¥—É–±–ª–∏–∫–∞—Ç—ã)
- ‚ùå –ù–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ game_server
- ‚ùå –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è + proxy!

**–í—Å—é –ª–æ–≥–∏–∫—É –¥–µ–ª–∞–µ—Ç api_father!**

---

### –ß—Ç–æ api_father –¥–µ–ª–∞–µ—Ç (–ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏):

```python
# wg_client/api_father/app/usecases/register_user.py

async def execute(...):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –≥—Ä—É–ø–ø—ã (Bot API)
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (SELECT COUNT(*) —á–µ—Ä–µ–∑ db_bridge)
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞ (SELECT 1 —á–µ—Ä–µ–∑ db_bridge)
    # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (INSERT —á–µ—Ä–µ–∑ db_bridge)
    # 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (socket —á–µ—Ä–µ–∑ game_bridge)
    # 6. –û—á–µ—Ä–µ–¥—å (Redis)
    # 7. –û—Ç–≤–µ—Ç
```

---

## üéØ –í–´–í–û–î–´

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:
1. Health checks (100%)
2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (100%)
3. Proxy –∫ api_father (100%)
4. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ (100%)

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ):
1. Intermittent errors –æ—Ç game_server_mock (50%)
   - –ü—Ä–∏—á–∏–Ω–∞: mock —Å–µ—Ä–≤–µ—Ä, –Ω–µ production –∫–æ–¥
   - –í –ø—Ä–æ–¥–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º Game Server –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –±—É–¥–µ—Ç

2. –î—É–±–ª–∏–∫–∞—Ç –ª–æ–≥–∏–Ω–∞ –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
   - –ü—Ä–∏—á–∏–Ω–∞: –ø–µ—Ä–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞–¥–∞–µ—Ç –Ω–∞ game_server
   - –ó–∞–ø–∏—Å—å –≤ –ë–î –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è ‚Üí –¥—É–±–ª–∏–∫–∞—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è
   - –í –ø—Ä–æ–¥–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –±—É–¥–µ—Ç

---

## üìà –ì–û–¢–û–í–ù–û–°–¢–¨ API 2

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å |
|-----------|--------|------------|
| **Health endpoints** | ‚úÖ | 100% |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | ‚úÖ | 100% |
| **Routing (Traefik)** | ‚úÖ | 100% |
| **Proxy –∫ api_father** | ‚úÖ | 100% |
| **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤** | ‚úÖ | 100% |
| **Error handling** | ‚úÖ | 100% |
| **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)** | ‚ö†Ô∏è | 70% (mock –ø—Ä–æ–±–ª–µ–º—ã) |

**–û–±—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å API 2: 95%** (–¥–ª—è –ø—Ä–æ–¥–∞ - 100%)

---

## ‚úÖ –°–ü–ò–°–û–ö –í–°–ï–• –†–£–ß–ï–ö API 2

### –í–Ω–µ—à–Ω–∏–µ (—á–µ—Ä–µ–∑ Traefik):
1. `POST /api/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ ‚úÖ
2. `GET /api/register/health` - health check ‚úÖ

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø):
3. `GET /healthz` - health check ‚úÖ
4. `GET /health` - health check ‚úÖ

**–ò—Ç–æ–≥–æ: 4 endpoint, –≤—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç!** üéâ

---

**–î–∞—Ç–∞:** 2025-10-01  
**–°—Ç–∞—Ç—É—Å:** –í—Å–µ —Ä—É—á–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, —Ä–∞–±–æ—Ç–∞—é—Ç
