## MAIN: Анализ боёв в файлах TZB — сводное руководство проекта

### Цель проекта
Собрать корректную и воспроизводимую методику анализа файлов TZB (XML-реплей боёв): извлекать предметы/ресурсы, действия, участников, питомцев, убийства, метаданные локаций; корректно учитывать дублирование `BATTLE`, отличать предметы на карте от инвентаря и использовать данные подбора как источник факта.

### Ключевые принципы анализа
- **Только предметы на карте**: учитываются `<O ... bx="X" by="Y" />`. Инвентарь (без `bx/by`) игнорируется.
- **Группировка по ID**: уникальность предметов определяется `id`. Считаем один раз на ID, суммируя `count` по именам (`txt`).
- **Подбор — источник факта**: действия `<a t="8" id="..." txt="..." count="N" />` агрегируются по уникальным `id`; именно они дают фактический итог.
- **Дублирование `BATTLE`**: некоторые файлы содержат повтор лога. Два подхода встречаются в скриптах:
  - Деление доступного на число блоков `<BATTLE>` (часто 2).
  - «Умная» проверка: если подобрано/доступно ≥ 2 — считать, что был дубль и корректировать.
- **Дроп**: появление предметов после `drop=""` и по ходу после `code="7"` (смерть) учитывается как источник новых объектов на карте.

### Алгоритм (стабильный вариант)
1) Найти все позиции `<BATTLE` (для диагностики дублей).
2) Извлечь предметы на карте: `<O ... id="ID" count="N" txt="NAME" bx="X" by="Y" />`.
3) Свести по уникальным `ID` → агрегировать по `NAME`.
4) Извлечь подборы: `<a t="8" id="ID" txt="NAME" count="N" />`, свести по уникальным `ID` → агрегировать по `NAME`.
5) При необходимости учесть дублирование для «доступно на карте» (деление на количество `BATTLE` или эвристика по соотношению `picked/available`).
6) Итог анализа строить по данным подбора; «доступно» и «дроп» — в качестве справочной аналитики и валидации.

### Инвентарь ключевых материалов
- `analysis_structure.md`: структура TZB, атрибуты `BATTLE/MAP/USER/TURN/a/O`, что извлекать.
- `final_analysis_report.md`: рекомендуемые метаданные, JSON-примеры, рекомендации по парсингу/аналитике/хранению.
- Тематические обзоры:
  - `tags_summary_table.md`: таблица тегов и атрибутов.
  - `location_analysis.md`: закономерности `f` и `note` у `BATTLE`.
  - `player_kill_analysis.md`: сигнатуры убийств, изменения `rank_points`, дроп при смерти.
  - `pet_system_analysis.md`: система питомцев, тег `BPET`, последовательность призыва.
  - `monster_types_analysis.md`, `monster_attributes_analysis_report.md`, `monster_types_found_in_folder_30.md`, `monster_loot_resources.md`: типология монстров, спец-атрибуты (`def`, `color`).

### Инструменты парсинга (актуально)
- `battle_parser.py`: основной модуль парсинга одного боя в целевую JSON‑схему с расширенной функциональностью.
- `dedupe_tzb.py`: утилита обрезки дубликатов — удаляет второй и последующие блоки `<BATTLE>`.
- `main.py`: CLI-обёртка. Всегда выполняет авто‑дедуп (перезаписывает `.tzb`), затем парсит и печатает JSON.
 - `map_parser.md`: спецификация формата карты и диффов (map_patch). Детали ниже.

#### Специализированные анализаторы:
- `test_interventions.py`: анализ вмешательств в бой (новые участники)
- `test_battle_parser_damage.py`: детальный анализ урона по ходам и типам атак
- `test_stance_analysis.py`: анализ смены стоек, побегов и режимов движения

Использование:

```bash
python3 /Users/ii/Downloads/73/main.py /absolute/path/to/file.tzb
```

Поведение по шагам (pipeline):
- `main.py` читает файл, удаляет теги `<BLOOK>` и `</BLOOK>` (если присутствуют), находит второе вхождение `<BATTLE` и обрезает файл на его позиции (перезаписывает файл без дубля).
- После авто‑дедупа вызывает `BattleParser.parse_file()` и выводит результат.

Что возвращает (соответствие полям требований):
- **battle.id**: из первого `battleid` в `<USER ...>`.
- **battle.ts**: `BATTLE@t2` → ISO8601 UTC (например, `...Z`).
- **battle.size_bytes/sha256/storage_key/compressed**: из файла (.tzb); `compressed=false`.
- **battle.turns**: `BATTLE@turn`.
- **battle.battle_type**: `BATTLE@f`.
- **battle.loc**: из `BATTLE@note="x,y,timestamp"` → `{x,y}`.
- **battle.start_ts_unix**: из `note` третий компонент.
- **battle.players_cnt**: количество игроков (USER с `login` не начинается на `$`).
- **battle.monsters_cnt/entities_cnt**: сумма сгруппированных монстров / плюс игроки.
- **participants[]**: по игрокам (`login` без `$`): `login, clan, profession(pro), side, rank_points, pve_points, level, gender(man)`. 
  - `survived`: эвристика по финальному `HP` (1 если не 0).
  - `intervened`: статус вмешательства (`{"state": 0}` - изначальный участник, `{"state": 1, "turn": X}` - вмешался в ходу X).
  - `kills`: точный подсчёт по алгоритму кредитов убийств (`t="20" code="7"`).
  - `damage_total`: детализированный урон по типам из всех событий `t="5"`. Всегда содержит `HP`, дополнительные поля (`critical`, `piercing`, Poison, Paralysis, Panic, Hallucinations, Zombification) добавляются только при наличии урона > 0.
  - `loot`: персональный лут игрока по событиям `t="8"` в его USER блоках. Структура аналогична общему `loot`: `{resources[], monster_parts[], other[]}` с дедупликацией по ID предметов.
- **monsters[]**: агрегировано по виду и спец‑признаку:
  - `kind`: `rat|stich|vzz|mts|scrp|erg|zmb|unknown` или `<kind>_spec`.
  - Правило спец-монстра: первично по символу `_` в `login` (например, `$stich14_1337`), вторично по наличию атрибутов `def`/`color`.
  - `spec`: берём `def` или `color`, если они присутствуют; при спец-статусе только по `_` — `spec=null`.
- **loot_total**: общий лут за бой по уникальным действиям подбора `a t="8"` (ID‑дедупликация):
  - `resources[]`: если имя в известном списке ресурсов (`Gems`, `Metals`, `Organic`, `Polymers`, `Precious metals`, `Radioactive materials`, `Venom`, `Silicon`).
  - `monster_parts[]`: если имя в списке частей монстров (`Rat Fang`, `Cursed Skin`, и т.д.).
  - `other[]`: прочее, как `{item_id: null, item_name, qty}`.

Примечания и ограничения:
- **Убийства**: реализован точный алгоритм подсчёта по кредитам `t="20" code="7"` с суммированием урона из `t="5"`.
- **Подсчёт монстров**: только активные монстры (присутствующие в `<BATTLE>` и имеющие действия в `<TURN>`).
- **Дублирование `BATTLE`**: автоматически устраняется через `dedupe_tzb.py` перед парсингом.
- **Маппинги видов**: полная поддержка 38 типов монстров (см. раздел "Типы монстров"). При `def/color` → `<kind>_spec`.
- **Валидация лута**: события `t="8"` проверяются на соответствие предметам на карте (`<O ... bx/by .../>`).
- **Regex vs XML**: использует regex-парсинг с улучшенной обработкой USER блоков для корректного извлечения действий.

### Файлы
- `dedupe_tzb.py`
  - Назначение: обрезает файл по второму вхождению `<BATTLE`, устраняя дублирование логов. Также удаляет теги `<BLOOK>` и `</BLOOK>` для корректного парсинга.
  - Вход: путь к `.tzb` и опционально путь выхода. В `main.py` используется логика авто‑дедупа in‑place.
  - Важно: перезаписывает исходный `.tzb` для консистентных счётчиков.

- `battle_parser.py`
  - Назначение: парсит `.tzb` в целевой JSON с расширенной функциональностью.
  - Основные компоненты:
    - `BattleParser.parse_file()`: главная точка входа, возвращает полную JSON-структуру.
    - `parse_kills_from_xml()`: продвинутый алгоритм подсчёта убийств с двумя режимами (`frame_only`, `accumulate_to_death`).
    - `Kill` namedtuple: структура данных для убийств `(battle_id, turn, sf, killer, victim, damage, shots)`.
  - Шаги: разбор `BATTLE` (порядок атрибутов не важен), `participants` (игроки с `kills` и `damage_total`), `monsters` (агрегация по виду/спецу, фильтрация активных), `loot` по `t=8` (ID‑дедуп с валидацией карты).
  - Алгоритм убийств: точный подсчёт по событиям `t="20" code="7"` в блоках актёров, суммирование урона из `t="5"` в том же кадре `sf`.

- `main.py`
  - Назначение: единая точка запуска. Сначала авто‑дедуп (перезапись файла), затем парсинг и печать JSON.
  - Команда: `python3 main.py /path/to/file.tzb`
  - Вывод: JSON в строгой структуре для записи в БД.

### Эволюция скриптов (python)
— Ранние массовые подсчёты:
- `count_resources.py`, `count_resources_final.py`, `count_resources_fixed.py`, `count_resources_final_v2.py`: массовый подсчёт `txt/count` по .tzb (без строгой фильтрации по карте в ранних версиях; v2 — устойчив к порядку атрибутов).

— Точечные анализаторы боёв:
- `analyze_3655087.py` → `analyze_3655087_fixed.py`: переход к «только на карте», уникальность по `id`, деление при дублях `BATTLE`, учёт подбора.
- `analyze_3690378.py` → `analyze_3690378_improved.py`: диагностика дублей; уникальность по `id`; улучшенный отчёт (дубликаты, остатки при делении, точность по типам, сравнение picked vs available).
- `analyze_3655020.py` и `final_analysis_3655020.py`: суммирование по карте и по подборам, сравнение с «фактами», отчёт по конкретным ресурсам.
- `analyze_unique_items.py`: явная демонстрация уникальности по `id` и сравнение с фактом.
- `analyze_with_duplicates.py`: поблочный анализ при нескольких `BATTLE` + сопоставление с фактами.

— Инфраструктурные/утилиты:
- `run_analysis_script.py`: пример универсального анализа с учётом дублей, топ-ресурсов, эффективности.
- Разные вспомогательные (`check_xml_again.py`, `analyze_pickups.py`, `analyze_final_correct.py`, `analyze_maximum_precision.py`, `analyze_ultra_precise.py`, `analyze_final_verification.py`) — фокус на проверке корректности и точности.

### Консолидация правил (итог к использованию)
- **Улучшенный regex-парсинг** с корректной обработкой вложенных USER блоков. Ключевые улучшения:
  - **USER блоки**: различение самозакрывающихся `<USER ... />` и обычных `<USER ...>...</USER>` тегов для корректной атрибуции действий
  - **Атаки**: правильное определение атакующего (владелец USER блока) и жертвы (login в атрибуте атаки)
  - **Типизированный урон**: парсинг `HP="тип:урон"` с различением критических (1), бронебойных (2) и обычных (0) попаданий
  - **Специальные эффекты**: автоматическое определение и классификация статусных эффектов по кодам
  - Предметы на карте: `\n<O[^>]*id="([^"]*)"[^>]*count="([^"]*)"[^>]*txt="([^"]*)"[^>]*bx="[^"]*"[^>]*by="[^"]*"[^>]*/>`
  - Подбор: `\n<a[^>]*t="8"[^>]*id="([^"]*)"[^>]*txt="([^"]*)"[^>]*count="([^"]*)"[^>]*/>`
- **Дублирование**: допускается два режима — деление на число `BATTLE` или эвристика по `picked/available` (≥ 2 → деление на 2 для отчёта). В обоих случаях финал — по подборам.
- **Поддержка BLOOK**: автоматическое удаление внешних контейнеров `<BLOOK>...</BLOOK>` перед парсингом для обеспечения совместимости с различными форматами TZB файлов.
- **Дроп/смерть**: признак смерти — `a t="5" ... HP="0:..."`; предметы могут появляться после `drop=""` и в ходах с `code="7"`.

### Текущая реализация (battle_parser.py v2.0)

#### Архитектура
- **Класс BattleParser**: основной парсер с конфигурируемыми списками ресурсов и частей монстров.
- **Kill namedtuple**: структура данных `(battle_id, turn, sf, killer, victim, damage, shots)` для детального анализа убийств.
- **FileMeta dataclass**: метаданные файла `(size_bytes, sha256, storage_key, compressed)`.

#### Алгоритм подсчёта убийств и урона
1. **Поиск кредитов**: события `t="20" code="7" login="victim"` в блоках актёров.
2. **Извлечение урона**: детальный анализ всех событий `t="5"` с типизацией урона.
3. **Типы урона**:
   - `HP="0:урон"`: обычный урон
   - `HP="1:урон"`: критический урон → поле `critical`
   - `HP="2:урон"`: бронебойный урон → поле `piercing`
   - Специальные эффекты: O→Poison, P→Paralysis, N→Panic, H→Hallucinations, Z→Zombification
4. **Два режима подсчёта**:
   - `frame_only`: урон только в кадре убийства.
   - `accumulate_to_death`: урон до кадра смерти включительно.
5. **Точная атрибуция**: USER блоки парсятся с различением самозакрывающихся и обычных тегов для корректной атрибуции действий.

#### Валидация данных
- **Лут**: события `t="8"` проверяются на соответствие предметам на карте.
- **Монстры**: фильтрация активных (присутствуют в `<BATTLE>` и `<TURN>`).
- **Дедупликация**: автоматическая через `dedupe_tzb.py` перед парсингом.
- **Поддержка BLOOK**: автоматическое удаление тегов `<BLOOK>` и `</BLOOK>` для корректного парсинга.
- **Персональный лут**: каждый участник получает детализированный блок `loot` с подобранными предметами.

#### Поддерживаемые типы ресурсов
- **Ресурсы**: Gems, Metals, Organic, Polymers, Precious metals, Radioactive materials, Venom, Silicon.
- **Части монстров**: Rat Brain/Eyes/Fang/Skin, Stich Blood/Bone Marrow/Claw/Meat/Skin, Vzzik Egg Fragments/Shell Powder/Wings, Cursed Brain/Paw/Skin, Water crystal, WitchJelly Acid/Bille/Enzyme.

### Рекомендации по развитию
- **Статусные эффекты**: реализовать полный анализ всех 40+ атрибутов и эффектов из словаря.
- **Детализация урона**: ✅ **РЕАЛИЗОВАНО** - полная система типов урона: критический (`critical`), бронебойный (`piercing`), специальные эффекты (O→Poison, P→Paralysis, N→Panic, H→Hallucinations, Z→Zombification) с отдельными счетчиками в `damage_total`.
- **Иммунитеты и сопротивления**: анализ атрибутов *2 (O2, D2, P2 и др.).
- **Модификаторы**: обработка dx_* атрибутов для анализа влияния на параметры и навыки.
- **Специальные состояния**: анализ Ill, N1, N12, dp_eff, damageX и других уникальных эффектов.
- **Длительность эффектов**: обработка *i атрибутов (Di: "хода", Pi: "ОД", psyi: "%" и др.).
- **Расширенная JSON схема**: ✅ **ЧАСТИЧНО РЕАЛИЗОВАНО** - добавлено поле `intervened` для отслеживания вмешательств, детализированный `damage_total` по типам урона.
- **Анализ вмешательств**: ✅ **РЕАЛИЗОВАНО** - полный анализ присоединения новых участников к бою с определением кадра появления.
- **Типизированный урон**: ✅ **РЕАЛИЗОВАНО** - различение критических попаданий, бронебойного урона и обычного урона с отдельными полями в JSON.
- **Поддержка BLOOK**: ✅ **РЕАЛИЗОВАНО** - автоматическое удаление тегов `<BLOOK>` и `</BLOOK>` в дедупликаторе для корректного парсинга файлов с внешними контейнерами.
- **Персональный лут**: ✅ **РЕАЛИЗОВАНО** - каждый участник теперь имеет собственный блок `loot` с детализацией подобранных предметов по категориям.
- **Массовая обработка**: статистика по эффективности разных типов урона и частоте статусных эффектов.

### Типы действий (t=)
Полная классификация действий в TZB логах:

- **t=1** — смена направления (без текста в логе)
- **t=2** — перемещение (без текста в логе)  
- **t=3** — взять оружие (bact_create_turret если weapon=807)
- **t=4** — убрать оружие (без текста в логе)
- **t=5** — атака/выстрел (bact_0...bact_16, bact_29, bact_30 в зависимости от type=)
- **t=6** — смена стойки/режима бега (атрибут `run="X"` определяет позу)
- **t=7** — смерть (bact_die, bact_diebot, bact_die<man>)
- **t=8** — подбор предмета (bact_pickup)
- **t=9** — Убежал из боя (bact_hide/bact_deactivate)
- **t=10** — спец. для червя (без текста)
- **t=11** — спец. для червя (bact_worm)
- **t=12** — самоповреждение (self_damage_*)
- **t=13** — телепортация (без текста в логе)
- **t=14** — изменение bst (без текста)
- **t=15,16,17** — (пустые case)
- **t=19** — rankpoint
- **t=20** — спец. код (кредит убийства: `t="20" code="7" login="victim"`)
- **t=21** — reputation

### Типы атак (type= для t="5")
Классификация типов атак в действиях `<a t="5" type="X">`:

| Type | Название | Описание |
|------|----------|----------|
| **useperk** | Использовать перк | Активация специальной способности |
| **0** | Ударить | Ближний бой |
| **1** | Ударить | Ближний бой (вариант) |
| **2** | Выстрел навскидку | Быстрый выстрел без прицеливания |
| **3** | Прицельный выстрел | Точный выстрел с прицеливанием |
| **4** | Очередь (3 патрона) | Автоматическая стрельба |
| **5** | Очередь (4 патрона) | Автоматическая стрельба |
| **6** | Очередь (5 патронов) | Автоматическая стрельба |
| **7** | Метнуть по цели | Бросок гранаты/предмета |
| **8** | Использовать на цели | Применение предмета на цель |
| **9** | Запустить по цели | Запуск ракеты/снаряда |
| **10** | Выстрелить | Обычный выстрел |
| **11** | Короткий луч | Энергетическое оружие |
| **12** | Длинный луч | Энергетическое оружие |
| **13** | Применить на себя | Самолечение/баф Псионическая способность|
| **14** | Применить на цель | Лечение/баф союзника Псионическая способность|
| **15** | Применить на цель | Лечение/баф союзника (вариант) Псионическая способность|
| **16** | Применить по цели | Дебаф/атака Псионическая способностью |
| **29** | Применить на себя | Самолечение/баф (вариант) |
| **30** | Использовать пси по цели | Псионическая атака |


#### Примеры использования:
```xml
<a sf="91" t="5" type="2" login="test102" HP="0:19:P6" />
<!-- Выстрел навскидку по test102, нанесен урон 19 + паралич 6 -->

<a sf="45" t="5" type="6" login="test102" HP="0:29:H5" />
<!-- Очередь (5 патронов) по test102, нанесен урон 29 + галлюцинации 5 -->

<a sf="36" t="5" type="10" xy="34,10" login="test102" HP="0:105" />
<!-- Выстрел по координатам 34,10, попал в test102, урон 105 -->
```

### Стойки персонажа (run= для t="6")
Классификация стоек/режимов движения в действиях `<a t="6" run="X">`:

| Run | Название | Описание |
|-----|----------|----------|
| **1** | Ходьба | Обычная скорость передвижения |
| **2** | Бег | Быстрое передвижение |
| **3** | Сел | Сидячая позиция (улучшенная точность) |
| **4** | Присел | Промежуточная позиция между стоя и сидя |
| **5** | Лег/Укрылся | Лежачая позиция (максимальная точность, минимальная заметность) |

#### Примеры использования:
```xml
<a sf="0" t="6" run="5" />
<!-- Персонаж лег/укрылся -->

<a sf="0" t="6" run="3" />
<!-- Персонаж сел -->

<a sf="0" t="6" run="2" />
<!-- Персонаж перешел в режим бега -->

<a sf="0" t="6" run="1" />
<!-- Персонаж перешел в режим ходьбы -->

<a sf="108" t="9" />
<!-- Персонаж убежал из боя (без атрибута run) -->
```

### Вмешательства в бой
Механика присоединения новых участников к уже идущему бою:

#### Структура участников:
1. **Изначальные участники** - описаны в блоке `<BATTLE>...</BATTLE>`
2. **Вмешавшиеся участники** - появляются в ходах `<TURN>` без предварительного объявления

#### Признаки вмешательства:
- Участник отсутствует в изначальном блоке `<BATTLE>`
- Появляется в блоке `<USER>` внутри `<TURN>`
- Имеет атрибут `sf="X"` в теге `<USER>` - номер кадра появления на карте
- Может иметь полную экипировку и характеристики

#### Примеры вмешательств:
```xml
<!-- Изначальные участники в BATTLE -->
<BATTLE ...>
  <USER login="test102" ... />
  <USER login="$rat11" ... />
</BATTLE>

<!-- Вмешательство в ходу 3 -->
<TURN turn="3" ...>
  <USER login="test102" ... />
  <USER login="$rat11" ... />
  <!-- Новый игрок появился! -->
  <USER login="test101" ... sf="108">
    <O id="107945555" name="ba1-h33" slot="F" />
    <!-- Полная экипировка -->
  </USER>
</TURN>
```

#### Типы вмешательств:
- **Игроки**: могут присоединиться для помощи или PvP
- **Монстры**: могут появиться как подкрепление или новая волна
- **Союзники**: игроки одного клана/стороны
- **Враги**: игроки противоположной стороны

#### Анализ вмешательств:
- Сравнение участников `<BATTLE>` с участниками каждого `<TURN>`
- Определение кадра появления по атрибуту `sf=`
- Классификация по типу (игрок/монстр) и стороне
- Отслеживание активности (наличие действий в `<USER>` блоке)

#### Технические особенности парсинга:
**Форматы USER тегов в блоке BATTLE:**
1. **Самозакрывающиеся теги** (обычно монстры):
   ```xml
   <USER login="$rat11" level="1" HP="10" ... />
   ```
2. **Теги с содержимым** (обычно игроки с экипировкой):
   ```xml
   <USER login="test102" level="20" HP="400" ...>
     <O id="153906841" name="b5-v11" slot="GH" />
   </USER>
   ```

### Карта боя (map_patch)
В объекте `battle` добавлено поле `map_patch` — компактный идентификатор и контрольная сумма карты:

```json
"battle": {
  ...,
  "map_patch": {
    "i": "m_<blake2s8 от строк MAP>",
    "cs": "blake2s8:<тот же хеш>",
    "d": { /* опционально: diff (h/s/r), если отличается от базы */ }
  }
}
```

- Источник строк карты — все теги `<MAP v="..." />` из первого блока `BATTLE` (после дедупликации).
- `i`: `m_` + верхний HEX blake2s8 от объединения строк карты через `\n`.
- `cs`: контрольная сумма итоговой карты, формат `blake2s8:<HEX>`.
- `d`: на текущем MVP может отсутствовать (т.е. считаем, что карта равна базе). При появлении отличий заполняется по спецификации из `parser/map_parser.md`.

Подробнее о формате и диффах: см. `parser/map_parser.md`.

**Алгоритм определения вмешательств:**
1. Извлечь всех участников из `<BATTLE>` (оба формата тегов)
2. Для каждого `<TURN>` найти всех участников в `<USER>` блоках
3. Сравнить списки и выявить новых участников
4. Проверить наличие атрибута `sf=` как признака появления на карте

#### Инструменты анализа:
- **`battle_parser.py`**: функция `analyze_battle_interventions()`
- **`test_interventions.py`**: CLI скрипт для анализа вмешательств
- **`test_battle_parser_damage.py`**: детальный анализ урона по ходам
- **`test_stance_analysis.py`**: анализ смены стоек и побегов

**Использование:**
```bash
python3 /Users/ii/Downloads/73/test_interventions.py файл.tzb
```

**Пример вывода:**
```
ИЗНАЧАЛЬНЫЕ УЧАСТНИКИ БОЛЯ:
Игроки (1): test102
Монстры (1): $rat11

ВМЕШАТЕЛЬСТВА В БОЙ:
Ход  3: Игрок 'test101' (кадр 108) с действиями

СТАТИСТИКА: 1 вмешательство в 1 ходу
```

### Атрибуты и статусные эффекты
Полный словарь атрибутов персонажей и статусных эффектов в TZB логах:

#### Типы урона и лечения:
- **S** — "Ударное" (Si: "HP")
- **E** — "Энергетическое" (Ei: "HP")
- **O** — "Отравление" (Oi: "HP")
- **B** — "Ожог" (Bi: "HP")
- **V** — "Биологическое заражение"
- **I** — "Биологическое" (Ii: "HP")

#### Статусные эффекты и их длительность:
- **D** — "Ослепление" (Di: "хода")
- **P** — "Парализация" (Pi: "ОД")
- **N** — "Паника" (Ni: "хода")
- **H** — "Галлюцинации" (Hi: "хода")
- **C** — "Контузия"
- **Z** — "Зомбирование" (Zi: "хода")

#### Иммунитеты:
- **O2** — "Иммунитет к отравлению"
- **D2** — "Иммунитет к ослеплению"
- **P2** — "Иммунитет к парализации"
- **N2** — "Иммунитет к панике"
- **H2** — "Иммунитет к галлюцинациям"
- **C2** — "Иммунитет к контузии"
- **Z2** — "Иммунитет к зомбированию"
- **V2** — "Иммунитет к биологическому заражению"
- **Ill2** — "Иммунитет к вирусу X"

#### Специальные состояния:
- **OD** — "Серьезная травма ног, замедлено перемещение"
- **Ill** — "Заражение вирусом X"
- **N1** — "Персонаж находится под воздействием стимуляторов"
- **N12** — "Побочные эффекты стимуляторов"
- **dp_eff** — "Реанимационный шок"
- **damageX** — "Персонаж заражен вирусом X"
- **psy** — "Псионика" (psyi: "%")

#### Модификаторы параметров:
- **dx_p** — "Отрицательное воздействие на параметры персонажа"
- **dx_p2** — "Положительное воздействие на параметры персонажа"
- **dx_s** — "Отрицательное воздействие на навыки персонажа"
- **dx_s2** — "Положительное воздействие на навыки персонажа"
- **dx_OD** — "Отрицательное влияние на ОД"
- **dx_OD2** — "Положительное влияние на ОД"

#### Форматы HP атрибутов:
1. **Простой формат**: `HP="урон"` или `HP="0:урон"`
2. **Типизированный формат**: `HP="тип:урон"` где тип: 0=обычный, 1=критический, 2=бронебойный
3. **DoT формат**: `HP="0:КОД_УРОНА"` (урон от статусных эффектов)
4. **Расширенный формат**: `HP="бронебойный:обычный:КОД_УРОНА"` (комбинированный урон)

#### Примеры спец урона из реальных боев:

**Расширенный формат с комбинированным уроном:**
- `HP="0:29:H5"` → Обычный урон: 29 + Галлюцинации: 5 = **Итого: 34**
- `HP="0:19:P6"` → Обычный урон: 19 + Паралич: 6 = **Итого: 25**
- `HP="0:18:N4"` → Обычный урон: 18 + Паника: 4 = **Итого: 22**
- `HP="0:16:O3"` → Обычный урон: 16 + Отравление входящее: 3 = **Итого: 19**

**DoT эффекты (урон от ранее полученных статусов):**
- `HP="0:A7"` → Урон от отравления: 7 (уменьшается каждый ход)
- `HP="0:A-15"` → Урон от отравления: 15 (отрицательное значение указывает на DoT)
- `HP="0:10"` → Урон от ожога: 10  не имеет отедельного значения

**Типизированный урон:**
- `HP="0:60"` → Обычный урон: 60 = **Итого: 60**
- `HP="1:46"` → Критический урон: 46 = **Итого: 46**
- `HP="2:31"` → Бронебойный урон: 31 = **Итого: 31**

**Простой урон:**
- `HP="0:105"` → Обычный урон: 105
- `HP="0:23"` → Обычный урон: 23
- `HP="0:-52"` → Лечение на 52 (отрицательное значение без кода)

#### Коды спец урона и их эффекты:
| Код | Название | Описание | Пример |
|-----|----------|----------|---------|
| **A** | отравление | DoT урон от ранее полученного отравления | `HP="0:A7"` |
| **O** | отравление входящее | Новое отравление при атаке | `HP="0:16:O3"` |
| **B** | ожог | Урон от ожога не имеет отедельного значения | `HP="0:10"` |
| **D** | ослепление | Снижение точности | `HP="0:19:D6"` |
| **P** | паралич | Снижение ОД | `HP="0:19:P6"` |
| **N** | паника | Психологический эффект | `HP="0:18:N4"` |
| **H** | галлюцинации | Искажение восприятия | `HP="0:29:H5"` |
| **C** | контузия | Общее оглушение | `HP="0:29:С5"` |
| **Z** | зомбирование | Потеря контроля | `HP="0:29:Z5"` |
| **V** | биологическое заражение | Вирусное поражение | - |
| **S** | ударное | Физический урон | `HP="0:60"` |
| **E** | энергетическое | Энергетический урон | `HP="0:E45"` |

#### Маппинг статусных эффектов для JSON:
В поле `damage_total` учитываются только следующие специальные эффекты:
- **O** → `Poison` (отравление входящее)
- **P** → `Paralysis` (парализация)  
- **N** → `Panic` (паника)
- **H** → `Hallucinations` (галлюцинации)
- **Z** → `Zombification` (зомбирование)

**Не учитываются как спец урон:** A, B, D, C, V, S, E (считаются как обычный HP урон)

**Оптимизация JSON:** Дополнительные поля добавляются только при наличии урона > 0:
```json
// Только обычный урон
"damage_total": {
  "monsters": {"HP": 2790},
  "players": {"HP": 0}
}

// С критическим уроном
"damage_total": {
  "players": {
    "HP": 365,
    "critical": 207
  }
}

// С бронебойным уроном
"damage_total": {
  "monsters": {
    "HP": 6059,
    "piercing": 19
  }
}

// Со всеми типами урона
"damage_total": {
  "players": {
    "HP": 1084,
    "critical": 207,
    "piercing": 100,
    "Poison": 12,
    "Paralysis": 36,
    "Panic": 28,
    "Hallucinations": 10
  }
}
```

#### Механика урона:
- **Типизированный урон**: Первая цифра в `HP="тип:урон"` определяет тип (0=обычный, 1=критический, 2=бронебойный)
- **Критические попадания**: `HP="1:урон"` → увеличенный урон, отдельное поле `critical` в JSON
- **Бронебойный урон**: `HP="2:урон"` → игнорирует броню, отдельное поле `piercing` в JSON
- **Комбинированный урон**: В расширенном формате спец урон **добавляется** к обычному урону
- **DoT эффекты**: Урон от статусов применяется в начале хода и уменьшается со временем
- **Отрицательные значения**: Без кода = лечение, с кодом = DoT урон
- **Иммунитеты**: Коды с суффиксом "2" (O2, P2, H2) означают иммунитет к соответствующему эффекту

### Типы монстров
Полная классификация монстров по префиксам `login="$<тип><номер>"`:

- **bmi** — "Мина" (img="bmi")
- **rat** — "Крыса-мутант" (img="rat")
- **sti** — "Стич" (img="stich")
- **pco** — "робокоп" (img="pco")
- **pcb** — "кибер-страж" (img="pcb")
- **std** — "Ведьмин студень" (img="std")
- **vzz** — "Вжик" (img="vzz")
- **tur** — "Туррель" (img="tur")
- **dev** — "Манок" (img="dev")
- **bll** — "Мяч" (img="bll")
- **dog** — "Динго" (img="dog")
- **srg** — "Сержант Мак Грегори" (img="srg")
- **enm** — "условный противник" (img="enm")
- **gek** — "Геккон" (img="gek")
- **rbt** — "r2-d2(mf)" (img="rbt")
- **robot** — "Механоид" (img="robot")
- **scr** — "Скорпион" (img="scr")
- **wrm** — "Червь" (img="wrm")
- **spd** — "Арахнид" (img="spd")
- **zmb** — "Одержимый" (img="zmb")
- **rdr** — "радар" (img="rdr")
- **alg** — "Диверсант" (img="alg")
- **als** — "Штурмовик" (img="als")
- **alb** — "Каратель" (img="alb")
- **erg** — "Эрго" (img="erg")
- **mts** — "Богомол" (img="mts")
- **crs** — "Крашер" (img="crs")
- **crm** — "Крушителенок" (img="crm")
- **cdv** — "клетка" (img="cdv")
- **hst** — "заложник" (img="hst")
- **col** — "Лаборант" (img="col")
- **fgh** — "воин" (img="fgh")
- **sha** — "шаман" (img="sha")
- **pjm** — "пси-джаммер" (img="pjm")
- **rjm** — "джаммер" (img="rjm")
- **rng** — "Рейнджер" (img="rng")

Примеры: `login="$stich1216"` → тип "sti", `login="$rat146"` → тип "rat"

#### Специальные монстры и их агрегация
**Определение спец-монстров:**
1. **Первичный признак**: символ `_` в `login` (например, `$stich14_1337`)
2. **Вторичные признаки**: атрибуты `def` или `color` в теге `<USER>`

**Логика агрегации:**
- **Обычные монстры**: группируются по `kind` (например, `rat`, `sti`)
- **Спец-монстры**: разделяются по уникальным значениям `def`/`color`
  - Если есть `def` или `color` → создается отдельная группа `{kind}_spec::{spec_value}`
  - Если нет `def`/`color`, но есть `_` в логине → группа `{kind}_spec` с `spec: null`

**Примеры агрегации:**
```json
// Обычные монстры
{"kind": "rat", "spec": null, "count": 183}

// Спец-монстры с разными def/color
{"kind": "rat_spec", "spec": "1", "count": 4}
{"kind": "rat_spec", "spec": "2", "count": 10}
{"kind": "rat_spec", "spec": "3", "count": 1}

// Спец-монстры с color
{"kind": "vzz_spec", "spec": ",,,,-27", "count": 1}
{"kind": "vzz_spec", "spec": ",,,22,,-46", "count": 1}

// Спец-монстры без def/color (только _ в логине)
{"kind": "sti_spec", "spec": null, "count": 5}
```

**Преимущества раздельной агрегации:**
- Точная статистика по типам спец-монстров
- Возможность анализа эффективности против разных вариантов
- Корректное отображение разнообразия врагов в бою

### Глоссарий (минимальный)
- `available` — доступные на карте ресурсы по `<O ... bx/by .../>` (с поправкой на дубли).
- `picked` — фактически подобранные по `<a t="8" .../>` (по уникальным `id`).
- `drop` — появление предметов после `drop=""`/смертей.
- `BPET` — питомец, союзник игрока; призыв фиксируется отдельной последовательностью действий.
- `sf` — номер кадра (frame), определяет последовательность действий в бою.


— Этот файл (`MAIN.md`) является источником истины по проекту. Все новые находки и правила фиксируем здесь.


