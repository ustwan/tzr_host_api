# üß™ –¢–ï–°–¢: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –±–æ—ë–≤ –≤ /srv/btl/raw –∏ /srv/btl/gz

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢: **–í–°–Å –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û!**

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–æ—ë–≤:**
- 55 –±–æ—ë–≤ —á–µ—Ä–µ–∑ `fetch-old` (range: 3772000-3772054)
- 55 –±–æ—ë–≤ —á–µ—Ä–µ–∑ `fetch-old` (range: 3771945-3772000)
- **–ò—Ç–æ–≥–æ:** 110 –±–æ—ë–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ

**–°–ø–∞—Ä—Å–µ–Ω–æ —á–µ—Ä–µ–∑ api_mother:**
- 200+ —Ñ–∞–π–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω–æ
- 100% success rate –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå **Read-only —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤ API_4**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
[Errno 30] Read-only file system: '/srv/btl/raw/73/3699040.tzb'
```

**–ü—Ä–∏—á–∏–Ω–∞:**  
–¢–æ–º API_4 –±—ã–ª –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Ä–µ–∂–∏–º–µ `:ro` (read-only)

**–†–µ—à–µ–Ω–∏–µ:**
```yaml
# –ë–´–õ–û:
- /Users/ii/srv/btl:/srv/btl:ro

# –°–¢–ê–õ–û:
- /Users/ii/srv/btl:/srv/btl:rw
```

**–§–∞–π–ª:** `HOST_API_SERVICE_HEAVY_WEIGHT_API.yml` (—Å—Ç—Ä–æ–∫–∞ 44)

---

### 2. ‚úÖ **storage_key —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π**

**–ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```json
{
  "storage_key": "/tmp/tmpd582cooc.tzb"
}
```

**–°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```json
{
  "storage_key": "/srv/btl/raw/73/3699040.tzb"
}
```

---

## üéØ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ—è:

```
1. XML Workers
   ‚Üì
   –ó–∞–≥—Ä—É–∂–∞—é—Ç –±–æ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
   ‚Üì
   –°–æ—Ö—Ä–∞–Ω—è—é—Ç –≤ /srv/btl/raw/{shard}/{battle_id}.tzb
   ‚Üì
   –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤ api_mother —á–µ—Ä–µ–∑ POST /upload/{battle_id}

2. api_mother
   ‚Üì
   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ /srv/btl/raw/{shard}/{battle_id}.tzb
   ‚Üì
   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ API_4 —á–µ—Ä–µ–∑ POST /battles/upload
   ‚Üì
   (–µ—Å–ª–∏ auto_parse=true) –í—ã–∑—ã–≤–∞–µ—Ç /process-batch

3. API_4 (/battles/upload)
   ‚Üì
   –ò–∑–≤–ª–µ–∫–∞–µ—Ç battle_id –∏–∑ filename
   ‚Üì
   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ /srv/btl/raw/{shard}/{battle_id}.tzb
   ‚Üì
   –ü–∞—Ä—Å–∏—Ç —á–µ—Ä–µ–∑ external_parser
   ‚Üì
   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î —Å storage_key=/srv/btl/raw/{shard}/{battle_id}.tzb

4. api_mother (/process-batch)
   ‚Üì
   –ë–µ—Ä—ë—Ç —Ñ–∞–π–ª—ã –∏–∑ /srv/btl/raw
   ‚Üì
   –ü–∞—Ä—Å–∏—Ç —á–µ—Ä–µ–∑ API_4
   ‚Üì
   –°–∂–∏–º–∞–µ—Ç –≤ gzip ‚Üí /srv/btl/gz/{shard}/{battle_id}.tzb.gz
   ‚Üì
   –£–î–ê–õ–Ø–ï–¢ –∏–∑ /srv/btl/raw
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

**–ù–∞ —Ö–æ—Å—Ç–µ:**
```
/Users/ii/srv/btl/
‚îú‚îÄ‚îÄ raw/
‚îÇ   ‚îú‚îÄ‚îÄ 73/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 3680000.tzb
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 3681000.tzb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ 75/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 3750000.tzb
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 3751000.tzb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ gz/
    ‚îú‚îÄ‚îÄ 73/
    ‚îÇ   ‚îú‚îÄ‚îÄ 3680000.tzb.gz
    ‚îÇ   ‚îú‚îÄ‚îÄ 3681000.tzb.gz
    ‚îÇ   ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ ...
```

**–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö:**
- XML Workers: `/Users/ii/srv/btl/raw ‚Üí /srv/btl/raw (rw)`
- api_mother: `/Users/ii/srv/btl ‚Üí /srv/btl (rw)`
- API_4: `/Users/ii/srv/btl ‚Üí /srv/btl (rw)` ‚Üê **–ò–°–ü–†–ê–í–õ–ï–ù–û —Å ro –Ω–∞ rw**

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: storage_key –≤ –ë–î

```bash
curl -s 'http://localhost:8084/battle/3699040' | jq '{storage_key}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "storage_key": "/srv/btl/raw/73/3699040.tzb"  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å!
}
```

### –¢–µ—Å—Ç 2: –§–∞–π–ª—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

```bash
# –í /srv/btl/raw (–ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º)
ls /Users/ii/srv/btl/raw/73/3699040.tzb
# ‚úÖ –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

# –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å delete_after_parse=true
ls /Users/ii/srv/btl/raw/73/3699040.tzb
# ‚ùå –§–∞–π–ª —É–¥–∞–ª—ë–Ω (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

ls /Users/ii/srv/btl/gz/73/3699040.tzb.gz
# ‚úÖ –§–∞–π–ª —Å–∂–∞—Ç –∏ –ø–µ—Ä–µ–º–µ—â—ë–Ω
```

### –¢–µ—Å—Ç 3: –ú–∞—Å—Å–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥

```bash
curl -X POST 'http://localhost:8083/process-batch?limit=200&max_parallel=10&delete_after_parse=true'

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "processed": 200,
  "successful": 200,
  "compressed_to_gz": 200
}
# ‚úÖ 100% success rate
```

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

```
/srv/btl/raw:  ~69,406 —Ñ–∞–π–ª–æ–≤ (–Ω–µ—Å–∂–∞—Ç—ã–µ)
/srv/btl/gz:   ~1,234 —Ñ–∞–π–ª–æ–≤ (—Å–∂–∞—Ç—ã–µ, —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ)
```

**–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:** `battle_id // 50000`
- –®–∞—Ä–¥ 73: –±–æ–∏ 3,650,000 - 3,699,999
- –®–∞—Ä–¥ 75: –±–æ–∏ 3,750,000 - 3,799,999

---

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ

### 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –±–æ–∏

```bash
curl -X POST 'http://localhost:8084/admin/xml-sync/fetch-old?count=55&from_battle_id=3780000'
```

### 2. –°–ø–∞—Ä—Å–∏—Ç—å —á–µ—Ä–µ–∑ api_mother

```bash
curl -X POST 'http://localhost:8083/process-batch?limit=60&max_parallel=5&delete_after_parse=true'
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å storage_key

```bash
# –ù–∞–π—Ç–∏ ID –ª—é–±–æ–≥–æ –±–æ—è
ls /Users/ii/srv/btl/raw/75/ | head -1

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î
curl -s 'http://localhost:8084/battle/{battle_id}' | jq '{storage_key, compressed}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "storage_key": "/srv/btl/raw/75/{battle_id}.tzb",
  "compressed": false
}
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã

```bash
# –ü–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
ls /Users/ii/srv/btl/raw/75/{battle_id}.tzb  # ‚úÖ –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

# –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å delete_after_parse=true
ls /Users/ii/srv/btl/raw/75/{battle_id}.tzb  # ‚ùå –£–¥–∞–ª—ë–Ω
ls /Users/ii/srv/btl/gz/75/{battle_id}.tzb.gz  # ‚úÖ –°–∂–∞—Ç –∏ –ø–µ—Ä–µ–º–µ—â—ë–Ω
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**api_mother `/process-batch`:**
- `limit=10` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
- `max_parallel=1` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å
- `delete_after_parse=true` - —É–¥–∞–ª—è—Ç—å –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚úÖ

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `limit=100-500` - –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `max_parallel=5-10` - –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å
- `delete_after_parse=true` - –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –º–µ—Å—Ç–æ

---

## üéØ –ò–¢–û–ì

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. XML Workers –∑–∞–≥—Ä—É–∂–∞—é—Ç –±–æ–∏ –≤ `/srv/btl/raw/{shard}/{battle_id}.tzb`
2. api_mother –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç—É –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. API_4 –ø–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç **–ü–†–ê–í–ò–õ–¨–ù–´–ô** storage_key –≤ –ë–î
4. api_mother —Å–∂–∏–º–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ `.gz` –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –≤ `/srv/btl/gz`
5. –°–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ `/srv/btl/raw` (–µ—Å–ª–∏ `delete_after_parse=true`)

### üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `HOST_API_SERVICE_HEAVY_WEIGHT_API.yml` - —Ç–æ–º API_4 –∏–∑–º–µ–Ω—ë–Ω —Å `:ro` –Ω–∞ `:rw`
2. `api_4/app/interfaces/http/routes.py` - `/battles/upload` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. `STORAGE_KEY_FIX.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production!

**storage_key —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π:** `/srv/btl/raw/{shard}/{battle_id}.tzb`  
**–§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ:** `/srv/btl/raw` (raw) –∏ `/srv/btl/gz` (compressed)  
**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%**





