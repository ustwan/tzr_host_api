# üìä API 5 - –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 2025-10-11 13:40  
**–ü—Ä–æ–±–ª–µ–º–∞:** Docker –∫—ç—à–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢

### 1. API 5 –∑–∞–ø—É—â–µ–Ω
```bash
curl http://localhost:8085/healthz
{"status":"ok","service":"API 5 - Shop Parser"}
```

### 2. –ë–î —Å–æ–∑–¥–∞–Ω–∞ (PostgreSQL 15)
```
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
‚úÖ 7 —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω—ã (shops, items, snapshots...)
‚úÖ –ë–î –ø—É—Å—Ç–∞—è (–∂–¥—ë—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞)
```

### 3. Swagger UI –æ–±–Ω–æ–≤–ª—ë–Ω
```bash
open http://localhost:9107
```
- ‚úÖ API 5 –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫
- ‚úÖ 15 endpoints –≤–∏–¥–Ω—ã
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### 4. Endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
```bash
# ‚úÖ –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
curl "http://localhost:8085/categories/list"
{"categories":[...], "total":27}

# ‚úÖ –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–ë–î –ø—É—Å—Ç–∞—è)
curl "http://localhost:8085/items/list"
{"items":[], "total":0}
```

### 5. –ö–ª—é—á–∏ –±–æ—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω—ã
```
LOGIN_KEY=90659820BCEDB06F1E07F77BFB2C5948AA6D5774
```

–í—Å–µ –±–æ—Ç—ã Sova –∏—Å–ø–æ–ª—å–∑—É—é—Ç –û–î–ò–ù –∫–ª—é—á (–∏–∑ XML Workers).

---

## ‚ö†Ô∏è –ß–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢

### Snapshot Trigger (Internal Server Error)

**–ü—Ä–æ–±–ª–µ–º–∞:** Docker –∫—ç—à–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.

**–°—Ç–∞—Ç—É—Å:**
- ‚úÖ –ö–æ–¥ –Ω–∞ –¥–∏—Å–∫–µ –æ–±–Ω–æ–≤–ª—ë–Ω  
- ‚úÖ –û–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω (3 —Ä–∞–∑–∞)
- ‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑

**–†–µ—à–µ–Ω–∏–µ:**
–ù—É–∂–Ω–æ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ `api5-down` + `api5-up-db`.

---

## üîß –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
bash tools/ctl.sh api5-down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
cd api_5
docker build --no-cache -t host-api-service-api_5 .
cd ..

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
bash tools/ctl.sh api5-up-db

# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å trigger
sleep 10
curl -X POST "http://localhost:8085/admin/snapshot/trigger?shop_code=moscow"
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ Python

```bash
# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec -it host-api-service-api_5-1 bash

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞–ø—Ä—è–º—É—é
python -c "
from app.config import config
from app.infrastructure.game_socket_client import GameSocketClient
from app.infrastructure.db.database import get_db_session
from app.usecases.create_snapshot import CreateSnapshotUseCase
# ... (—Å–æ–∑–¥–∞—Ç—å shop, –∑–∞–ø—É—Å—Ç–∏—Ç—å use case)
"
```

---

## üìã –ß–¢–û –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### –ö–æ–¥ –Ω–∞ –¥–∏—Å–∫–µ (‚úÖ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π):

1. **routes.py (—Å—Ç—Ä–æ–∫–∞ 577-599):**
```python
try:
    # –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞
    success, session_id = game_client.authenticate(
        bot_config.login, 
        bot_config.login_key
    )
    
    if not success:
        raise HTTPException(
            status_code=503,
            detail=f"Failed to authenticate bot {bot_config.login}"
        )
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞
    snapshot = use_case.execute(
        shop_id=shop.id, 
        worker_name="manual_trigger"
    )
    
    # –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
    game_client.disconnect()
    
    return {
        "status": "success",
        "shop_code": shop_code,
        "snapshot_id": snapshot.id,
        "items_count": snapshot.items_count,
        "created_at": snapshot.created_at.isoformat()
    }
except Exception as e:
    raise HTTPException(
        status_code=500,
        detail=f"Failed to create snapshot: {str(e)}"
    )
```

2. **compose —Ñ–∞–π–ª:**
```yaml
- SOVA_MOSCOW_KEY=${SOVA_MOSCOW_KEY:-90659820BCEDB06F1E07F77BFB2C5948AA6D5774}
- SOVA_OASIS_KEY=${SOVA_OASIS_KEY:-90659820BCEDB06F1E07F77BFB2C5948AA6D5774}
- SOVA_NEVA_KEY=${SOVA_NEVA_KEY:-90659820BCEDB06F1E07F77BFB2C5948AA6D5774}
```

3. **config.py (—Å—Ç—Ä–æ–∫–∞ 139-154):**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –±–æ—Ç–æ–≤ (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –æ—à–∏–±–∫–∞)
enabled_bots = 0
for shop_code, bot_config in bots.items():
    if bot_config.enabled:
        if not bot_config.login_key:
            print(f"‚ö†Ô∏è  WARNING: Bot {shop_code} enabled but LOGIN_KEY not set")
        else:
            enabled_bots += 1
            print(f"‚úì Bot {shop_code} enabled with key")
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì

–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ –±–µ–∑ –∫—ç—à–∞ –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
bash tools/ctl.sh api5-down

# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
docker system prune -f

# –°–æ–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ
docker compose -f HOST_API_SERVICE_SHOP_API.yml build --no-cache api_5

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
bash tools/ctl.sh api5-up-db

# –¢–µ—Å—Ç
sleep 10
curl -X POST "http://localhost:8085/admin/snapshot/trigger?shop_code=moscow"
```

---

**–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ `trigger_snapshot` –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!** ‚úÖ







