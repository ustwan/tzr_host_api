# üöÄ API 5 - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

**–í–ê–ñ–ù–û:** Shop Workers –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–¢–ï –ñ–ï** –∫–ª—é—á–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á—Ç–æ –∏ XML Workers!

---

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (3 –∫–æ–º–∞–Ω–¥—ã)

### 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –∏–∑ XML Workers

```bash
# –í —Ñ–∞–π–ª–µ .env –ø—Ä–æ–µ–∫—Ç–∞ —É–∂–µ –µ—Å—Ç—å SOVA_*_KEY
# –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è XML Workers
# –ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ù–ï –ù–£–ñ–ù–û!
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å API 5

```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client

# –ó–∞–ø—É—Å–∫ —Å –ë–î
bash tools/ctl.sh api5-up-db

# –ü—Ä–æ–≤–µ—Ä–∫–∞
curl http://localhost:8085/healthz
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã

```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ API 5
docker exec -it host-api-service-api_5-1 \
    python shop_workers/run_workers.py

# –ò–ª–∏ –≤ —Ñ–æ–Ω–µ
docker exec -d host-api-service-api_5-1 \
    python shop_workers/run_workers.py
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. Health check

```bash
curl http://localhost:8085/healthz
# ‚Üí {"status": "ok", "service": "API 5 - Shop Parser"}

curl http://localhost:8085/shop/health
# ‚Üí {"status": "ok", "service": "Shop Parser Module"}

curl http://localhost:8085/db/health
# ‚Üí {"status": "ok", "database": "connected"}
```

### 2. –°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤

```bash
curl http://localhost:8085/admin/bots/status
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```json
{
  "bots": [
    {
      "shop_code": "moscow",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:30:00"
    },
    {
      "shop_code": "oasis",
      "bot_login": "Sova",
      "authenticated": true,
      ...
    },
    {
      "shop_code": "neva",
      "bot_login": "Sova",
      "authenticated": true,
      ...
    }
  ]
}
```

### 3. Swagger UI

```bash
open http://localhost:8085/docs
```

---

## üìä –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–Ω–∏–º–∫–∞ (—á–µ—Ä–µ–∑ 1 —á–∞—Å)

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–≤–∞—Ä—ã

```bash
# –¢–æ–≤–∞—Ä—ã Moscow
curl "http://localhost:8085/items/list?shop_code=moscow&limit=10"

# –¢–æ–≤–∞—Ä—ã Oasis
curl "http://localhost:8085/items/list?shop_code=oasis&limit=10"

# –¢–æ–≤–∞—Ä—ã Neva
curl "http://localhost:8085/items/list?shop_code=neva&limit=10"
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–∏–º–∫–∏

```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫ Moscow
curl "http://localhost:8085/snapshots/latest?shop_code=moscow"

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–Ω–∏–º–∫–æ–≤
curl "http://localhost:8085/snapshots/list"
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞

```bash
# –ù–∞–π—Ç–∏ ID —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞, –∑–∞—Ç–µ–º:
curl "http://localhost:8085/items/79469641"
```

---

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –õ–æ–≥–∏

```bash
# –õ–æ–≥–∏ API
bash tools/ctl.sh api5-logs

# –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã –≤ —Ñ–æ–Ω–µ)
docker exec host-api-service-api_5-1 \
    tail -f /tmp/shop_workers.log
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API
bash tools/ctl.sh api5-restart

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã (—É–±–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞)
docker exec host-api-service-api_5-1 \
    pkill -f shop_workers

docker exec -d host-api-service-api_5-1 \
    python shop_workers/run_workers.py
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API 5
bash tools/ctl.sh api5-down

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker stop host-api-service-api_5-1
```

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ctl.sh

```bash
bash tools/ctl.sh api5-up         # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ API
bash tools/ctl.sh api5-up-db      # –ó–∞–ø—É—Å—Ç–∏—Ç—å API + –ë–î
bash tools/ctl.sh api5-down       # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
bash tools/ctl.sh api5-logs       # –õ–æ–≥–∏ API
bash tools/ctl.sh api5-restart    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API
bash tools/ctl.sh api5-migrate    # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
bash tools/ctl.sh api5-status     # –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

### –ü—Ä—è–º—ã–µ Docker –∫–æ–º–∞–Ω–¥—ã

```bash
# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker ps | grep api_5

# –õ–æ–≥–∏ –ë–î
docker logs -f host-api-service-api_5_db-1

# –õ–æ–≥–∏ API
docker logs -f host-api-service-api_5-1

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec -it host-api-service-api_5-1 bash
```

---

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!)

–í `.env` –ø—Ä–æ–µ–∫—Ç–∞ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:

```bash
SOVA_MOSCOW_LOGIN=Sova
SOVA_MOSCOW_KEY=<–∫–ª—é—á>

SOVA_OASIS_LOGIN=Sova
SOVA_OASIS_KEY=<–∫–ª—é—á>

SOVA_NEVA_LOGIN=Sova
SOVA_NEVA_KEY=<–∫–ª—é—á>
```

–≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ XML Workers —Ç–∞–∫ –∏ Shop Workers!

---

## ‚ö° –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π –≤–æ—Ä–∫–µ—Ä

### Moscow Worker

1. –õ–æ–≥–∏–Ω–∏—Ç—Å—è –∫–∞–∫ `Sova` –≤ –∏–≥—Ä—É (185.92.72.18:5190)
2. –ó–∞—Ö–æ–¥–∏—Ç –≤ –º–∞–≥–∞–∑–∏–Ω Moscow
3. –ü–∞—Ä—Å–∏—Ç –≤—Å–µ 27 –∫–∞—Ç–µ–≥–æ—Ä–∏–π:
   - k (—Ö–æ–ª–æ–¥–Ω–æ–µ)
   - p (–ø–∏—Å—Ç–æ–ª–µ—Ç—ã)
   - v (–≤–∏–Ω—Ç–æ–≤–∫–∏)
   - ... (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)
4. –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ 0, 1, 2... –¥–æ –ø–æ–≤—Ç–æ—Ä–∞
   - –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—ã (count="N")
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–≤–∞—Ä—ã –≤ –ë–î
6. –°–æ–∑–¥–∞—ë—Ç —Å–Ω–∏–º–æ–∫ –∫–∞–∂–¥—ã–π —á–∞—Å
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç keep-alive –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

### Oasis Worker, Neva Worker

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –¥–ª—è —Å–≤–æ–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤.

---

## üêõ Troubleshooting

### –í–æ—Ä–∫–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
docker exec host-api-service-api_5-1 env | grep SOVA

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
docker exec host-api-service-api_5-1 \
    nc -zv 185.92.72.18 5190
```

### –ë–î –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
bash tools/ctl.sh api5-status

# –õ–æ–≥–∏ –ë–î
docker logs host-api-service-api_5_db-1

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î
bash tools/ctl.sh api5-down
docker volume rm host-api-service-api_5_data
bash tools/ctl.sh api5-up-db
```

### –í–æ—Ä–∫–µ—Ä—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç —Å–Ω–∏–º–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
docker exec host-api-service-api_5-1 \
    ps aux | grep shop_workers

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã - –∑–∞–ø—É—Å—Ç–∏—Ç—å
docker exec -d host-api-service-api_5-1 \
    python shop_workers/run_workers.py
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

API 5 –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–≤–æ–≥–æ —Å–Ω–∏–º–∫–∞ (1 —á–∞—Å).







