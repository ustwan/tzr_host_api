# üì° API 5 - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö endpoints

**–í—Å–µ 10 API endpoints —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏**

---

## üéØ –ß–¢–û –î–ï–õ–ê–ï–¢ –ö–ê–ñ–î–ê–Ø –†–£–ß–ö–ê

---

## 1Ô∏è‚É£ GET /healthz
### üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl http://localhost:8085/healthz
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "service": "API 5 - Shop Parser"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ Docker healthcheck (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus/Grafana)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã

---

## 2Ô∏è‚É£ GET /shop/health
### üè™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª—è –º–∞–≥–∞–∑–∏–Ω–∞

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl http://localhost:8085/shop/health
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "service": "Shop Parser Module"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞

---

## 3Ô∏è‚É£ GET /db/health
### üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl http://localhost:8085/db/health
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "status": "ok",
  "database": "connected"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "detail": "Database error: connection refused"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ PostgreSQL
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –ë–î
- ‚úÖ Before critical operations

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- PostgreSQL –¥–æ—Å—Ç—É–ø–Ω–∞
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã

---

## 4Ô∏è‚É£ GET /items/list
### üì¶ –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π

**–ó–∞–ø—Ä–æ—Å 1: –í—Å–µ —Ç–æ–≤–∞—Ä—ã (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)**
```bash
curl "http://localhost:8085/items/list?page=1&limit=10"
```

**–ó–∞–ø—Ä–æ—Å 2: –¢–æ–ª—å–∫–æ Moscow**
```bash
curl "http://localhost:8085/items/list?shop_code=moscow&page=1&limit=5"
```

**–ó–∞–ø—Ä–æ—Å 3: –¢–æ–ª—å–∫–æ Oasis, –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤**
```bash
curl "http://localhost:8085/items/list?shop_code=oasis&limit=50"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "items": [
    {
      "id": 79469641,
      "txt": "Butterfly knife",
      "price": 4.0,
      "current_quality": 125,
      "max_quality": 125,
      "shop_id": 1,
      "template_id": 42,
      "owner": null
    },
    {
      "id": 79470735,
      "txt": "Beretta 92/93",
      "price": 22.0,
      "current_quality": 95,
      "max_quality": 95,
      "shop_id": 1,
      "template_id": 43,
      "owner": "PlayerX"
    },
    {
      "id": 79510254,
      "txt": "Stalker helm",
      "price": 146.0,
      "current_quality": 450,
      "max_quality": 450,
      "shop_id": 1,
      "template_id": 88,
      "owner": null
    }
  ],
  "total": 3,
  "page": 1,
  "limit": 10
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `shop_code` (optional) ‚Äî moscow/oasis/neva
- `page` (default=1) ‚Äî –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `limit` (default=100, max=1000) ‚Äî —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ –º–∞–≥–∞–∑–∏–Ω–∞
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –æ—Ç–≤–µ—Ç–µ)
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –ú–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤ —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (total, page, limit)

---

## 5Ô∏è‚É£ GET /items/{id}
### üÜî –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl http://localhost:8085/items/79469641
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": 79469641,
  "txt": "Butterfly knife",
  "price": 4.0,
  "current_quality": 125,
  "max_quality": 125,
  "shop_id": 1,
  "template_id": 42,
  "owner": null
}
```

**–û—Ç–≤–µ—Ç (–Ω–µ –Ω–∞–π–¥–µ–Ω):**
```json
{
  "detail": "Item 79469641 not found"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞ –ø–æ ID
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –ë–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
- –û—à–∏–±–∫—É 404 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω

---

## 6Ô∏è‚É£ GET /snapshots/list
### üì∏ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–Ω–∏–º–∫–æ–≤

**–ó–∞–ø—Ä–æ—Å 1: –í—Å–µ —Å–Ω–∏–º–∫–∏**
```bash
curl "http://localhost:8085/snapshots/list"
```

**–ó–∞–ø—Ä–æ—Å 2: –¢–æ–ª—å–∫–æ Moscow**
```bash
curl "http://localhost:8085/snapshots/list?shop_code=moscow"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "snapshots": [
    {
      "id": 5,
      "shop_id": 1,
      "created_at": "2025-10-11T15:30:00",
      "items_count": 1847,
      "worker_name": "moscow_worker"
    },
    {
      "id": 4,
      "shop_id": 1,
      "created_at": "2025-10-11T14:30:00",
      "items_count": 1835,
      "worker_name": "moscow_worker"
    },
    {
      "id": 3,
      "shop_id": 2,
      "created_at": "2025-10-11T15:30:15",
      "items_count": 1652,
      "worker_name": "oasis_worker"
    }
  ],
  "total": 3
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–Ω–∏–º–∫–æ–≤
- ‚úÖ –í—ã–±–æ—Ä —Å–Ω–∏–º–∫–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤–æ—Ä–∫–µ—Ä–æ–≤

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–Ω–∏–º–∫–æ–≤ (–∏–ª–∏ –ø–æ –º–∞–≥–∞–∑–∏–Ω—É)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞–∂–¥–æ–º
- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
- –ò–º—è –≤–æ—Ä–∫–µ—Ä–∞

---

## 7Ô∏è‚É£ GET /snapshots/latest
### üì∏ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫ –º–∞–≥–∞–∑–∏–Ω–∞

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl "http://localhost:8085/snapshots/latest?shop_code=moscow"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": 5,
  "shop_id": 1,
  "created_at": "2025-10-11T15:30:00",
  "items_count": 1847,
  "worker_name": "moscow_worker"
}
```

**–û—Ç–≤–µ—Ç (–Ω–µ—Ç —Å–Ω–∏–º–∫–æ–≤):**
```json
{
  "detail": "No snapshots for moscow"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã –≤–æ—Ä–∫–µ—Ä–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–æ—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –ö–æ–≥–¥–∞ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫
- –°–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–µ–π—á–∞—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ
- –ö–∞–∫–æ–π –≤–æ—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–ª —Å–Ω–∏–º–æ–∫

---

## 8Ô∏è‚É£ POST /admin/snapshot/trigger
### üëë –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–∏–º–æ–∫ –≤—Ä—É—á–Ω—É—é

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST "http://localhost:8085/admin/snapshot/trigger?shop_code=moscow"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "triggered",
  "shop_code": "moscow"
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–µ –∂–¥–∞—Ç—å —á–∞—Å)
- ‚úÖ –ü–æ—Å–ª–µ –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –í–æ—Ä–∫–µ—Ä –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –∏–≥—Ä–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
2. –ü–∞—Ä—Å–∏—Ç –≤—Å–µ 27 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–∞–≥–∞–∑–∏–Ω–∞
3. –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
5. –°–æ–∑–¥–∞—ë—Ç —Å–Ω–∏–º–æ–∫
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 10-15 –º–∏–Ω—É—Ç (–ø–∞—Ä—Å–∏–Ω–≥ ~1500 —Ç–æ–≤–∞—Ä–æ–≤)

---

## 9Ô∏è‚É£ GET /admin/bots/status
### ü§ñ –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –±–æ—Ç–æ–≤-–ø–∞—Ä—Å–µ—Ä–æ–≤

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl http://localhost:8085/admin/bots/status
```

**–û—Ç–≤–µ—Ç (–≤—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç):**
```json
{
  "bots": [
    {
      "shop_code": "moscow",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:45:30"
    },
    {
      "shop_code": "oasis",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:45:28"
    },
    {
      "shop_code": "neva",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:45:32"
    }
  ]
}
```

**–û—Ç–≤–µ—Ç (–ø—Ä–æ–±–ª–µ–º–∞ —Å Neva):**
```json
{
  "bots": [
    {
      "shop_code": "moscow",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:45:30"
    },
    {
      "shop_code": "oasis",
      "bot_login": "Sova",
      "authenticated": true,
      "session_id": "Sova...",
      "last_activity": "2025-10-11T15:45:28"
    },
    {
      "shop_code": "neva",
      "bot_login": "Sova",
      "authenticated": false,  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
      "session_id": null,
      "last_activity": null
    }
  ]
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–æ–≤** (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ keep-alive –ø–∏–Ω–≥–æ–≤
- ‚úÖ –ê–ª–µ—Ä—Ç—ã (–µ—Å–ª–∏ –±–æ—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (keep-alive)
- ID —Å–µ—Å—Å–∏–∏
- –ö–∞–∫–æ–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–∞–∫–æ–π –Ω–µ—Ç

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ `last_activity` —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç ‚Üí –±–æ—Ç –∑–∞–≤–∏—Å!

---

## üîü GET /docs
### üìö Swagger UI (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

**–û—Ç–∫—Ä—ã—Ç—å:**
```bash
open http://localhost:8085/docs
```

**–ß—Ç–æ –º–æ–∂–Ω–æ:**
- ‚úÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ endpoints
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- ‚úÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (Pydantic models)
- ‚úÖ –°–∫–∞—á–∞—Ç—å OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é

**–°–∫—Ä–∏–Ω—à–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API 5 - Shop Parser         v1.0.0          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                             ‚îÇ
‚îÇ Health & Service                            ‚îÇ
‚îÇ ‚îú‚îÄ GET  /healthz                            ‚îÇ
‚îÇ ‚îú‚îÄ GET  /shop/health                        ‚îÇ
‚îÇ ‚îî‚îÄ GET  /db/health                          ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Items                                       ‚îÇ
‚îÇ ‚îú‚îÄ GET  /items/list                         ‚îÇ
‚îÇ ‚îî‚îÄ GET  /items/{id}                         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Snapshots                                   ‚îÇ
‚îÇ ‚îú‚îÄ GET  /snapshots/list                     ‚îÇ
‚îÇ ‚îî‚îÄ GET  /snapshots/latest                   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Admin                                       ‚îÇ
‚îÇ ‚îú‚îÄ POST /admin/snapshot/trigger             ‚îÇ
‚îÇ ‚îî‚îÄ GET  /admin/bots/status                  ‚îÇ
‚îÇ                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üé¨ –†–ï–ê–õ–¨–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:8085/healthz
# ‚Üí {"status": "ok"}

curl http://localhost:8085/db/health
# ‚Üí {"status": "ok", "database": "connected"}

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤
curl http://localhost:8085/admin/bots/status
# ‚Üí –í—Å–µ 3 –±–æ—Ç–∞: authenticated=false (–µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã)

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã
python shop_workers/run_workers.py &

# 4. –ß–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–Ω–æ–≤–∞
curl http://localhost:8085/admin/bots/status
# ‚Üí –í—Å–µ 3 –±–æ—Ç–∞: authenticated=true ‚úÖ

# 5. –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–∏–º–∫–∏
curl "http://localhost:8085/snapshots/latest?shop_code=moscow"
# ‚Üí {"id": 1, "items_count": 1847, "created_at": "..."}

# 6. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã
curl "http://localhost:8085/items/list?shop_code=moscow&limit=10"
# ‚Üí 10 —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ Moscow
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã –≤–æ—Ä–∫–µ—Ä–æ–≤

```bash
# –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
while true; do
    clear
    echo "ü§ñ –°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤ ($(date))"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    curl -s http://localhost:8085/admin/bots/status | \
        jq -r '.bots[] | "\(.shop_code): \(if .authenticated then "‚úÖ" else "‚ùå" end) \(.last_activity // "N/A")"'
    
    echo ""
    echo "üì∏ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–∏–º–∫–∏:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    for shop in moscow oasis neva; do
        curl -s "http://localhost:8085/snapshots/latest?shop_code=$shop" | \
            jq -r "\"$shop: \(.items_count // 0) —Ç–æ–≤–∞—Ä–æ–≤ (\(.created_at // \"N/A\"))\""
    done
    
    sleep 30
done
```

**–í—ã–≤–æ–¥:**
```
ü§ñ –°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤ (2025-10-11 15:45:30)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
moscow: ‚úÖ 2025-10-11T15:45:28
oasis: ‚úÖ 2025-10-11T15:45:30
neva: ‚úÖ 2025-10-11T15:45:26

üì∏ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–∏–º–∫–∏:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
moscow: 1847 —Ç–æ–≤–∞—Ä–æ–≤ (2025-10-11T15:30:00)
oasis: 1652 —Ç–æ–≤–∞—Ä–æ–≤ (2025-10-11T15:30:15)
neva: 1923 —Ç–æ–≤–∞—Ä–æ–≤ (2025-10-11T15:30:30)
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ Moscow

```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã Moscow
curl -s "http://localhost:8085/items/list?shop_code=moscow&limit=1000" > moscow_items.json

# 2. –ù–∞–π—Ç–∏ —Å–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ
cat moscow_items.json | \
    jq '.items | sort_by(.price) | reverse | .[0:10] | .[] | {txt, price}'

# –í—ã–≤–æ–¥:
# {"txt": "Power armor", "price": 5000.0}
# {"txt": "Plasma rifle", "price": 2500.0}
# {"txt": "Heavy armor vest", "price": 220.0}
# ...

# 3. –ù–∞–π—Ç–∏ –Ω–æ–∂–∏
cat moscow_items.json | \
    jq '.items[] | select(.txt | contains("knife"))'

# 4. –ù–∞–π—Ç–∏ infinty —Ç–æ–≤–∞—Ä—ã (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ)
cat moscow_items.json | \
    jq '.items[] | select(.owner == null) | {txt, price}'
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–∏–º–æ–∫ Moscow –≤—Ä—É—á–Ω—É—é
curl -X POST "http://localhost:8085/admin/snapshot/trigger?shop_code=moscow"
# ‚Üí {"status": "triggered"}

# 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞)
tail -f /tmp/api5_worker.log

# –í—ã–≤–æ–¥:
# üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'k'...
# üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'p'...
# ...
# ‚úì –°–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω (ID=6, items=1850)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π —Å–Ω–∏–º–æ–∫
curl "http://localhost:8085/snapshots/latest?shop_code=moscow"
# ‚Üí {"id": 6, "items_count": 1850}  ‚Üê –ù–æ–≤—ã–π —Å–Ω–∏–º–æ–∫!

# 4. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
# –ë—ã–ª–æ: 1847 —Ç–æ–≤–∞—Ä–æ–≤
# –°—Ç–∞–ª–æ: 1850 —Ç–æ–≤–∞—Ä–æ–≤
# –†–∞–∑–Ω–∏—Ü–∞: +3 –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–∞
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤

```bash
# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
for shop in moscow oasis neva; do
    echo -n "$shop: "
    curl -s "http://localhost:8085/snapshots/latest?shop_code=$shop" | \
        jq -r '.items_count'
done

# –í—ã–≤–æ–¥:
# moscow: 1847
# oasis: 1652
# neva: 1923

# –í—ã–≤–æ–¥: –í Neva –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤!
```

---

## üìä –¢–ê–ë–õ–ò–¶–ê –í–°–ï–• ENDPOINTS

| ‚Ññ | Endpoint | –ú–µ—Ç–æ–¥ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|---|----------|-------|------------|-----------|
| 1 | `/healthz` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ | ‚Äî |
| 2 | `/shop/health` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª—è | ‚Äî |
| 3 | `/db/health` | GET | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î | ‚Äî |
| 4 | `/items/list` | GET | **–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤** | shop_code, page, limit |
| 5 | `/items/{id}` | GET | **–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞** | id |
| 6 | `/snapshots/list` | GET | –°–ø–∏—Å–æ–∫ —Å–Ω–∏–º–∫–æ–≤ | shop_code |
| 7 | `/snapshots/latest` | GET | **–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫** | shop_code (required) |
| 8 | `/admin/snapshot/trigger` | POST | **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–∏–º–æ–∫** | shop_code (required) |
| 9 | `/admin/bots/status` | GET | **–°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤** | ‚Äî |
| 10 | `/docs` | GET | Swagger UI | ‚Äî |

**–ñ–∏—Ä–Ω—ã–º** –≤—ã–¥–µ–ª–µ–Ω—ã —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã.

---

## üî• –°–ê–ú–´–ï –ü–û–õ–ï–ó–ù–´–ï –†–£–ß–ö–ò

### –î–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. **GET /items/list** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤
2. **GET /snapshots/latest** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
3. **GET /admin/bots/status** ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–æ–≤

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **POST /admin/snapshot/trigger** ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–Ω–∏–º–æ–∫
2. **GET /db/health** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

1. **GET /docs** ‚Äî Swagger UI
2. **GET /healthz** ‚Äî healthcheck

---

## üí° –ü–†–ò–ú–ï–†–´ –†–ï–ê–õ–¨–ù–´–• –ó–ê–ü–†–û–°–û–í

### –ù–∞–π—Ç–∏ –≤—Å–µ –Ω–æ–∂–∏ –≤ Moscow:
```bash
curl -s "http://localhost:8085/items/list?shop_code=moscow&limit=1000" | \
    jq '.items[] | select(.txt | test("knife|Knife")) | {id, txt, price, quality: .current_quality}'
```

### –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã –¥–µ—à–µ–≤–ª–µ 10 cr:
```bash
curl -s "http://localhost:8085/items/list?shop_code=moscow&limit=1000" | \
    jq '.items[] | select(.price < 10) | {txt, price}'
```

### –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º (< 50%):
```bash
curl -s "http://localhost:8085/items/list?shop_code=moscow&limit=1000" | \
    jq '.items[] | select(.current_quality < .max_quality * 0.5) | {txt, quality: "\(.current_quality)/\(.max_quality)"}'
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–æ—Å—Ç–∞ —Å–Ω–∏–º–∫–æ–≤:
```bash
watch -n 60 'curl -s http://localhost:8085/snapshots/list | jq ".snapshots | length"'
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–Ω–∏–º–∫–æ–≤ —Å–æ–∑–¥–∞–Ω–æ (—Ä–∞—Å—Ç—ë—Ç –∫–∞–∂–¥—ã–π —á–∞—Å)
```

---

## ‚úÖ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!

**–í—Å–µ 10 endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!**

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:
```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client
bash tools/ctl.sh api5-up-db
```

–ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –∏–∑ endpoints –≤—ã—à–µ! üöÄ







