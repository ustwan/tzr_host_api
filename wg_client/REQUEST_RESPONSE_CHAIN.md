# 🔄 Цепочка запрос-ответ при регистрации

## ✅ ПРАВИЛЬНОЕ понимание!

### Полная цепочка (туда и обратно):

```
┌──────────┐                                        ┌──────────┐
│  Сайт    │                                        │  Сайт    │
└────┬─────┘                                        └────▲─────┘
     │                                                    │
     │ 1. POST /api/register                              │ 12. {"ok": true}
     ↓                                                    │
┌─────────────────────────────────────────────────────────┴──────┐
│ HOST_API                                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────┐                              ┌─────────────┐ │
│  │   API 2     │                              │   API 2     │ │
│  └──────┬──────┘                              └──────▲──────┘ │
│         │                                             │        │
│         │ 2. Валидация OK                             │ 11. Ответ│
│         │ 3. Proxy → api_father                       │        │
│         ↓                                             │        │
│  ┌────────────────────────────────────────────────────┴─────┐ │
│  │   API Father :9000                                       │ │
│  ├──────────────────────────────────────────────────────────┤ │
│  │                                                          │ │
│  │  4. Проверка группы (Telegram API) → OK                 │ │
│  │                                                          │ │
│  │  5. Запрос к db_bridge:                                 │ │
│  │     SELECT COUNT(*) WHERE telegram_id = ?               │ │
│  │     ↓ отправка SQL                                      │ │
└──┼──────┼──────────────────────────────────────────────────┼──┘
   │      ↓                                                  │
   │      │ VPN                                              │
   │      ↓                                                  │
┌──┼──────────────────────────────────────────────────────────┼──┐
│  │  HOST_SERVER                                             ▲  │
│  │                                                          │  │
│  │  ┌─────────────────────────────────────────────────┐    │  │
│  │  │ db_bridge :3307                                 │    │  │
│  ↓  ├─────────────────────────────────────────────────┤    │  │
│     │ 6. Принимает SQL запрос от api_father           │    │  │
│     │ 7. Проверяет mTLS сертификат                    │    │  │
│     │ 8. Проксирует в MySQL                           │    │  │
│     └──────┬──────────────────────────────────────────┘    │  │
│            ↓                                                │  │
│     ┌──────────────────────────────────────────────────┐   │  │
│     │ MySQL (unix-socket)                              │   │  │
│     ├──────────────────────────────────────────────────┤   │  │
│     │ 9. Выполняет: SELECT COUNT(*) FROM tgplayers ... │   │  │
│     │    Результат: count = 2                          │   │  │
│     └──────┬───────────────────────────────────────────┘   │  │
│            │                                                │  │
│            │ 10. Результат: 2                               │  │
│            ↓                                                │  │
│     ┌──────────────────────────────────────────────────┐   │  │
│     │ db_bridge                                        │   │  │
│     │ Возвращает результат api_father                  │   │  │
│     └──────────────────────────────────────────────────┴───┴──┤
│                                                                │
└────────────────────────────────────────────────────────────────┘
                 │
                 │ VPN (ответ обратно)
                 ↓
┌────────────────────────────────────────────────────────────────┐
│ HOST_API                                                       │
│                                                                │
│  API Father:                                                   │
│    11. Получает count = 2                                     │
│    12. Проверяет: 2 < 5? ✅ ДА, продолжаем                    │
│    13. Делает INSERT (та же цепочка)                          │
│    14. Обращается к Game Server (socket)                      │
│    15. Формирует ответ {"ok": true}                           │
│    16. Возвращает API 2                                       │
│                                                                │
│  API 2:                                                        │
│    17. Получает {"ok": true}                                  │
│    18. Возвращает на Сайт                                     │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 📝 Детально по шагам:

### 1-3: Сайт → API 2 → API Father
```
Сайт отправляет JSON → API 2
API 2 валидирует → OK
API 2 проксирует → API Father
```

### 4-10: API Father → db_bridge → MySQL → Ответ
```
API Father отправляет SQL:
  SELECT COUNT(*) FROM tgplayers WHERE telegram_id = ?
  ↓
db_bridge на HOST_SERVER получает SQL
  ↓
db_bridge проверяет mTLS сертификат ✅
  ↓
db_bridge проксирует в MySQL unix-socket
  ↓
MySQL выполняет SELECT
  ↓ Результат: 2
MySQL → db_bridge
  ↓
db_bridge → api_father (через VPN обратно)
  ↓
api_father получает: count = 2
```

### 11-18: API Father обрабатывает и отвечает
```
api_father проверяет: 2 < 5? ✅
  ↓
api_father делает INSERT (та же цепочка через db_bridge)
  ↓
api_father обращается к Game Server (socket)
  ↓
api_father формирует ответ: {"ok": true}
  ↓
API 2 получает ответ
  ↓
API 2 возвращает на Сайт
```

## 🎯 ВЫ ВСЕ ПОНЯЛИ ПРАВИЛЬНО!

**api_father:**
1. ✅ Обращается к db_bridge
2. ✅ Получает ответ ОТ db_bridge
3. ✅ Обрабатывает результат
4. ✅ Возвращает ответ в API 2
5. ✅ API 2 возвращает на сайт

**db_bridge - это ПРОКСИ:**
- Принимает SQL от api_father
- Проксирует в MySQL
- Возвращает результат обратно api_father

**Вся коммуникация через VPN туннель!**
