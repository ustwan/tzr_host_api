# üìä db_bridge - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## ‚úÖ –î–ê, db_bridge –õ–û–ì–ò–†–£–ï–¢!

### –ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ db_bridge (nginx stream)                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ –õ–æ–≥–∏—Ä—É–µ—Ç:                                                   ‚îÇ
‚îÇ ‚úÖ IP –∫–ª–∏–µ–Ω—Ç–∞ (–∫—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è)                           ‚îÇ
‚îÇ ‚úÖ Timestamp (–∫–æ–≥–¥–∞)                                        ‚îÇ
‚îÇ ‚úÖ CN –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–∫–∞–∫–æ–π API)                           ‚îÇ
‚îÇ ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ/–ø–æ–ª—É—á–µ–Ω–æ                     ‚îÇ
‚îÇ ‚úÖ –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ (latency)                                  ‚îÇ
‚îÇ ‚úÖ Upstream –∞–¥—Ä–µ—Å (MySQL)                                  ‚îÇ
‚îÇ ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)                       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ –ù–ï –ª–æ–≥–∏—Ä—É–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):                                ‚îÇ
‚îÇ ‚ùå –°–æ–¥–µ—Ä–∂–∏–º–æ–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (—ç—Ç–æ —Å–¥–µ–ª–∞–ª –±—ã MySQL)           ‚îÇ
‚îÇ ‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤                                     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

### nginx stream log format:

```nginx
# db_bridge/nginx.conf

stream {
    # –§–æ—Ä–º–∞—Ç –ª–æ–≥–∞
    log_format db_proxy '$remote_addr [$time_local] '
                        '$protocol $status $bytes_sent $bytes_received '
                        '$session_time "$upstream_addr" '
                        '$ssl_client_s_dn '  ‚Üê CN –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞!
                        '$upstream_bytes_sent $upstream_bytes_received '
                        '$upstream_connect_time';
    
    # –§–∞–π–ª—ã –ª–æ–≥–æ–≤
    access_log /var/log/nginx/db_bridge_access.log db_proxy;
    error_log  /var/log/nginx/db_bridge_error.log warn;
    
    server {
        listen 3307 ssl;
        
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;
        
        proxy_pass 127.0.0.1:3306;
    }
}
```

---

## üìã –ü–†–ò–ú–ï–† –õ–û–ì–û–í

### Access log (—É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ):

```
10.8.0.1 [01/Oct/2025:10:15:30 +0000] TCP 200 1024 2048 2.345 "127.0.0.1:3306" CN=api_register,O=HOST_API,OU=Registration 1024 2048 0.012
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- `10.8.0.1` - IP –∫–ª–∏–µ–Ω—Ç–∞ (HOST_API)
- `[01/Oct/2025:10:15:30 +0000]` - –≤—Ä–µ–º—è
- `TCP` - –ø—Ä–æ—Ç–æ–∫–æ–ª
- `200` - —Å—Ç–∞—Ç—É—Å (—É—Å–ø–µ—Ö)
- `1024` - –±–∞–π—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É
- `2048` - –±–∞–π—Ç –ø–æ–ª—É—á–µ–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- `2.345` - –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ (—Å–µ–∫—É–Ω–¥—ã)
- `"127.0.0.1:3306"` - upstream (MySQL)
- `CN=api_register,O=HOST_API,OU=Registration` - –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞!
- `1024 2048` - –±–∞–π—Ç—ã upstream
- `0.012` - –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ upstream

### Error log (–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è):

```
2025/10/01 10:20:15 [error] 123#123: *456 upstream timed out (110: Connection timed out) while connecting to upstream, client: 10.8.0.1, server: 0.0.0.0:3307, upstream: "127.0.0.1:3306", bytes from/to client:0/0, bytes from/to upstream:0/0
```

### Error log (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç):

```
2025/10/01 10:25:00 [error] 123#123: *789 SSL_do_handshake() failed (SSL: error:14094418:SSL routines:ssl3_read_bytes:tlsv1 alert unknown ca) while SSL handshaking, client: 10.8.0.1, server: 0.0.0.0:3307
```

---

## üîç –ß–¢–û –í–ò–î–ù–û –í –õ–û–ì–ê–•

### 1. –ö—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
```
–ö–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:
  IP: 10.8.0.1 (HOST_API)
  CN: api_register (API 2) –∏–ª–∏ api_status (API 1/3)
```

### 2. –ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
```
Timestamp –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å:
  ‚Ä¢ –ü–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
  ‚Ä¢ –ß–∞—Å—Ç–æ—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
  ‚Ä¢ –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

### 3. –°–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞–Ω–æ:
```
bytes_sent: —Å–∫–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL)
bytes_received: —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—É—á–µ–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (SQL –∑–∞–ø—Ä–æ—Å—ã)

–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å:
  ‚Ä¢ –†–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  ‚Ä¢ –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
  ‚Ä¢ –ê–Ω–æ–º–∞–ª–∏–∏ (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
```

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
```
session_time: –æ–±—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
upstream_connect_time: –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL

–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å:
  ‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
  ‚Ä¢ Latency
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ù–ê –û–°–ù–û–í–ï –õ–û–ì–û–í

### –ú–µ—Ç—Ä–∏–∫–∏ (–º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å –∏–∑ –ª–æ–≥–æ–≤):

```bash
# 1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ API
cat db_bridge_access.log | grep "CN=api_register" | wc -l
cat db_bridge_access.log | grep "CN=api_status" | wc -l

# 2. –°—Ä–µ–¥–Ω—è—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
awk '{print $8}' db_bridge_access.log | awk '{sum+=$1; count++} END {print sum/count}'

# 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
grep -c "error" db_bridge_error.log

# 4. –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
awk '{print $1}' db_bridge_access.log | sort | uniq -c | sort -nr

# 5. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
awk '{print $2}' db_bridge_access.log | cut -d: -f1-2 | uniq -c
```

---

## üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ß—Ç–æ –ù–ï –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

### ‚ùå –ù–ï –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è (–∏ —ç—Ç–æ —Ö–æ—Ä–æ—à–æ):

1. **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤**
   - db_bridge —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ TCP
   - –ù–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç MySQL protocol
   - –ù–µ –≤–∏–¥–∏—Ç SQL –∫–æ–º–∞–Ω–¥—ã

2. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤**
   - db_bridge –Ω–µ –ø–∞—Ä—Å–∏—Ç MySQL —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –¢–æ–ª—å–∫–æ –≤–∏–¥–∏—Ç —Ä–∞–∑–º–µ—Ä (–±–∞–π—Ç—ã)

3. **–ü–∞—Ä–æ–ª–∏** (–∏—Ö –Ω–µ—Ç!)
   - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ SSL
   - –ü–∞—Ä–æ–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è

### ‚úÖ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL:

**–í–∫–ª—é—á–∏—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ MySQL:**

```sql
-- MySQL general query log
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/log/mysql/queries.log';

-- –ò–ª–∏ slow query log
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  # —Å–µ–∫—É–Ω–¥—ã
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow_queries.log';
```

**–ü–ª—é—Å—ã:**
- –í–∏–¥–Ω–æ –≤—Å–µ SQL –∫–æ–º–∞–Ω–¥—ã
- –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–æ–π –æ–±—ä–µ–º –ª–æ–≥–æ–≤
- –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## üìà –†–ê–°–®–ò–†–ï–ù–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –í–∞—Ä–∏–∞–Ω—Ç 1: db_bridge + SQL proxy

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π:

```
api_father ‚Üí db_bridge:3307 ‚Üí mysql_proxy:33071 ‚Üí MySQL:3306
                               ‚Üë
                          –õ–æ–≥–∏—Ä—É–µ—Ç SQL
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: MySQL audit plugin

```sql
INSTALL PLUGIN audit_log SONAME 'audit_log.so';

SET GLOBAL audit_log_policy = 'ALL';
SET GLOBAL audit_log_format = 'JSON';
```

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### db_bridge –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```nginx
stream {
    log_format detailed '$remote_addr - $ssl_client_s_dn [$time_local] '
                        '$protocol $status '
                        'sent:$bytes_sent recv:$bytes_received '
                        'time:${session_time}s '
                        'upstream:"$upstream_addr" '
                        'up_time:${upstream_connect_time}s';
    
    access_log /var/log/nginx/db_bridge.log detailed;
    error_log  /var/log/nginx/db_bridge_error.log info;
    
    server {
        listen 3307 ssl;
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;
        
        proxy_pass 127.0.0.1:3306;
    }
}
```

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:

```
10.8.0.1 - CN=api_register,O=HOST_API,OU=Registration [01/Oct/2025:10:30:00 +0000] TCP 200 sent:512 recv:1024 time:0.234s upstream:"127.0.0.1:3306" up_time:0.005s
10.8.0.1 - CN=api_status,O=HOST_API,OU=Status [01/Oct/2025:10:30:05 +0000] TCP 200 sent:256 recv:128 time:0.102s upstream:"127.0.0.1:3306" up_time:0.002s
```

**–ò–∑ —ç—Ç–æ–≥–æ –ª–æ–≥–∞ –≤–∏–¥–Ω–æ:**
- –ö—Ç–æ: CN=api_register (API 2) –∏–ª–∏ CN=api_status (API 1/3)
- –û—Ç–∫—É–¥–∞: 10.8.0.1 (HOST_API)
- –ö–æ–≥–¥–∞: —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
- –°–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö: 512 –±–∞–π—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, 1024 –ø–æ–ª—É—á–µ–Ω–æ
- –ö–∞–∫ –±—ã—Å—Ç—Ä–æ: 0.234 —Å–µ–∫—É–Ω–¥—ã –æ–±—â–µ–µ –≤—Ä–µ–º—è, 0.005 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL

---

## ‚úÖ –ò–¢–û–ì–ò

### db_bridge –ª–æ–≥–∏—Ä—É–µ—Ç:

‚úÖ **–î–ê!** –ò —ç—Ç–æ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ:
- –í–∏–¥–Ω–æ –∫–∞–∫–æ–π API –æ–±—Ä–∞—â–∞–µ—Ç—Å—è (–ø–æ CN)
- –í–∏–¥–Ω–æ –∫–æ–≥–¥–∞ –∏ –∫–∞–∫ —á–∞—Å—Ç–æ
- –í–∏–¥–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (latency)
- –í–∏–¥–Ω–æ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

‚úÖ **–ë–ï–ó –ø–∞—Ä–æ–ª–µ–π:**
- db_bridge –ù–ï —Ö—Ä–∞–Ω–∏—Ç –ø–∞—Ä–æ–ª–∏
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ SSL

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ:**
- SQL –∫–æ–º–∞–Ω–¥—ã –ù–ï –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ db_bridge
- –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã
- –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å SQL –ª–æ–≥–∏ –Ω–∞ MySQL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

**–î–∞—Ç–∞:** 2025-10-01  
**–°—Ç–∞—Ç—É—Å:** db_bridge –ª–æ–≥–∏—Ä—É–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –ë–ï–ó SQL —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
