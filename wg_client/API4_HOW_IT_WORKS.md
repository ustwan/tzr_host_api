# üîç API 4 - –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìã –ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï

**API 4** - —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ª–æ–≥–æ–≤ –±–æ–µ–≤

- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ü–∞—Ä—Å–∏—Ç .tzb —Ñ–∞–π–ª—ã (XML –ª–æ–≥–∏ –±–æ–µ–≤), –∏–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- **–ë–î:** PostgreSQL api4_battles (–°–í–û–Ø –ë–î –Ω–∞ HOST_API, –ù–ï MySQL tzserver!)
- **–§–∞–π–ª—ã:** –ß–µ—Ä–µ–∑ api_mother ‚Üí btl_syncer ‚Üí btl_rsyncd (HOST_SERVER)

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê API 4

### –ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Ä–∞–±–æ—Ç—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. HOST_SERVER (/home/zero/logs/btl)                        ‚îÇ
‚îÇ    ‚Ä¢ –ò–≥—Ä–æ–≤–æ–π —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –ª–æ–≥–∏ –±–æ–µ–≤ (.tzb —Ñ–∞–π–ª—ã)         ‚îÇ
‚îÇ    ‚Ä¢ –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: index/50000 = –ø–∞–ø–∫–∞                      ‚îÇ
‚îÇ    ‚Ä¢ –§–æ—Ä–º–∞—Ç: 3674169.tzb (XML)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ rsync (read-only)
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. btl_rsyncd (HOST_SERVER :873)                            ‚îÇ
‚îÇ    ‚Ä¢ rsync daemon                                           ‚îÇ
‚îÇ    ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –≤ RO —Ä–µ–∂–∏–º–µ                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ rsync pull
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. btl_syncer (HOST_API)                                    ‚îÇ
‚îÇ    ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤: HOST_SERVER ‚Üí HOST_API           ‚îÇ
‚îÇ    ‚Ä¢ –ó–µ—Ä–∫–∞–ª–æ: ./xml/mirror (–ª–æ–∫–∞–ª) –∏–ª–∏ /srv/btl_mirror     ‚îÇ
‚îÇ    ‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. btl_compressor (HOST_API)                                ‚îÇ
‚îÇ    ‚Ä¢ –°–∂–∞—Ç–∏–µ: .tzb ‚Üí .tzb.gz                                 ‚îÇ
‚îÇ    ‚Ä¢ –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: index/50000 = –ø–∞–ø–∫–∞                      ‚îÇ
‚îÇ    ‚Ä¢ –•—Ä–∞–Ω–∏–ª–∏—â–µ: ./xml/gz (–ª–æ–∫–∞–ª) –∏–ª–∏ /srv/btl_store/gz     ‚îÇ
‚îÇ    ‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. API 4 (FastAPI :8084)                                    ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ    ‚îÇ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥                           ‚îÇ   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ    ‚îÇ POST /api/sync                                    ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ –°–∫–∞–Ω–∏—Ä—É–µ—Ç ./xml/mirror –∏–ª–∏ ./xml/gz          ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ –ü–∞—Ä—Å–∏—Ç .tzb —Ñ–∞–π–ª—ã (XML)                      ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:                        ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ      ‚Ä¢ battle_id, date, winner                     ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ      ‚Ä¢ participants (–∏–≥—Ä–æ–∫–∏, –∫–ª–∞–Ω—ã)                ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ      ‚Ä¢ monsters (–≤–∏–¥—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)                 ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ      ‚Ä¢ resources (–¥–æ–±—ã—á–∞)                          ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL                       ‚îÇ   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ    ‚îÇ PostgreSQL api4_battles (–°–í–û–Ø –ë–î!)                ‚îÇ   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ    ‚îÇ –¢–∞–±–ª–∏—Ü—ã:                                          ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ battles - –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–æ–µ–≤                  ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ players - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–≥—Ä–æ–∫–æ–≤                    ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ clans - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–ª–∞–Ω–æ–≤                       ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ monsters - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–æ–Ω—Å—Ç—Ä–æ–≤                  ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ resources - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ—Å—É—Ä—Å–æ–≤                 ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ battle_participants - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±–æ–µ–≤            ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ battle_monsters - –º–æ–Ω—Å—Ç—Ä—ã –≤ –±–æ—è—Ö                ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ battle_resources - —Ä–µ—Å—É—Ä—Å—ã –∏–∑ –±–æ–µ–≤              ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ                                                   ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ –í–∏—Ç—Ä–∏–Ω—ã (data marts):                             ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ daily_player_features - —Ñ–∏—á–∏ –∏–≥—Ä–æ–∫–æ–≤            ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ daily_clan_features - –∞–≥—Ä–µ–≥–∞—Ç –ø–æ –∫–ª–∞–Ω–∞–º         ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ resource_anomalies - –∞–Ω–æ–º–∞–ª–∏–∏ –≤ —ç–∫–æ–Ω–æ–º–∏–∫–µ       ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ ‚Ä¢ bot_suspicion - —Å–∫–æ—Ä–∏–Ω–≥ –∞–Ω—Ç–∏–±–æ—Ç–∞                ‚îÇ   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ    ‚îÇ API Endpoints (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)                         ‚îÇ   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ    ‚îÇ GET /api/battle/{id} - –¥–µ—Ç–∞–ª–∏ –±–æ—è                 ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/battle/list - —Å–ø–∏—Å–æ–∫ –±–æ–µ–≤                ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/battle/search - –ø–æ–∏—Å–∫ –±–æ–µ–≤               ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ                                                   ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/player/{login} - –∏–≥—Ä–æ–∫         ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/clan/{name} - –∫–ª–∞–Ω             ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/resource/{name} - —Ä–µ—Å—É—Ä—Å       ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/monster/{kind} - –º–æ–Ω—Å—Ç—Ä        ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/anomalies - –∞–Ω–æ–º–∞–ª–∏–∏           ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ GET /api/analytics/stats - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞       ‚îÇ   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–û–õ–ù–´–ô –ü–û–¢–û–ö –î–ê–ù–ù–´–•

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–∞:
```
Game Server (HOST_SERVER) ‚Üí —Å–æ–∑–¥–∞–µ—Ç 3674169.tzb
    ‚Üì —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ /home/zero/logs/btl/73/ (73 = 3674169/50000)
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
```
btl_syncer (HOST_API) ‚Üí rsync pull ‚Üí btl_rsyncd (HOST_SERVER)
    ‚Üì –∫–æ–ø–∏—Ä—É–µ—Ç –≤ ./xml/mirror/3674169.tzb
```

### 3. –°–∂–∞—Ç–∏–µ:
```
btl_compressor (HOST_API) ‚Üí gzip
    ‚Üì —Å–æ–∑–¥–∞–µ—Ç ./xml/gz/73/3674169.tzb.gz
```

### 4. –ü–∞—Ä—Å–∏–Ω–≥ –∏ –∑–∞–≥—Ä—É–∑–∫–∞:
```
API 4: POST /api/sync
    ‚Üì —Å–∫–∞–Ω–∏—Ä—É–µ—Ç ./xml/gz/
    ‚Üì –ø–∞—Ä—Å–∏—Ç 3674169.tzb.gz (XML)
    ‚Üì –∏–∑–≤–ª–µ–∫–∞–µ—Ç:
      ‚Ä¢ battle_id: 3674169
      ‚Ä¢ date: 2025-10-01
      ‚Ä¢ winner: –ò–≥—Ä–æ–∫123
      ‚Ä¢ participants: [–ò–≥—Ä–æ–∫123, –ò–≥—Ä–æ–∫456]
      ‚Ä¢ monsters: [Goblin x10, Orc x5]
      ‚Ä¢ resources: [Gold: 100, Wood: 50]
    ‚Üì —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL api4_battles
```

### 5. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
```
API 4: GET /api/analytics/player/–ò–≥—Ä–æ–∫123
    ‚Üì SELECT FROM daily_player_features
    ‚Üì –∞–≥—Ä–µ–≥–∞—Ü–∏—è: battles_count, wins, SR, KPT
    ‚Üì –≤–æ–∑–≤—Ä–∞—Ç JSON
```

---

## üìä –í–°–ï ENDPOINT API 4

### Health (1 —à—Ç):
1. `GET /healthz` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è

### –ë–æ–µ–≤—ã–µ –ª–æ–≥–∏ (3 —à—Ç):
2. `GET /api/battle/{battle_id}` - –¥–µ—Ç–∞–ª–∏ –±–æ—è
3. `GET /api/battle/list` - —Å–ø–∏—Å–æ–∫ –±–æ–µ–≤ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
4. `GET /api/battle/search` - –ø–æ–∏—Å–∫ –±–æ–µ–≤ (–∏–≥—Ä–æ–∫, –∫–ª–∞–Ω, –¥–∞—Ç–∞, —Ç–∏–ø)

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (2 —à—Ç):
5. `POST /api/sync` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
6. `POST /api/sync/reprocess` - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (7 —à—Ç):
7. `GET /api/analytics/player/{login}` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
8. `GET /api/analytics/players/top` - —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤
9. `GET /api/analytics/clan/{name}` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∞–Ω–∞
10. `GET /api/analytics/resource/{name}` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–∞
11. `GET /api/analytics/monster/{kind}` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–æ–Ω—Å—Ç—Ä–∞
12. `GET /api/analytics/anomalies` - –∞–Ω–æ–º–∞–ª–∏–∏ –≤ —Ä–µ—Å—É—Ä—Å–∞—Ö
13. `GET /api/analytics/stats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —à—Ç):
14. `GET /api/admin/loading-stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
15. `POST /api/admin/cleanup` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)

**–ò–¢–û–ì–û: 15 endpoint**

---

## üîç –ö–ê–ö API 4 –ü–û–õ–£–ß–ê–ï–¢ –§–ê–ô–õ–´

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ btl_syncer (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

```
btl_syncer (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫)
    ‚Üì rsync pull
    ‚Üì ./xml/mirror/

btl_compressor (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
    ‚Üì gzip
    ‚Üì ./xml/gz/

API 4: POST /api/sync
    ‚Üì —Å–∫–∞–Ω–∏—Ä—É–µ—Ç ./xml/gz/
    ‚Üì –ø–∞—Ä—Å–∏—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ë–î
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ api_mother (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é)

```
API 4 ‚Üí api_mother
    ‚Üì GET /gz/{path}
    ‚Üì –ø–æ–ª—É—á–∞–µ—Ç —Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª
    ‚Üì –ø–∞—Ä—Å–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ
    ‚Üì –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ë–î
```

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç 1 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

---

## üóÑÔ∏è –ë–ê–ó–´ –î–ê–ù–ù–´–• API 4

### PostgreSQL api4_battles (–°–í–û–Ø –ë–î –Ω–∞ HOST_API):

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `battles` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–æ–µ–≤
- `battle_participants` - —É—á–∞—Å—Ç–Ω–∏–∫–∏
- `battle_monsters` - –º–æ–Ω—Å—Ç—Ä—ã
- `battle_resources` - —Ä–µ—Å—É—Ä—Å—ã

**–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏:**
- `players` - –≤—Å–µ –∏–≥—Ä–æ–∫–∏
- `clans` - –≤—Å–µ –∫–ª–∞–Ω—ã
- `monsters` - –≤–∏–¥—ã –º–æ–Ω—Å—Ç—Ä–æ–≤
- `resources` - —Ç–∏–ø—ã —Ä–µ—Å—É—Ä—Å–æ–≤

**–í–∏—Ç—Ä–∏–Ω—ã (data marts):**
- `daily_player_features` - –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –∏–≥—Ä–æ–∫–∞–º
- `daily_clan_features` - –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –∫–ª–∞–Ω–∞–º
- `resource_anomalies` - –∞–Ω–æ–º–∞–ª–∏–∏ –≤ —ç–∫–æ–Ω–æ–º–∏–∫–µ
- `bot_suspicion` - –∞–Ω—Ç–∏–±–æ—Ç —Å–∫–æ—Ä–∏–Ω–≥

### –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- ‚ùå MySQL tzserver (—ç—Ç–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–∫–æ–Ω—Å—Ç–∞–Ω—Ç)
- ‚ùå db_bridge (–Ω–µ –Ω—É–∂–µ–Ω, —Å–≤–æ—è –ë–î)

---

## üîó –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –î–†–£–ì–ò–ú–ò –°–ï–†–í–ò–°–ê–ú–ò

### API 4 –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫:

1. **api_mother** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - `GET /sync` - –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
   - `GET /gz/{path}` - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª

2. **PostgreSQL api4_battles**:
   - –°–≤–æ—è –ë–î –Ω–∞ HOST_API
   - –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (localhost:5432)

3. **–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞**:
   - –ß—Ç–µ–Ω–∏–µ –∏–∑ ./xml/mirror –∏–ª–∏ ./xml/gz
   - –ü–∞—Ä—Å–∏–Ω–≥ .tzb —Ñ–∞–π–ª–æ–≤

### API 4 –ù–ï –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫:
- ‚ùå api_father (–Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- ‚ùå db_bridge (–Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- ‚ùå MySQL tzserver (—Å–≤–æ—è –ë–î)
- ‚ùå Game Server (–Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

---

## üìà –ü–†–ò–ú–ï–† –†–ê–ë–û–¢–´ API 4

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞

```
1. –ö–ª–∏–µ–Ω—Ç ‚Üí GET /api/analytics/player/–ò–≥—Ä–æ–∫123?days=30
   ‚Üì
2. API 4 ‚Üí PostgreSQL api4_battles
   ‚Üì SELECT FROM daily_player_features
   ‚Üì WHERE login = '–ò–≥—Ä–æ–∫123' AND date >= NOW() - INTERVAL '30 days'
   ‚Üì
3. PostgreSQL ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   {
     "battles_count": 150,
     "wins": 120,
     "losses": 30,
     "sr_avg": 0.80,
     "kpt_avg": 5.2,
     "resources_total": 15000,
     "exp_gained": 50000
   }
   ‚Üì
4. API 4 ‚Üí –≤–æ–∑–≤—Ä–∞—Ç JSON –∫–ª–∏–µ–Ω—Ç—É
```

---

## üéØ –û–°–ù–û–í–ù–´–ï USE CASES

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤:
```bash
POST /api/sync
‚Üí API 4 —Å–∫–∞–Ω–∏—Ä—É–µ—Ç ./xml/gz/
‚Üí –ù–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
‚Üí –ü–∞—Ä—Å–∏—Ç XML
‚Üí –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ PostgreSQL
‚Üí –û—Ç–≤–µ—Ç: {"synced": 10, "total": 100}
```

### 2. –ü–æ–∏—Å–∫ –±–æ–µ–≤ –∏–≥—Ä–æ–∫–∞:
```bash
GET /api/battle/search?player=–ò–≥—Ä–æ–∫123&limit=10
‚Üí API 4 ‚Üí SELECT FROM battles
‚Üí JOIN battle_participants
‚Üí WHERE player_login = '–ò–≥—Ä–æ–∫123'
‚Üí LIMIT 10
‚Üí –û—Ç–≤–µ—Ç: {"battles": [...], "total": 150}
```

### 3. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∞–Ω–∞:
```bash
GET /api/analytics/clan/–ú–æ–π–ö–ª–∞–Ω?days=7
‚Üí API 4 ‚Üí SELECT FROM daily_clan_features
‚Üí WHERE clan_name = '–ú–æ–π–ö–ª–∞–Ω'
‚Üí AND date >= NOW() - INTERVAL '7 days'
‚Üí –û—Ç–≤–µ—Ç: {"battles": 50, "avg_members": 12, "wins": 40}
```

### 4. –ü–æ–∏—Å–∫ –∞–Ω–æ–º–∞–ª–∏–π:
```bash
GET /api/analytics/anomalies?days=7
‚Üí API 4 ‚Üí SELECT FROM resource_anomalies
‚Üí WHERE z_score > 3  # —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–±—Ä–æ—Å—ã
‚Üí –û—Ç–≤–µ—Ç: [{"player": "Bot123", "resource": "Gold", "z_score": 5.2}]
```

---

## üì¶ –ó–ê–í–ò–°–ò–ú–û–°–¢–ò API 4

### –°–µ—Ä–≤–∏—Å—ã (HOST_API):
- **btl_syncer** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
- **btl_compressor** - —Å–∂–∞—Ç–∏–µ —Ñ–∞–π–ª–æ–≤
- **api_4_db** - PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **api_mother** - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) HTTP API –¥–ª—è —Ñ–∞–π–ª–æ–≤

### –í–Ω–µ—à–Ω–∏–µ (HOST_SERVER):
- **btl_rsyncd** - rsync daemon –¥–ª—è –ª–æ–≥–æ–≤

### –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
- ‚ùå api_father
- ‚ùå db_bridge
- ‚ùå MySQL tzserver
- ‚ùå Game Server

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö

- **Framework:** FastAPI (async)
- **–ë–î:** PostgreSQL (asyncpg)
- **–ü–∞—Ä—Å–∏–Ω–≥:** XML (lxml –∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
- **–§–∞–π–ª—ã:** pathlib, gzip
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** SQL –≤–∏—Ç—Ä–∏–Ω—ã
- **Clean Architecture:** ports, adapters, usecases

---

## ‚úÖ –ò–¢–û–ì–û: API 4

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ª–æ–≥–æ–≤ –±–æ–µ–≤

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** .tzb —Ñ–∞–π–ª—ã (XML –ª–æ–≥–∏)

**–û–±—Ä–∞–±–æ—Ç–∫–∞:** –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí –í–∏—Ç—Ä–∏–Ω—ã

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** JSON API (–ø–æ–∏—Å–∫, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)

**–ë–î:** PostgreSQL api4_battles (–°–í–û–Ø!)

**Endpoint:** 15 —à—Ç—É–∫

**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

---

**–î–∞—Ç–∞:** 2025-10-01
