# ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –≤ ML –¥–µ—Ç–µ–∫—Ç–æ—Ä - –ì–û–¢–û–í–û!

## üìä **–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

### **1. –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –≤ BotDetector:**

| –§–∏—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–æ–≤ |
|------|----------|-------------------|
| **ultra_short_ratio** | –î–æ–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ < 0.5 —Å–µ–∫ | > 0.3 = –ë–û–¢! |
| **max_gap_hours** | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (—á–∞—Å—ã) | < 0.5 = –ë–û–¢! |

---

## üîß **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**

### **1. `_get_player_features` (—Å—Ç—Ä–æ–∫–∏ 204-266):**

```python
# –î–û–ë–ê–í–õ–ï–ù–û –≤ SQL –∑–∞–ø—Ä–æ—Å:
-- –ù–û–í–û–ï: –£–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (< 0.5 —Å–µ–∫)
SUM(CASE WHEN gap_seconds <= 0.5 THEN 1 ELSE 0 END)::float / NULLIF(COUNT(gap_seconds), 0) as ultra_short_ratio,
-- –ù–û–í–û–ï: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤
MAX(gap_seconds) / 3600.0 as max_gap_hours

# –î–û–ë–ê–í–õ–ï–ù–û –≤ features dict:
'ultra_short_ratio': float(result['ultra_short_ratio'] or 0),  # 0-1
'max_gap_hours': min(float(result['max_gap_hours'] or 24), 48),  # cap at 48 hours
```

### **2. `_explain_anomaly` (—Å—Ç—Ä–æ–∫–∏ 268-300):**

```python
# –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
ultra_short_ratio = features.get('ultra_short_ratio', 0)
if ultra_short_ratio > 0.3:
    reasons.append(f"ü§ñ –ë–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫: {ultra_short_ratio:.1%}")
elif ultra_short_ratio > 0.1:
    reasons.append(f"‚ö†Ô∏è –ú–Ω–æ–≥–æ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ < 0.5 —Å–µ–∫: {ultra_short_ratio:.1%}")

# –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
max_gap_hours = features.get('max_gap_hours', 24)
if max_gap_hours < 0.5:
    reasons.append(f"ü§ñ –ù–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (–º–∞–∫—Å {max_gap_hours*60:.0f} –º–∏–Ω—É—Ç)")
```

### **3. `train_bot_detector` (—Å—Ç—Ä–æ–∫–∏ 303-403):**

```python
# –î–û–ë–ê–í–õ–ï–ù–û –≤ SQL –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏:
player_regularity AS (
    SELECT 
        player_id,
        STDDEV(gap_seconds) / NULLIF(AVG(gap_seconds), 0) as time_regularity,
        -- –ù–û–í–û–ï: –£–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
        SUM(CASE WHEN gap_seconds <= 0.5 THEN 1 ELSE 0 END)::float / NULLIF(COUNT(gap_seconds), 0) as ultra_short_ratio,
        -- –ù–û–í–û–ï: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤
        MAX(gap_seconds) / 3600.0 as max_gap_hours
    FROM player_gaps
    ...
)

# –î–û–ë–ê–í–õ–ï–ù–û –≤ features array:
features = [
    ... # —Å—Ç–∞—Ä—ã–µ —Ñ–∏—á–∏
    # –ù–û–í–´–ï –§–ò–ß–ò:
    float(r['ultra_short_ratio'] or 0),  # 0-1
    min(float(r['max_gap_hours'] or 24), 48),  # 0-48
]
```

---

## üìà **–¢–µ–ø–µ—Ä—å ML –¥–µ—Ç–µ–∫—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 10 —Ñ–∏—á–µ–π:**

| # | –§–∏—á–∞ | –°—Ç–∞—Ä–∞—è/–ù–æ–≤–∞—è | –í–∞–∂–Ω–æ—Å—Ç—å |
|---|------|--------------|----------|
| 1 | pvp_ratio | –°—Ç–∞—Ä–∞—è | –°—Ä–µ–¥–Ω—è—è |
| 2 | kpm | –°—Ç–∞—Ä–∞—è | –°—Ä–µ–¥–Ω—è—è |
| 3 | survival_rate | –°—Ç–∞—Ä–∞—è | –°—Ä–µ–¥–Ω—è—è |
| 4 | avg_kills_monsters | –°—Ç–∞—Ä–∞—è | –ù–∏–∑–∫–∞—è |
| 5 | avg_kills_players | –°—Ç–∞—Ä–∞—è | –ù–∏–∑–∫–∞—è |
| 6 | time_regularity | –°—Ç–∞—Ä–∞—è | –í—ã—Å–æ–∫–∞—è |
| 7 | location_diversity | –°—Ç–∞—Ä–∞—è | –°—Ä–µ–¥–Ω—è—è |
| 8 | total_battles | –°—Ç–∞—Ä–∞—è | –ù–∏–∑–∫–∞—è |
| 9 | **ultra_short_ratio** | **–ù–û–í–ê–Ø** | ‚≠ê **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø!** |
| 10 | **max_gap_hours** | **–ù–û–í–ê–Ø** | ‚≠ê **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø!** |

---

## üöÄ **–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**

### **–®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API 4**
```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client
docker restart host-api-service-api_4-1
```

### **–®–∞–≥ 2: –ü–ï–†–ï–û–ë–£–ß–ò–¢–¨ –º–æ–¥–µ–ª—å (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)**

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ 8 —Ñ–∏—á–∞—Ö, –Ω–æ–≤–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 10!

```bash
# –ß–µ—Ä–µ–∑ Swagger UI:
open http://localhost:9107
# ‚Üí API 4 ‚Üí POST /ml/bot-detector/train

# –ò–ª–∏ —á–µ—Ä–µ–∑ curl:
curl -X POST "http://localhost:8084/ml/bot-detector/train?days=90"
```

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å –Ω–æ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏:
curl "http://localhost:8084/analytics/antibot/candidates?days=7&limit=5"
```

---

## üìä **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–ë–´–õ–û (–±–µ–∑ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫):**
```json
{
  "login": "–ì–µ–ª—å–º–∞–Ω",
  "is_bot": true,
  "reasons": [
    "K-means: —Å—Ç–∏–ª—å 'PvP –Ω–æ–≤–∏—á–æ–∫' –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª–µ–Ω",
    "PvP < 5% (0.0%)",
    "KPM > 15 (43.6)",
    "SR > 95% (100.0%)"
  ]
}
```

### **–°–¢–ê–ù–ï–¢ (—Å –Ω–æ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏):**

**–ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π PvE –∏–≥—Ä–æ–∫:**
```json
{
  "login": "–ì–µ–ª—å–º–∞–Ω",
  "is_bot": false,  // –ò–ó–ú–ï–ù–ï–ù–û!
  "reasons": [
    "PvE –∏–≥—Ä–æ–∫ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏",
    "‚ö†Ô∏è –ú–Ω–æ–≥–æ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ < 0.5 —Å–µ–∫: 5%"  // –ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç
  ],
  "ultra_short_ratio": 0.05,
  "max_gap_hours": 2.5
}
```

**–ï—Å–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –±–æ—Ç:**
```json
{
  "login": "Art-LA",
  "is_bot": true,
  "reasons": [
    "ü§ñ –ë–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫: 35%",  // –ù–û–í–û–ï!
    "ü§ñ –ù–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (–º–∞–∫—Å 15 –º–∏–Ω—É—Ç)",     // –ù–û–í–û–ï!
    "Isolation Forest: –∞–Ω–æ–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (score=-0.01)",
    "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π KPM: 30.0",
    "–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π SR: 99.7%"
  ],
  "ultra_short_ratio": 0.35,
  "max_gap_hours": 0.25
}
```

---

## ‚úÖ **–ò—Ç–æ–≥:**

1. ‚úÖ **–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã** –≤ `bot_detector.py`
2. ‚úÖ **SQL –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è `ultra_short_ratio` –∏ `max_gap_hours`
3. ‚úÖ **–û–±—ä—è—Å–Ω–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π** –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
4. ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢–°–Ø –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–ï** –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ API 4

**–¢–µ–ø–µ—Ä—å ML –¥–µ—Ç–µ–∫—Ç–æ—Ä —Ä–∞–∑–ª–∏—á–∞–µ—Ç PvE –∏–≥—Ä–æ–∫–æ–≤ –∏ –±–æ—Ç–æ–≤ –ø–æ –í–†–ï–ú–ï–ù–ù–´–ú –ü–ê–¢–¢–ï–†–ù–ê–ú!** üéØ





