# ü§ñ –£–ª—É—á—à–µ–Ω–Ω–∞—è –î–µ—Ç–µ–∫—Ü–∏—è –ë–æ—Ç–æ–≤ - –ò—Ç–æ–≥–∏

## ‚úÖ **–ß–¢–û –°–î–ï–õ–ê–ù–û:**

### 1. **–ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ (–ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É):**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ—Ä–æ–≥ |
|----------|----------|-------|
| **–£–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã** | –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫ –º–µ–∂–¥—É –±–æ—è–º–∏ | 30%+ = –±–æ—Ç |
| **–ú–∞—Ä–∞—Ñ–æ–Ω-—Å–µ—Å—Å–∏–∏** | 3+ —á–∞—Å–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ñ–∞—Ä–º–∞ –±–µ–∑ –ø–∞—É–∑ > 5 –º–∏–Ω | 1+ = –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ |
| **–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã** | –ü–µ—Ä–µ—Ä—ã–≤—ã > 30 –º–∏–Ω—É—Ç | –ï—Å—Ç—å = –æ–±—ã—á–Ω—ã–π –∏–≥—Ä–æ–∫ |

### 2. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**

```python
# analytics.py (—Å—Ç—Ä–æ–∫–∏ 38-60)

# –ë–´–õ–û:
short_interval_sec: float = 1.0             # —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –ø–æ—Ä–æ–≥
w_pve_penalty: float = 0.15                 # —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π —à—Ç—Ä–∞—Ñ
w_short_intervals: float = 0.25             # –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

# –°–¢–ê–õ–û:
short_interval_sec: float = 0.5             # —Ç–æ–ª—å–∫–æ –±–æ—Ç—ã —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ
ultra_short_interval_sec: float = 0.5       # —É–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
ultra_short_ratio_high: float = 0.3         # 30%+ = –±–æ—Ç
marathon_session_hours: float = 3.0         # —Å–µ—Å—Å–∏—è 3+ —á–∞—Å–∞
natural_break_minutes: float = 5.0          # –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞

# –ù–æ–≤—ã–µ –≤–µ—Å–∞:
w_pve_penalty: float = 0.05                 # –°–ù–ò–ñ–ï–ù (PvE –∏–≥—Ä–æ–∫–∏ != –±–æ—Ç—ã)
w_ultra_short_intervals: float = 0.40       # –ù–û–í–´–ô: –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫!
w_marathon_sessions: float = 0.35           # –ù–û–í–´–ô: –º–∞—Ä–∞—Ñ–æ–Ω—ã!
w_activity: float = 0.20                    # –°–ù–ò–ñ–ï–ù (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å != –±–æ—Ç)
w_sr: float = 0.10                          # –°–ù–ò–ñ–ï–ù (SR != –±–æ—Ç)
w_kpm: float = 0.10                         # –°–ù–ò–ñ–ï–ù (KPM != –±–æ—Ç)
```

### 3. **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤ `_analyze_time_patterns` (—Å—Ç—Ä–æ–∫–∏ 1142-1176):**

```python
# –ù–û–í–û–ï: –£–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (< 0.5 —Å–µ–∫)
ultra_short_count = sum(1 for x in intervals if x <= 0.5)
ultra_short_ratio = ultra_short_count / len(intervals)

# –ù–û–í–û–ï: –ú–∞—Ä–∞—Ñ–æ–Ω-—Å–µ—Å—Å–∏–∏ (3+ —á–∞—Å–∞ –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ > 5 –º–∏–Ω—É—Ç)
marathon_sessions = []
current_session_duration = 0

for interval in intervals:
    if interval <= 300:  # <= 5 –º–∏–Ω—É—Ç
        current_session_duration += interval
    else:  # –ø–µ—Ä–µ—Ä—ã–≤ > 5 –º–∏–Ω—É—Ç
        if current_session_duration >= 10800:  # >= 3 —á–∞—Å–∞
            marathon_sessions.append(...)
```

### 4. **–†–∞–∑–ª–∏—á–µ–Ω–∏–µ PvE –∏–≥—Ä–æ–∫–æ–≤ –∏ –±–æ—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 714-728):**

```python
# –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê:
is_pve_focused = (kpm_pve > 10 and kpm_pvp < 0.5)
has_natural_breaks = (max_gap_hours > 0.5)
has_ultra_short = (ultra_short_ratio > 0.1)
has_marathons = (marathon_count > 0)

if is_pve_focused:
    if has_natural_breaks and not has_ultra_short and not has_marathons:
        # ‚úÖ –û–±—ã—á–Ω—ã–π PvE –∏–≥—Ä–æ–∫
        suspicion_score -= 0.3
        reasons.append("‚úÖ PvE –∏–≥—Ä–æ–∫ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏ (–Ω–µ –±–æ—Ç)")
    
    elif (has_marathons or has_ultra_short) and ultra_short_ratio > 0.2:
        # ü§ñ PvE –ë–û–¢
        suspicion_score += 0.4
        reasons.append("ü§ñ PvE –±–æ—Ç: –º–∞—Ä–∞—Ñ–æ–Ω—ã + –º–∏–∫—Ä–æ-–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã")
```

---

## üìà **–û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:**

### **–ü—Ä–∏–º–µ—Ä—ã:**

#### **PvE –∏–≥—Ä–æ–∫ (–ù–ï –ë–û–¢):**
```json
{
  "login": "–ì–µ–ª—å–º–∞–Ω",
  "battles": 155,
  "pve_kpm": 43.6,
  "pvp_ratio": 0.0,
  "sr": 1.0,
  "ultra_short_ratio": 0.05,       // —Ç–æ–ª—å–∫–æ 5% < 0.5 —Å–µ–∫
  "max_gap_hours": 2.5,             // –µ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤—ã
  "marathon_count": 0,              // –Ω–µ—Ç –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤
  "suspicion_score": 0.35,          // –°–ù–ò–ñ–ï–ù —Å 0.85!
  "is_bot": false,
  "reasons": ["‚úÖ PvE –∏–≥—Ä–æ–∫ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏ (–Ω–µ –±–æ—Ç)"]
}
```

#### **PvE –ë–û–¢:**
```json
{
  "login": "Art-LA",
  "battles": 1505,
  "pve_kpm": 45.0,
  "pvp_ratio": 0.0,
  "sr": 0.997,
  "ultra_short_ratio": 0.35,        // 35% < 0.5 —Å–µ–∫!
  "max_gap_hours": 0.2,             // –Ω–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
  "marathon_count": 2,              // 2 –º–∞—Ä–∞—Ñ–æ–Ω–∞
  "longest_marathon_hours": 5.5,    // 5.5 —á–∞—Å–æ–≤!
  "suspicion_score": 0.95,
  "is_bot": true,
  "reasons": [
    "ü§ñ –ë–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫ (35%, 527 —à—Ç)",
    "ü§ñ –ú–∞—Ä–∞—Ñ–æ–Ω-—Å–µ—Å—Å–∏–∏ –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (2 —à—Ç, –º–∞–∫—Å 5.5—á, 850 –±–æ–µ–≤)",
    "ü§ñ PvE –±–æ—Ç: –º–∞—Ä–∞—Ñ–æ–Ω—ã + –º–∏–∫—Ä–æ-–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã"
  ]
}
```

---

## üîß **–ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨:**

### 1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API 4:**
```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client
docker restart host-api-service-api_4-1
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å endpoint:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ days:
curl "http://localhost:8084/analytics/antibot/candidates?days=7&limit=5"
curl "http://localhost:8084/analytics/antibot/candidates?days=30&limit=5"

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∏–≥—Ä–æ–∫—É:
curl "http://localhost:8084/analytics/antibot/detail?login=–ì–µ–ª—å–º–∞–Ω&days=7"
```

### 3. **–û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- **–ú–µ–Ω—å—à–µ false positives** –¥–ª—è PvE –∏–≥—Ä–æ–∫–æ–≤
- **–ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è** —Ä–µ–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤
- **–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏** –≤ responses:
  - `ultra_short_ratio`
  - `marathon_count`
  - `longest_marathon_hours`

---

## üìä **–ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:**

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –≠—Ñ—Ñ–µ–∫—Ç |
|---------|-----|-------|--------|
| –í–µ—Å PvE —à—Ç—Ä–∞—Ñ–∞ | 0.15 | **0.05** | PvE –∏–≥—Ä–æ–∫–∏ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –±–æ—Ç–∞–º–∏ |
| –í–µ—Å —É–ª—å—Ç—Ä–∞-–∫–æ—Ä–æ—Ç–∫–∏—Ö | 0 | **0.40** | –ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ –±–æ—Ç–∞! |
| –í–µ—Å –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤ | 0 | **0.35** | –ë–æ—Ç—ã –Ω–µ –æ—Ç–¥—ã—Ö–∞—é—Ç |
| –í–µ—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ | 0.25 | **0.20** | –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚â† –±–æ—Ç |
| –í–µ—Å SR | 0.15 | **0.10** | –í—ã—Å–æ–∫–∏–π SR ‚â† –±–æ—Ç |
| –í–µ—Å KPM | 0.15 | **0.10** | –í—ã—Å–æ–∫–∏–π KPM ‚â† –±–æ—Ç |

---

## üéØ **–ò–¢–û–ì:**

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç:

‚úÖ **–û–±—ã—á–Ω—ã–π PvE –∏–≥—Ä–æ–∫:**
- –§–∞—Ä–º–∏—Ç –º–Ω–æ–≥–æ
- –í—ã—Å–æ–∫–∏–π SR
- –î–µ–ª–∞–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤—ã
- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã > 0.5 —Å–µ–∫

ü§ñ **PvE –ë–û–¢:**
- –§–∞—Ä–º–∏—Ç –º–Ω–æ–≥–æ
- –í—ã—Å–æ–∫–∏–π SR
- –ù–ï–¢ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (3+ —á–∞—Å–∞)
- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫ (30%+)

**–ì–ª–∞–≤–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ:** –ù–ï –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∞ **–ü–ê–¢–¢–ï–†–ù –ü–û–í–ï–î–ï–ù–ò–Ø**!





