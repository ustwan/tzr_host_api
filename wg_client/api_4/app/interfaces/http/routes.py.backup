from typing import Optional, Any, Dict, List
import os
from datetime import datetime

from fastapi import APIRouter, HTTPException, Path, Query, Depends, UploadFile, File

from app.usecases.get_battle import GetBattleUseCase
from app.usecases.list_battles import ListBattlesUseCase
from app.usecases.search_battles import SearchBattlesUseCase
from app.usecases.sync_logs import SyncLogsUseCase
from app.usecases.analytics import (
    PlayerAnalyticsUseCase, ClanAnalyticsUseCase, ResourceAnalyticsUseCase, MonsterAnalyticsUseCase, GeneralStatsUseCase
)
from app.usecases.admin_logs import AdminLogsUseCase
from app.domain.mappers import map_domain_battles_to_summary
from fastapi.responses import Response
from app.adapters.http_mother_client import HttpMotherClient
from app.database import BattleDatabase


def build_router(
    *,
    get_battle_uc: GetBattleUseCase,
    list_battles_uc: ListBattlesUseCase,
    search_battles_uc: SearchBattlesUseCase,
    sync_logs_uc: SyncLogsUseCase,
    player_analytics_uc: PlayerAnalyticsUseCase,
    clan_analytics_uc: ClanAnalyticsUseCase,
    resource_analytics_uc: ResourceAnalyticsUseCase,
    monster_analytics_uc: MonsterAnalyticsUseCase,
    general_stats_uc: GeneralStatsUseCase,
    admin_logs_uc: AdminLogsUseCase,
    require_admin_token,
) -> APIRouter:
    router = APIRouter()

    @router.get("/healthz")
    async def healthz():
        return {"status": "ok"}

    @router.get("/battle/healthz")
    async def battle_healthz():
        return {"status": "ok"}

    @router.get(
        "/battles/list",
        summary="–°–ø–∏—Å–æ–∫ –±–æ—ë–≤",
        description="–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–æ—ë–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ battle_id –∏–∑ –∏–≥—Ä—ã (source_id).",
        tags=["Battles"]
    )
    async def list_battles(page: int = Query(1, ge=1), limit: int = Query(10, ge=1, le=100)):
        battles, total = await list_battles_uc.execute(page=page, limit=limit)
        items = map_domain_battles_to_summary(battles)
        return {"battles": items, "total": total, "page": page, "limit": limit}

    # –ê–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –æ–∂–∏–¥–∞—é—â–∏–º–∏ /battle/list
    @router.get("/battle/list")
    async def list_battles_alias(page: int = Query(1, ge=1), limit: int = Query(10, ge=1, le=100)):
        return await list_battles(page=page, limit=limit)

    @router.get(
        "/battles/search",
        summary="–ü–æ–∏—Å–∫ –±–æ—ë–≤",
        description="""
–ü–æ–∏—Å–∫ –±–æ—ë–≤ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º: –∏–≥—Ä–æ–∫, –∫–ª–∞–Ω, —Ç–∏–ø –±–æ—è, –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏, –º–æ–Ω—Å—Ç—Ä—ã.

**–ü—Ä–∏–º–µ—Ä—ã:**
- `player=–¢–µ—Ä–º–∏—Ç` - –≤—Å–µ –±–æ–∏ –∏–≥—Ä–æ–∫–∞
- `clan=WG` - –≤—Å–µ –±–æ–∏ –∫–ª–∞–Ω–∞
- `from_date=2025-10-01&to_date=2025-10-08` - –±–æ–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
- `monsters=rat` - –±–æ–∏ —Å –∫—Ä—ã—Å–∞–º–∏
        """,
        tags=["Battles"]
    )
    async def search_battles(
        player: Optional[str] = Query(None, description="–ò–º—è –∏–≥—Ä–æ–∫–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)"),
        clan: Optional[str] = Query(None, description="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞"),
        battle_type: Optional[str] = Query(None, description="–¢–∏–ø –±–æ—è"),
        from_date: Optional[datetime] = Query(None, description="–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞"),
        to_date: Optional[datetime] = Query(None, description="–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞"),
        monsters: Optional[str] = Query(None, description="–¢–∏–ø –º–æ–Ω—Å—Ç—Ä–∞"),
        page: int = Query(1, ge=1),
        limit: int = Query(10, ge=1, le=100),
    ):
        battles, total = await search_battles_uc.execute(
            player=player, clan=clan, battle_type=battle_type,
            from_date=from_date, to_date=to_date, monsters=monsters,
            page=page, limit=limit,
        )
        items = map_domain_battles_to_summary(battles)
        return {"battles": items, "total": total, "page": page, "limit": limit}

    # –ê–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: /battle/search
    @router.get("/battle/search")
    async def search_battles_alias(
        player: Optional[str] = Query(None),
        clan: Optional[str] = Query(None),
        battle_type: Optional[str] = Query(None),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
        monsters: Optional[str] = Query(None),
        page: int = Query(1, ge=1),
        limit: int = Query(10, ge=1, le=100),
    ):
        return await search_battles(
            player=player, clan=clan, battle_type=battle_type,
            from_date=from_date, to_date=to_date, monsters=monsters,
            page=page, limit=limit,
        )

    @router.get(
        "/battle/{battle_id:int}",
        summary="–ü–æ–ª—É—á–∏—Ç—å –±–æ–π –ø–æ ID",
        description="–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ–µ –ø–æ –µ–≥–æ service_id (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ë–î).",
        tags=["Battles"]
    )
    async def get_battle(battle_id: int = Path(..., description="Service ID –±–æ—è (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ë–î)")):
        battle = await get_battle_uc.execute(battle_id)
        if not battle:
            raise HTTPException(status_code=404, detail="–ë–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return battle

    @router.get("/battle/by-source/{source_id:int}")
    async def get_battle_by_source(source_id: int = Path(...)):
        db = BattleDatabase()
        row = await db._execute_one("SELECT id FROM battles WHERE source_id = $1", source_id)
        await db.disconnect()
        if not row:
            raise HTTPException(status_code=404, detail="–ë–æ–π —Å —Ç–∞–∫–∏–º source_id –Ω–µ –Ω–∞–π–¥–µ–Ω")
        battle = await get_battle_uc.execute(int(row["id"]))
        if not battle:
            raise HTTPException(status_code=404, detail="–ë–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return battle

    @router.get(
        "/battle/{battle_id:int}/raw",
        summary="–ü–æ–ª—É—á–∏—Ç—å —Å—ã—Ä–æ–π XML –ª–æ–≥ –±–æ—è",
        description="–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π XML —Ñ–∞–π–ª –±–æ—è (.tzb) –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞.",
        tags=["Battles"]
    )
    async def get_battle_raw(battle_id: int = Path(..., description="Service ID –±–æ—è")):
        # 1) –ü–æ–ª—É—á–∞–µ–º storage_key –∏–∑ –ë–î (–∏—â–µ–º –ø–æ source_id, —Ç.–∫. battle_id = source_id)
        db = BattleDatabase()
        # –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º service_id –ø–æ source_id
        row = await db._execute_one("SELECT id, storage_key FROM battles WHERE source_id = $1", battle_id)
        await db.disconnect()
        if not row or not row.get("storage_key"):
            raise HTTPException(status_code=404, detail="–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
        storage_key = row["storage_key"]

        # 2) –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ api_mother (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)
        mother = HttpMotherClient()
        try:
            if await mother.health_check():
                # –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ api_mother –≤–µ—Ä–Ω—ë—Ç gz- –∏–ª–∏ xml-–∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–º—É –ø—É—Ç–∏
                # –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º basename (—Ç—Ä–µ–±—É–µ—Ç—Å—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—É—Ç–µ–π –≤ api_mother)
                import os
                content = await mother.get_gz_file(os.path.basename(storage_key))
                try:
                    import gzip
                    xml = gzip.decompress(content)
                except Exception:
                    xml = content
                return Response(content=xml, media_type="application/xml")
        except Exception:
            pass
        finally:
            await mother.close()

        # 3) –§–æ–ª–±—ç–∫: —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ (—Å –ø–µ—Ä–µ–±–æ—Ä–æ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ basename)
        import gzip, os
        base = os.path.basename(storage_key)
        candidates = []
        # –∏—Å—Ö–æ–¥–Ω—ã–π –ø—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        candidates.append(storage_key)
        # –≤–∞—Ä–∏–∞–Ω—Ç —Å .gz/–±–µ–∑ .gz
        if storage_key.endswith('.gz'):
            candidates.append(storage_key[:-3])
        else:
            candidates.append(storage_key + '.gz')
        # –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ /app
        candidates.append(os.path.join('/app', base))
        if not base.endswith('.gz'):
            candidates.append(os.path.join('/app', base + '.gz'))
        else:
            candidates.append(os.path.join('/app', base[:-3]))

        # –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ª–æ–≥–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        log_base = '/home/zero/logs/btl'
        candidates.append(os.path.join(log_base, base))
        if not base.endswith('.gz'):
            candidates.append(os.path.join(log_base, base + '.gz'))
        else:
            candidates.append(os.path.join(log_base, base[:-3]))

        # –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ, –µ—Å–ª–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ —Ç–æ–º—É –∂–µ –ø—É—Ç–∏
        mirror_base = '/Users/ii/Documents/srv/btl_mirror'
        candidates.append(os.path.join(mirror_base, base))
        if not base.endswith('.gz'):
            candidates.append(os.path.join(mirror_base, base + '.gz'))
        else:
            candidates.append(os.path.join(mirror_base, base[:-3]))

        last_err = None
        # –î–æ–±–∞–≤–∏–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ —à–∞–±–ª–æ–Ω—É <battle_id>.tzb(.gz)
        try:
            bid_str = str(battle_id)
            name_variants = [f"{bid_str}.tzb", f"{bid_str}.tzb.gz"]
            for nm in name_variants:
                candidates.append(os.path.join('/app', nm))
                candidates.append(os.path.join(log_base, nm))
                candidates.append(os.path.join(mirror_base, nm))
        except Exception:
            pass

        for cand in candidates:
            try:
                if cand.endswith('.gz'):
                    with gzip.open(cand, 'rb') as f:
                        data = f.read()
                else:
                    with open(cand, 'rb') as f:
                        data = f.read()
                return Response(content=data, media_type="application/xml")
            except Exception as e:  # –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç
                last_err = e
                continue
        raise HTTPException(status_code=500, detail=f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª: {last_err}")

    @router.post("/sync")
    async def sync():
        result = await sync_logs_uc.sync(os.getenv("LOGS_BASE", "/home/zero/logs/btl"))
        return {"synced": result.get("successful", 0), "total": result.get("total_files", 0), "errors": result.get("errors", [])}

    @router.post("/sync/reprocess")
    async def reprocess():
        result = await sync_logs_uc.reprocess()
        return {"message": "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞", "processed": result.get("processed", 0), "successful": result.get("successful", 0), "failed": result.get("failed", 0)}

    @router.get("/analytics/player/{login}")
    async def get_player(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        stats = await player_analytics_uc.get_player(login=login, days=days)
        if not stats:
            raise HTTPException(status_code=404, detail="–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        # –£–õ–£–ß–®–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º K-means playstyle
        player_id = await player_analytics_uc._a._get_player_id_by_login(login)
        if player_id:
            playstyle_data = await player_analytics_uc._a._get_playstyle(player_id, days=days)
            if playstyle_data:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Pydantic –æ–±—ä–µ–∫—Ç –≤ dict –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if hasattr(stats, 'dict'):
                    stats_dict = stats.dict()
                elif hasattr(stats, '__dict__'):
                    stats_dict = stats.__dict__
                else:
                    stats_dict = dict(stats)
                
                # –î–æ–±–∞–≤–ª—è–µ–º playstyle
                stats_dict['playstyle'] = playstyle_data.get('display_name')
                stats_dict['playstyle_confidence'] = playstyle_data.get('confidence')
                stats_dict['playstyle_cluster_id'] = playstyle_data.get('cluster_id')
                
                # –î–æ–±–∞–≤–ª—è–µ–º bot detection
                bd = playstyle_data.get('bot_detection', {})
                if bd.get('is_likely_bot'):
                    stats_dict['bot_warning'] = {
                        'is_likely_bot': True,
                        'bot_score': bd.get('bot_score'),
                        'reasons': bd.get('reasons', [])
                    }
                
                return stats_dict
        
        return stats

    @router.get("/analytics/players/top")
    async def get_top_players(metric: str = Query("battles_count"), limit: int = Query(10, ge=1, le=100), days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc.get_top_players(metric=metric, limit=limit, days=days)

    @router.get("/analytics/clan/{name}")
    async def get_clan(name: str = Path(...), days: int = Query(30, ge=1, le=365)):
        stats = await clan_analytics_uc.get_clan(name=name, days=days)
        if not stats:
            raise HTTPException(status_code=404, detail="–ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return stats

    @router.get("/analytics/resource/{name}")
    async def get_resource(name: str = Path(...), days: int = Query(30, ge=1, le=365)):
        stats = await resource_analytics_uc.get_resource(name=name, days=days)
        if not stats:
            raise HTTPException(status_code=404, detail="–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return stats

    @router.get("/analytics/monster/{kind}")
    async def get_monster(kind: str = Path(...), days: int = Query(30, ge=1, le=365)):
        stats = await monster_analytics_uc.get_monster(kind=kind, days=days)
        if not stats:
            raise HTTPException(status_code=404, detail="–ú–æ–Ω—Å—Ç—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return stats

    @router.get("/analytics/anomalies")
    async def get_anomalies(days: int = Query(7, ge=1, le=30)):
        return await resource_analytics_uc.get_anomalies(days=days)

    @router.get("/analytics/stats")
    async def general_stats(days: int = Query(30, ge=1, le=365)):
        return await general_stats_uc.get_stats(days=days)

    @router.get("/analytics/antibot/candidates")
    async def analytics_antibot_candidates(limit: int = Query(50, ge=1, le=200), days: int = Query(7, ge=1, le=365)):
        return await player_analytics_uc._a.get_antibot_candidates(limit=limit, days=days)

    @router.get("/analytics/antiboost/pairs")
    async def analytics_antiboost_pairs(days: int = Query(14, ge=1, le=180), min_pairs: int = Query(3, ge=1, le=20)):
        return await player_analytics_uc._a.get_antiboost_pairs(days=days, min_pairs=min_pairs)

    @router.get("/analytics/economy/resources")
    async def analytics_economy_resources(days: int = Query(30, ge=1, le=365)):
        return await resource_analytics_uc.get_economy(days=days)

    # –ù–æ–≤—ã–µ —Ä—É—á–∫–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ PvE
    @router.get("/analytics/economy/resources/series")
    async def analytics_resources_series(
        days: int = Query(30, ge=1, le=365),
        bucket: str = Query("day", pattern="^(day|week)$"),
        loc_x: Optional[int] = Query(None),
        loc_y: Optional[int] = Query(None),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
    ):
        # –ü–µ—Ä–µ–¥–∞–¥–∏–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ø–æ—Å–æ–± –∑–∞–¥–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç from/to
        kwargs = {"days": days, "bucket": bucket, "loc_x": loc_x, "loc_y": loc_y}
        if from_date and to_date:
            kwargs.update({"from_date": from_date.date(), "to_date": to_date.date()})
        return await player_analytics_uc._a.get_resources_series(**kwargs)

    @router.get("/analytics/economy/resources/top-miners")
    async def analytics_resources_top_miners(
        days: int = Query(30, ge=1, le=365),
        loc_x: Optional[int] = Query(None),
        loc_y: Optional[int] = Query(None),
        limit: int = Query(10, ge=1, le=100),
        by: str = Query("player", pattern="^(player|clan)$"),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
        exclude_bots: bool = Query(False, description="–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –±–æ—Ç–æ–≤ (K-means)")  # –ù–û–í–´–ô
    ):
        kwargs = {"days": days, "loc_x": loc_x, "loc_y": loc_y, "limit": limit, "by": by, "exclude_bots": exclude_bots}
        if from_date and to_date:
            kwargs.update({"from_date": from_date.date(), "to_date": to_date.date()})
        return await player_analytics_uc._a.get_resources_top_miners(**kwargs)

    @router.get("/analytics/economy/resources/summary")
    async def analytics_resources_summary(
        loc_x: Optional[int] = Query(None),
        loc_y: Optional[int] = Query(None),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
        days: int = Query(30, ge=1, le=365),
    ):
        kwargs = {"loc_x": loc_x, "loc_y": loc_y, "days": days}
        if from_date and to_date:
            kwargs.update({"from_date": from_date.date(), "to_date": to_date.date()})
        return await player_analytics_uc._a.get_resources_summary(**kwargs)

    @router.get("/analytics/pve/load")
    async def analytics_pve_load(
        days: int = Query(30, ge=1, le=365),
        bucket: str = Query("day", pattern="^(day|week)$"),
        loc_x: Optional[int] = Query(None),
        loc_y: Optional[int] = Query(None),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
    ):
        kwargs = {"days": days, "bucket": bucket, "loc_x": loc_x, "loc_y": loc_y}
        if from_date and to_date:
            kwargs.update({"from_date": from_date, "to_date": to_date})
        return await player_analytics_uc._a.get_pve_load(**kwargs)

    @router.get("/analytics/pve/top-locations")
    async def analytics_pve_top_locations(days: int = Query(30, ge=1, le=365), limit: int = Query(10, ge=1, le=100)):
        return await player_analytics_uc._a.get_pve_top_locations(days=days, limit=limit)

    @router.get("/analytics/pve/monsters/breakdown")
    async def analytics_pve_monster_breakdown(
        loc_x: Optional[int] = Query(None),
        loc_y: Optional[int] = Query(None),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
        days: int = Query(30, ge=1, le=365),
        limit: int = Query(100, ge=1, le=1000),
    ):
        return await player_analytics_uc._a.get_pve_monster_breakdown(loc_x=loc_x, loc_y=loc_y, from_date=from_date, to_date=to_date, days=days, limit=limit)

    # ===== –ù–æ–≤—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ =====
    @router.get("/analytics/survival/player/{login}")
    async def analytics_survival_player(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc.get_survival(login=login, days=days)

    @router.get("/analytics/survival/clan/{name}")
    async def analytics_survival_clan(name: str = Path(...), days: int = Query(30, ge=1, le=365)):
        return await clan_analytics_uc.get_survival(name=name, days=days)

    @router.get("/analytics/efficiency/player/{login}")
    async def analytics_efficiency_player(
        login: str = Path(...),
        days: int = Query(30, ge=1, le=365),
        w_p: float = Query(1.0, ge=0.0, le=10.0),
    ):
        return await player_analytics_uc.get_efficiency(login=login, days=days, w_p=w_p)

    @router.get("/analytics/efficiency/top")
    async def analytics_efficiency_top(limit: int = Query(10, ge=1, le=100), days: int = Query(30, ge=1, le=365), w_p: float = Query(1.0, ge=0.0, le=10.0)):
        return await player_analytics_uc.get_efficiency_top(limit=limit, days=days, w_p=w_p)

    @router.get("/analytics/battles/player/{login}")
    async def analytics_player_battles(
        login: str = Path(...),
        from_date: Optional[datetime] = Query(None),
        to_date: Optional[datetime] = Query(None),
        limit: int = Query(1000, ge=1, le=100000),
    ):
        """–í–µ—Ä–Ω—ë—Ç —Å–ø–∏—Å–æ–∫ –±–æ—ë–≤ –∏–≥—Ä–æ–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥: id –∏ ts."""
        db = BattleDatabase()
        where = ["p.login = $1"]
        params: List[Any] = [login]
        arg_idx = 2
        if from_date is not None:
            where.append(f"b.ts >= ${arg_idx}")
            params.append(from_date)
            arg_idx += 1
        if to_date is not None:
            where.append(f"b.ts <= ${arg_idx}")
            params.append(to_date)
            arg_idx += 1
        where_sql = " AND ".join(where)
        query = f"""
            SELECT b.id AS battle_id, b.source_id, b.ts
            FROM battles b
            JOIN battle_participants bp ON bp.battle_id = b.id
            JOIN players p ON p.id = bp.player_id
            WHERE {where_sql}
            ORDER BY b.ts ASC
            LIMIT ${arg_idx}
        """
        params.append(limit)
        rows = await db._execute_query(query, *params)
        await db.disconnect()
        return [{"battle_id": r["battle_id"], "source_id": r.get("source_id"), "ts": r["ts"]} for r in rows]

    @router.get("/analytics/antibot/player/{login}")
    async def analytics_antibot_player_detail(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        detail = await player_analytics_uc._a.get_antibot_player_detail(login=login, days=days)
        if not detail:
            raise HTTPException(status_code=404, detail="–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö")
        return detail

    @router.get("/admin/loading-stats")
    async def loading_stats(_: str = Depends(require_admin_token)):
        return await admin_logs_uc.loading_stats()

    @router.post("/admin/cleanup")
    async def cleanup(days_old: int = Query(30, ge=1, le=365), _: str = Depends(require_admin_token)):
        deleted = await admin_logs_uc.cleanup(days_old=days_old)
        return {"message": f"–£–¥–∞–ª–µ–Ω–æ {deleted} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –ª–æ–≥–æ–≤", "deleted_count": deleted}

    @router.post("/battles/upload")
    async def upload_battle_file(file: UploadFile = File(...)):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç TZB —Ñ–∞–π–ª –∏–ª–∏ –∞—Ä—Ö–∏–≤ .tzb.gz"""
        if not (file.filename.endswith('.tzb') or file.filename.endswith('.tzb.gz')):
            raise HTTPException(status_code=400, detail="–¢–æ–ª—å–∫–æ .tzb –∏ .tzb.gz —Ñ–∞–π–ª—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è")
        
        try:
            # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
            content = await file.read()
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            import tempfile
            import gzip
            
            if file.filename.endswith('.tzb.gz'):
                # –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º .tzb.gz —Ñ–∞–π–ª
                print(f"üîÑ –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É—é: {file.filename}")
                decompressed_content = gzip.decompress(content)
                
                with tempfile.NamedTemporaryFile(suffix='.tzb', delete=False) as tmp_file:
                    tmp_file.write(decompressed_content)
                    tmp_path = tmp_file.name
            else:
                # –û–±—ã—á–Ω—ã–π .tzb —Ñ–∞–π–ª
                with tempfile.NamedTemporaryFile(suffix='.tzb', delete=False) as tmp_file:
                    tmp_file.write(content)
                    tmp_path = tmp_file.name
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ loader
            from app.loader import BattleLoader
            from app.database import BattleDatabase
            from app.parser import BattleParser
            
            db = BattleDatabase()
            parser = BattleParser()
            loader = BattleLoader(db, parser)
            
            result = await loader.process_file(tmp_path)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            os.unlink(tmp_path)
            
            return {
                "message": f"–§–∞–π–ª {file.filename} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω",
                "battle_id": result.get("battle_id"),
                "status": "success"
            }
            
        except Exception as e:
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            if 'tmp_path' in locals():
                try:
                    os.unlink(tmp_path)
                except:
                    pass
            raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {str(e)}")

    # ===== –°–û–¶–ò–ê–õ–¨–ù–´–ï –ê–ù–ê–õ–ò–¢–ò–ö–ò =====
    @router.get("/analytics/social/allies/{login}")
    async def analytics_social_allies(login: str = Path(...), days: int = Query(30, ge=1, le=365), limit: int = Query(10, ge=1, le=50)):
        return await player_analytics_uc._a.get_player_allies(login=login, days=days, limit=limit)

    @router.get("/analytics/social/rivals/{login}")
    async def analytics_social_rivals(login: str = Path(...), days: int = Query(30, ge=1, le=365), limit: int = Query(10, ge=1, le=50)):
        return await player_analytics_uc._a.get_player_rivals(login=login, days=days, limit=limit)

    @router.get("/analytics/clans/wars")
    async def analytics_clans_wars(days: int = Query(30, ge=1, le=365), limit: int = Query(20, ge=1, le=100)):
        return await player_analytics_uc._a.get_clan_wars(days=days, limit=limit)

    # ===== –¢–ï–†–†–ò–¢–û–†–ò–ê–õ–¨–ù–´–ï –ê–ù–ê–õ–ò–¢–ò–ö–ò =====
    @router.get("/analytics/map/heatmap")
    async def analytics_map_heatmap(days: int = Query(30, ge=1, le=365), limit: int = Query(100, ge=1, le=500)):
        return await player_analytics_uc._a.get_map_heatmap(days=days, limit=limit)

    @router.get("/analytics/map/pvp-hotspots")
    async def analytics_map_pvp_hotspots(days: int = Query(30, ge=1, le=365), limit: int = Query(10, ge=1, le=50)):
        return await player_analytics_uc._a.get_pvp_hotspots(days=days, limit=limit)

    @router.get("/analytics/map/clan-control")
    async def analytics_map_clan_control(days: int = Query(30, ge=1, le=365), limit: int = Query(10, ge=1, le=50)):
        return await player_analytics_uc._a.get_clan_control(days=days, limit=limit)

    # ===== –í–†–ï–ú–ï–ù–ù–´–ï –ê–ù–ê–õ–ò–¢–ò–ö–ò =====
    @router.get("/analytics/time/activity-heatmap")
    async def analytics_time_activity_heatmap(days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_activity_heatmap(days=days)

    @router.get("/analytics/time/peak-hours")
    async def analytics_time_peak_hours(days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_peak_hours(days=days)

    # ===== –≠–ö–û–ù–û–ú–ò–ö–ê –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø =====
    @router.get("/analytics/economy/farm-efficiency/{login}")
    async def analytics_economy_farm_efficiency(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_farm_efficiency(login=login, days=days)

    @router.get("/analytics/economy/rare-items")
    async def analytics_economy_rare_items(days: int = Query(30, ge=1, le=365), limit: int = Query(20, ge=1, le=100)):
        return await player_analytics_uc._a.get_rare_items(days=days, limit=limit)

    # ===== –°–û–†–ï–í–ù–û–í–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–†–ò–ö–ò =====
    @router.get("/analytics/pvp/elo")
    async def analytics_pvp_elo(days: int = Query(30, ge=1, le=365), limit: int = Query(50, ge=1, le=200)):
        return await player_analytics_uc._a.get_player_elo(days=days, limit=limit)

    @router.get("/analytics/streaks/{login}")
    async def analytics_streaks(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_player_streaks(login=login, days=days)

    # ===== –ú–ï–¢–ê-–ê–ù–ê–õ–ò–ó =====
    @router.get("/analytics/meta/professions")
    async def analytics_meta_professions(days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_profession_stats(days=days)

    @router.get("/players/by-profession")
    async def get_players_by_profession(
        profession: str = Query(..., description="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–±–µ–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏', '—Å—Ç–∞–ª–∫–µ—Ä')"),
        limit: int = Query(50, ge=1, le=500, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤"),
        days: int = Query(365, ge=1, le=365, description="–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π")
    ):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ —Å –∏—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
        return await player_analytics_uc._a.get_players_by_profession(profession=profession, limit=limit, days=days)

    @router.get("/analytics/meta/balance")
    async def analytics_meta_balance(days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_balance_report(days=days)

    # ===== –ü–†–ï–î–°–ö–ê–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê =====
    @router.get("/analytics/predictions/churn")
    async def analytics_predictions_churn(days: int = Query(30, ge=1, le=365), limit: int = Query(50, ge=1, le=200)):
        return await player_analytics_uc._a.get_churn_prediction(days=days, limit=limit)

    @router.get("/analytics/recommendations/farming/{login}")
    async def analytics_recommendations_farming(login: str = Path(...), days: int = Query(30, ge=1, le=365)):
        return await player_analytics_uc._a.get_farming_recommendations(login=login, days=days)

    # ===== ML / PLAYSTYLE =====
    
    @router.get("/analytics/playstyle/{login}")
    async def analytics_playstyle(login: str = Path(...), days: int = Query(90, ge=7, le=365)):
        """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∏–ª—è –∏–≥—Ä—ã —Å –ø–æ–º–æ—â—å—é K-means"""
        try:
            from app.ml.playstyle_classifier import PlaystyleClassifier, SKLEARN_AVAILABLE
        except ImportError:
            raise HTTPException(status_code=501, detail="ML –º–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        if not SKLEARN_AVAILABLE:
            raise HTTPException(status_code=501, detail="scikit-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        # –ü–æ–ª—É—á–∞–µ–º player_id
        player_id = await player_analytics_uc._a._get_player_id_by_login(login)
        if not player_id:
            raise HTTPException(status_code=404, detail=f"–ò–≥—Ä–æ–∫ {login} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º/—Å–æ–∑–¥–∞—ë–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
        classifier = PlaystyleClassifier()
        
        # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        if not classifier.load_model():
            # –ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
            raise HTTPException(
                status_code=503, 
                detail="–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞. –ê–¥–º–∏–Ω—É: –∑–∞–ø—É—Å—Ç–∏—Ç–µ POST /admin/ml/train-playstyle"
            )
        
        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–∞
        db = BattleDatabase()
        result = await classifier.classify_player(player_id, db, days=days)
        await db.disconnect()
        
        if not result:
            raise HTTPException(status_code=404, detail=f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º 5 –±–æ—ë–≤)")
        
        return result
    
    @router.get("/analytics/playstyle/clusters/stats")
    async def analytics_playstyle_clusters():
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º —Å—Ç–∏–ª–µ–π –∏–≥—Ä—ã"""
        try:
            from app.ml.playstyle_classifier import PlaystyleClassifier, SKLEARN_AVAILABLE
        except ImportError:
            raise HTTPException(status_code=501, detail="ML –º–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        if not SKLEARN_AVAILABLE:
            raise HTTPException(status_code=501, detail="scikit-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        classifier = PlaystyleClassifier()
        
        if not classifier.load_model():
            raise HTTPException(status_code=503, detail="–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞")
        
        return {
            "clusters": classifier.get_cluster_stats(),
            "total_clusters": classifier.n_clusters,
        }
    
    # ===== XML SYNC ENDPOINTS =====
    
    @router.get("/admin/xml-sync/workers/health")
    async def xml_sync_workers_health(_token = Depends(require_admin_token)):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –≤—Å–µ—Ö XML –≤–æ—Ä–∫–µ—Ä–æ–≤"""
        from app.xml_sync_worker import XmlSyncWorker
        worker = XmlSyncWorker()
        return await worker.check_workers_health()
    
    @router.post("/admin/xml-sync/battle/{battle_id}")
    async def xml_sync_single_battle(
        battle_id: int = Path(..., ge=1),
        _token = Depends(require_admin_token)
    ):
        """–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ–¥–∏–Ω –ª–æ–≥ –±–æ—è —á–µ—Ä–µ–∑ XML –ø—Ä–æ—Ç–æ–∫–æ–ª"""
        from app.xml_sync_client import XmlSyncClient
        from app.database import BattleDatabase
        
        client = XmlSyncClient()
        db = BattleDatabase()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –ª–∏ —É–∂–µ
        existing = await db._execute_one(
            "SELECT battle_id, status FROM xml_sync_log WHERE battle_id = $1",
            battle_id
        )
        
        if existing and existing['status'] == 'success':
            await db.disconnect()
            return {
                "message": f"–ë–æ–π {battle_id} —É–∂–µ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—Ä–æ—à–µ–Ω —Ä–∞–Ω–µ–µ",
                "battle_id": battle_id,
                "status": "already_exists"
            }
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–æ–≥
        result = client.request_and_save(battle_id)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–≥
        if result:
            await db._execute_command(
                """
                INSERT INTO xml_sync_log (battle_id, requested_at, status, error_message, file_path, size_bytes)
                VALUES ($1, $2, $3, $4, $5, $6)
                ON CONFLICT (battle_id) DO UPDATE SET
                    requested_at = EXCLUDED.requested_at,
                    status = EXCLUDED.status,
                    error_message = EXCLUDED.error_message,
                    file_path = EXCLUDED.file_path,
                    size_bytes = EXCLUDED.size_bytes
                """,
                battle_id,
                datetime.now(),
                result['status'],
                result.get('error'),
                result.get('file_path'),
                result.get('size_bytes')
            )
        
        await db.disconnect()
        return result
    
    @router.post("/admin/xml-sync/range")
    async def xml_sync_range(
        start_id: int = Query(..., ge=1, description="–ù–∞—á–∞–ª—å–Ω—ã–π ID –±–æ—è"),
        end_id: int = Query(..., ge=1, description="–ö–æ–Ω–µ—á–Ω—ã–π ID –±–æ—è"),
        skip_existing: bool = Query(True, description="–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —É–∂–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –±–æ–∏"),
        _token = Depends(require_admin_token)
    ):
        """–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –ª–æ–≥–æ–≤ –±–æ–µ–≤ —á–µ—Ä–µ–∑ HTTP –≤–æ—Ä–∫–µ—Ä—ã"""
        from app.xml_sync_worker import XmlSyncWorker
        
        if end_id < start_id:
            raise HTTPException(status_code=400, detail="end_id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= start_id")
        
        if end_id - start_id > 1000:
            raise HTTPException(status_code=400, detail="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: 1000 –±–æ–µ–≤ –∑–∞ —Ä–∞–∑")
        
        worker = XmlSyncWorker()
        result = await worker.sync_range(start_id, end_id, skip_existing)
        
        return result
    
    @router.get("/admin/xml-sync/status")
    async def xml_sync_status(_token = Depends(require_admin_token)):
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É XML —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
        from app.database import BattleDatabase
        
        db = BattleDatabase()
        
        stats = await db._execute_one("""
            SELECT 
                COUNT(*) as total_requests,
                COUNT(*) FILTER (WHERE status = 'success') as success_count,
                COUNT(*) FILTER (WHERE status = 'failed') as failed_count,
                MIN(battle_id) as min_battle_id,
                MAX(battle_id) as max_battle_id,
                MAX(requested_at) as last_request
            FROM xml_sync_log
        """)
        
        await db.disconnect()
        
        return {
            "total_requests": stats['total_requests'] or 0,
            "success_count": stats['success_count'] or 0,
            "failed_count": stats['failed_count'] or 0,
            "min_battle_id": stats['min_battle_id'],
            "max_battle_id": stats['max_battle_id'],
            "last_request": stats['last_request'].isoformat() if stats['last_request'] else None
        }
    
    @router.get("/admin/xml-sync/requested")
    async def xml_sync_requested(
        limit: int = Query(50, ge=1, le=500, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π"),
        status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: success, failed"),
        _token = Depends(require_admin_token)
    ):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö –±–æ–µ–≤"""
        from app.database import BattleDatabase
        
        db = BattleDatabase()
        
        if status:
            query = """
                SELECT battle_id, requested_at, status, error_message, file_path, size_bytes
                FROM xml_sync_log
                WHERE status = $1
                ORDER BY requested_at DESC
                LIMIT $2
            """
            rows = await db._execute_query(query, status, limit)
        else:
            query = """
                SELECT battle_id, requested_at, status, error_message, file_path, size_bytes
                FROM xml_sync_log
                ORDER BY requested_at DESC
                LIMIT $1
            """
            rows = await db._execute_query(query, limit)
        
        await db.disconnect()
        
        return {
            "count": len(rows),
            "limit": limit,
            "status_filter": status,
            "battles": [
                {
                    "battle_id": row['battle_id'],
                    "requested_at": row['requested_at'].isoformat() if row['requested_at'] else None,
                    "status": row['status'],
                    "error_message": row['error_message'],
                    "file_path": row['file_path'],
                    "size_bytes": row['size_bytes']
                }
                for row in rows
            ]
        }
    
    @router.delete("/admin/xml-sync/cleanup")
    async def xml_sync_cleanup(_token = Depends(require_admin_token)):
        """–û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã .tzb –∏–∑ /tmp/"""
        import glob
        
        files = glob.glob("/tmp/*.tzb")
        deleted_count = 0
        
        for file_path in files:
            try:
                os.remove(file_path)
                deleted_count += 1
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å {file_path}: {e}")
        
        return {
            "message": f"–£–¥–∞–ª–µ–Ω–æ {deleted_count} –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤",
            "deleted_count": deleted_count
        }
    
    @router.get("/admin/xml-sync/errors")
    async def xml_sync_errors(
        limit: int = Query(100, ge=1, le=1000, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π"),
        error_type: str = Query("all", description="–¢–∏–ø: all, failed, response_timeout"),
        _token = Depends(require_admin_token)
    ):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–æ–µ–≤ —Å –æ—à–∏–±–∫–∞–º–∏"""
        from app.database import BattleDatabase
        
        db = BattleDatabase()
        
        if error_type == "all":
            query = """
                SELECT battle_id, requested_at, status, error_message
                FROM xml_sync_log
                WHERE status IN ('failed', 'response_timeout')
                ORDER BY battle_id
                LIMIT $1
            """
            rows = await db._execute_query(query, limit)
        else:
            query = """
                SELECT battle_id, requested_at, status, error_message
                FROM xml_sync_log
                WHERE status = $1
                ORDER BY battle_id
                LIMIT $2
            """
            rows = await db._execute_query(query, error_type, limit)
        
        await db.disconnect()
        
        return {
            "count": len(rows),
            "error_type": error_type,
            "battles": [
                {
                    "battle_id": row['battle_id'],
                    "requested_at": row['requested_at'].isoformat() if row['requested_at'] else None,
                    "status": row['status'],
                    "error_message": row['error_message']
                }
                for row in rows
            ]
        }
    
    @router.post("/admin/xml-sync/retry-failed")
    async def xml_sync_retry_failed(
        limit: int = Query(100, ge=1, le=500, description="–°–∫–æ–ª—å–∫–æ –±–æ–µ–≤ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–æ–∫–∞—á–∞—Ç—å"),
        workers: int = Query(1, ge=1, le=5, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤"),
        _token = Depends(require_admin_token)
    ):
        """–î–æ–∫–∞—á–∞—Ç—å –±–æ–∏ —Å –æ—à–∏–±–∫–∞–º–∏ (failed, response_timeout)"""
        from app.xml_sync_worker import XmlSyncWorker
        
        worker = XmlSyncWorker()
        result = await worker.sync_missing(limit=limit)
        
        return result
    
    @router.post("/admin/xml-sync/auto-continue")
    async def xml_sync_auto_continue(
        batch_size: int = Query(1000, ge=1, le=1000, description="–†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏"),
        workers: int = Query(1, ge=1, le=5, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤"),
        _token = Depends(require_admin_token)
    ):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –±–æ—è"""
        from app.xml_sync_worker import XmlSyncWorker
        
        worker = XmlSyncWorker()
        result = await worker.sync_auto_continue(batch_size=batch_size)
        
        return result

    @router.post(
        "/admin/xml-sync/fetch-new",
        summary="–£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤",
        description="""
        –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ù–û–í–´–• –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ + –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥.
        
        **–ê–ª–≥–æ—Ä–∏—Ç–º:**
        1. –ù–∞—Ö–æ–¥–∏—Ç MAX(battle_id) –∏–∑ —É—Å–ø–µ—à–Ω—ã—Ö –≤ xml_sync_log
        2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç count –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ 6 XML –≤–æ—Ä–∫–µ—Ä–æ–≤ (–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –µ—Å–ª–∏ count=None)
        3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è failed/timeout –ª–æ–≥–æ–≤
        4. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ api_mother —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏
        
        **–ü—Ä–∏–º–µ—Ä—ã:**
        - `count=300` - –∑–∞–≥—Ä—É–∑–∏—Ç—å 300 —Å–ª–µ–¥—É—é—â–∏—Ö –ª–æ–≥–æ–≤
        - `count=None` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ –¥–æ battle_id=3780000
        - `auto_parse=true` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤ –ë–î
        - `max_parallel=10` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1-3)
        
        **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ~10 –ª–æ–≥–æ–≤/—Å–µ–∫, 300 –ª–æ–≥–æ–≤ –∑–∞ ~20-30 —Å–µ–∫—É–Ω–¥
        """,
        tags=["Admin - XML Sync"],
        responses={
            200: {"description": "–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"},
            403: {"description": "–ù–µ–≤–µ—Ä–Ω—ã–π admin token"}
        }
    )
    async def xml_sync_fetch_new(
        count: Optional[int] = Query(None, ge=1, le=10000, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ (None=–≤—Å–µ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ)"),
        auto_parse: bool = Query(True, description="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å"),
        max_parallel: int = Query(10, ge=1, le=20, description="–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞"),
        _token = Depends(require_admin_token)
    ):
        """
        –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ù–û–í–´–• –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ + –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ù–∞—Ö–æ–¥–∏—Ç MAX(battle_id) –∏–∑ —É—Å–ø–µ—à–Ω—ã—Ö
        2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç count –ª–æ–≥–æ–≤ (–∏–ª–∏ –≤—Å–µ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –µ—Å–ª–∏ count=None)
        3. Retry –¥–ª—è failed/timeout
        4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç —á–µ—Ä–µ–∑ api_mother
        """
        import httpx
        from app.xml_sync_worker import XmlSyncWorker
        
        worker = XmlSyncWorker()
        await worker._init_db()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –ª–æ–≥
        query = "SELECT MAX(battle_id) as max_id FROM xml_sync_log WHERE status = 'success'"
        result = await worker.db._execute_query(query)
        
        if not result or result[0]['max_id'] is None:
            start_id = 3772607
        else:
            start_id = result[0]['max_id'] + 1
        
        # –ï—Å–ª–∏ count –Ω–µ —É–∫–∞–∑–∞–Ω - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ (3772606 + –Ω–æ–≤—ã–µ)
        if count is None:
            end_id = 3780000  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å –∑–∞–ø–∞—Å–æ–º
        else:
            end_id = start_id + count - 1
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ XML sync
        sync_result = await worker.sync_range(start_id, end_id, skip_existing=False)
        
        # Retry –¥–ª—è failed/timeout
        retry_count = 0
        if sync_result.get('failed', 0) > 0 or sync_result.get('timeout', 0) > 0:
            retry_result = await worker.sync_missing()
            retry_count = retry_result.get('total_synced', 0)
        
        # –ê–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥
        parsed_count = 0
        if auto_parse and sync_result.get('success', 0) > 0:
            try:
                async with httpx.AsyncClient(timeout=300.0) as client:
                    response = await client.post(
                        "http://api_mother:8083/process-batch",
                        params={"limit": count + 100, "max_parallel": max_parallel}
                    )
                    if response.status_code == 200:
                        parse_result = response.json()
                        parsed_count = parse_result.get('processed', 0)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
        
        return {
            "range": {"start": start_id, "end": end_id},
            "downloaded": sync_result.get('success', 0),
            "failed": sync_result.get('failed', 0),
            "timeout": sync_result.get('timeout', 0),
            "retried": retry_count,
            "parsed": parsed_count
        }

    @router.post(
        "/admin/xml-sync/fetch-old",
        summary="–£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤",
        description="""
        –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –°–¢–ê–†–´–• –ª–æ–≥–æ–≤ –¥–æ —Å–∞–º–æ–≥–æ —Ä–∞–Ω–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ + –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥.
        
        **–ê–ª–≥–æ—Ä–∏—Ç–º:**
        1. –ù–∞—Ö–æ–¥–∏—Ç MIN(battle_id) –∏–∑ —É—Å–ø–µ—à–Ω—ã—Ö –≤ xml_sync_log
        2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç count —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ 6 XML –≤–æ—Ä–∫–µ—Ä–æ–≤ (–∏–ª–∏ –≤—Å–µ –¥–æ battle_id=1475356 –µ—Å–ª–∏ count=None)
        3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è failed/timeout –ª–æ–≥–æ–≤
        4. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ api_mother —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏
        
        **–ü—Ä–∏–º–µ—Ä—ã:**
        - `count=300` - –∑–∞–≥—Ä—É–∑–∏—Ç—å 300 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ª–æ–≥–æ–≤
        - `count=None` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –¥–æ battle_id=1475356
        - `auto_parse=true` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤ –ë–î
        - `max_parallel=10` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1-3)
        
        **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ~10 –ª–æ–≥–æ–≤/—Å–µ–∫, 300 –ª–æ–≥–æ–≤ –∑–∞ ~20-30 —Å–µ–∫—É–Ω–¥
        """,
        tags=["Admin - XML Sync"],
        responses={
            200: {"description": "–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"},
            400: {"description": "–ù–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö –ª–æ–≥–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏"},
            403: {"description": "–ù–µ–≤–µ—Ä–Ω—ã–π admin token"}
        }
    )
    async def xml_sync_fetch_old(
        count: Optional[int] = Query(None, ge=1, le=10000, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ (None=–≤—Å–µ –¥–æ –ø–µ—Ä–≤–æ–≥–æ)"),
        auto_parse: bool = Query(True, description="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å"),
        max_parallel: int = Query(10, ge=1, le=20, description="–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞"),
        _token = Depends(require_admin_token)
    ):
        """
        –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –°–¢–ê–†–´–• –ª–æ–≥–æ–≤ –¥–æ —Å–∞–º–æ–≥–æ —Ä–∞–Ω–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ + –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ù–∞—Ö–æ–¥–∏—Ç MIN(battle_id) –∏–∑ —É—Å–ø–µ—à–Ω—ã—Ö
        2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç count –ª–æ–≥–æ–≤ (–∏–ª–∏ –≤—Å–µ –¥–æ battle_id=1 –µ—Å–ª–∏ count=None)
        3. Retry –¥–ª—è failed/timeout
        4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç —á–µ—Ä–µ–∑ api_mother
        """
        import httpx
        from app.xml_sync_worker import XmlSyncWorker
        
        worker = XmlSyncWorker()
        await worker._init_db()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∞–º—ã–π —Ä–∞–Ω–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –ª–æ–≥
        query = "SELECT MIN(battle_id) as min_id FROM xml_sync_log WHERE status = 'success'"
        result = await worker.db._execute_query(query)
        
        if not result or result[0]['min_id'] is None:
            raise HTTPException(
                status_code=400,
                detail="–ù–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö –ª–æ–≥–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /fetch-new"
            )
        
        min_id = result[0]['min_id']
        end_id = min_id - 1
        
        # –ï—Å–ª–∏ count –Ω–µ —É–∫–∞–∑–∞–Ω - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ—Ç 1 –¥–æ min_id
        if count is None:
            start_id = max(1, 1475356)  # –°–∞–º—ã–π —Ä–∞–Ω–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –±–æ–π
        else:
            start_id = max(1, end_id - count + 1)
        
        if start_id > end_id:
            raise HTTPException(
                status_code=400,
                detail=f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π ID —É–∂–µ {min_id}"
            )
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ XML sync
        sync_result = await worker.sync_range(start_id, end_id, skip_existing=False)
        
        # Retry –¥–ª—è failed/timeout
        retry_count = 0
        if sync_result.get('failed', 0) > 0 or sync_result.get('timeout', 0) > 0:
            retry_result = await worker.sync_missing()
            retry_count = retry_result.get('total_synced', 0)
        
        # –ê–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥
        parsed_count = 0
        if auto_parse and sync_result.get('success', 0) > 0:
            try:
                async with httpx.AsyncClient(timeout=300.0) as client:
                    response = await client.post(
                        "http://api_mother:8083/process-batch",
                        params={"limit": count + 100, "max_parallel": max_parallel}
                    )
                    if response.status_code == 200:
                        parse_result = response.json()
                        parsed_count = parse_result.get('processed', 0)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
        
        return {
            "range": {"start": start_id, "end": end_id},
            "downloaded": sync_result.get('success', 0),
            "failed": sync_result.get('failed', 0),
            "timeout": sync_result.get('timeout', 0),
            "retried": retry_count,
            "parsed": parsed_count
        }

    @router.post("/admin/ml/train-playstyle")
    async def admin_train_playstyle(
        days: int = Query(90, ge=30, le=365),
        _token = Depends(require_admin_token)
    ):
        """–û–±—É—á–µ–Ω–∏–µ K-means –º–æ–¥–µ–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç–∏–ª–µ–π (—Ç—Ä–µ–±—É–µ—Ç admin token)"""
        try:
            from app.ml.playstyle_classifier import train_playstyle_model, SKLEARN_AVAILABLE
        except ImportError:
            raise HTTPException(status_code=501, detail="ML –º–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        if not SKLEARN_AVAILABLE:
            raise HTTPException(status_code=501, detail="scikit-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        db = BattleDatabase()
        result = await train_playstyle_model(db, days=days)
        await db.disconnect()
        
        if result.get("status") == "error":
            raise HTTPException(status_code=500, detail=result.get("error"))
        
        return result
    
    @router.post("/admin/ml/train-botdetector")
    async def admin_train_botdetector(
        days: int = Query(90, ge=30, le=365),
        _token = Depends(require_admin_token)
    ):
        """–û–±—É—á–µ–Ω–∏–µ Voting Ensemble (K-means + Isolation Forest) –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –±–æ—Ç–æ–≤"""
        try:
            from app.ml.bot_detector import train_bot_detector, SKLEARN_AVAILABLE
        except ImportError:
            raise HTTPException(status_code=501, detail="BotDetector –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        if not SKLEARN_AVAILABLE:
            raise HTTPException(status_code=501, detail="scikit-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        db = BattleDatabase()
        result = await train_bot_detector(db, days=days)
        await db.disconnect()
        
        if result.get("status") == "error":
            raise HTTPException(status_code=500, detail=result.get("error"))
        
        return result

    return router


