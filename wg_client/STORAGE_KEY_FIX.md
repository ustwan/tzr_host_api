# üêõ –ü–†–û–ë–õ–ï–ú–ê: storage_key = /tmp/tmpXXX.tzb

## ‚ùå –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫:

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–æ—è 3697692 –≤–∏–¥–∏–º:
```
Storage Key: /tmp/tmpd582cooc.tzb
SHA256: c4bad21f8208ef102c0f84abac6b8ca7a455c376900d0c7acb9caf47edd3bae4
Compressed: ‚ùå –ù–µ—Ç
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `storage_key` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ **–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª** –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ –≤ `/srv/btl/raw`.

---

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:

**–§–∞–π–ª:** `api_4/app/interfaces/http/routes.py`, —ç–Ω–¥–ø–æ–∏–Ω—Ç `/battles/upload`

**–°—Ç–∞—Ä—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 868-875):**
```python
with tempfile.NamedTemporaryFile(suffix='.tzb', delete=False) as tmp_file:
    tmp_file.write(decompressed_content)
    tmp_path = tmp_file.name  # ‚Üê /tmp/tmpd582cooc.tzb

# ...

result = await loader.process_file(tmp_path)  # ‚Üê –ü–µ—Ä–µ–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—É—Ç—å –ø–∞—Ä—Å–µ—Ä—É
os.unlink(tmp_path)  # ‚Üê –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
1. ‚úÖ –§–∞–π–ª –ø–∞—Ä—Å–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
2. ‚úÖ –ü–æ–ø–∞–¥–∞–µ—Ç –≤ –ë–î
3. ‚ùå `storage_key` = `/tmp/tmpXXX.tzb` (–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—É—Ç—å)
4. ‚ùå –§–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
5. ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å `/battle/{id}/raw` (—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
# 1. –ò–∑–≤–ª–µ–∫–∞–µ–º battle_id –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
base_name = file.filename.replace('.tzb.gz', '').replace('.tzb', '')
battle_id = int(base_name.split('/')[-1])

# 2. –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É /srv/btl/raw/{shard}/{battle_id}.tzb
shard = battle_id // 50000
shard_dir = Path('/srv/btl/raw') / str(shard)
shard_dir.mkdir(parents=True, exist_ok=True)

final_path = shard_dir / f"{battle_id}.tzb"

# 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
with open(final_path, 'wb') as f:
    f.write(decompressed_content)

# 4. –ü–µ—Ä–µ–¥–∞—ë–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—É—Ç—å –ø–∞—Ä—Å–µ—Ä—É
result = await loader.process_file(str(final_path))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ `storage_key` = `/srv/btl/raw/75/3697692.tzb` (—Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å)
- ‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –§–∞–π–ª –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è
- ‚úÖ `/battle/{id}/raw` —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### 1. Round-robin —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞—Ç—á–µ–π
**–§–∞–π–ª:** `api_4/app/xml_worker_client.py`

**–ë—ã–ª–æ:** –ë–∞—Ç—á–∏ —à–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ –≤–æ—Ä–∫–µ—Ä–∞–º ‚Üí —Ç–æ–ª—å–∫–æ Worker 1-2 —Ä–∞–±–æ—Ç–∞–ª–∏  
**–°—Ç–∞–ª–æ:** –ë–∞—Ç—á–∏ —á–µ—Ä–µ–¥—É—é—Ç—Å—è ‚Üí –≤—Å–µ 6 –≤–æ—Ä–∫–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### 2. –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç count
**–§–∞–π–ª:** `api_4/app/interfaces/http/routes.py`

**–ë—ã–ª–æ:** `count: ... le=10000`  
**–°—Ç–∞–ª–æ:** `count: ... le=1000000`

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:

```bash
cd /Users/ii/Documents/code/WG_HUB/wg_client
chmod +x rebuild_api4_fix.sh
./rebuild_api4_fix.sh
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏:

```bash
# 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—ë–≤
curl -X POST 'http://localhost:8084/admin/xml-sync/fetch-old?count=10&from_battle_id=3770000'

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å storage_key
curl -s 'http://localhost:8084/battle/3770000' | jq '{battle_id, storage_key, sha256}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "battle_id": 1234,
  "storage_key": "/srv/btl/raw/75/3770000.tzb",  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å!
  "sha256": "..."
}
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```json
{
  "storage_key": "/tmp/tmpXXXXXX.tzb"  ‚ùå –í—Ä–µ–º–µ–Ω–Ω—ã–π –ø—É—Ç—å
}
```

---

## üìù –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:

1. ‚úÖ `api_4/app/interfaces/http/routes.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `/battles/upload`
2. ‚úÖ `api_4/app/xml_worker_client.py` - round-robin —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
3. ‚úÖ `rebuild_api4_fix.sh` - —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏

---

## ‚ú® –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

‚úÖ –í—Å–µ –±–æ–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `/srv/btl/raw/{shard}/{battle_id}.tzb`  
‚úÖ `storage_key` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π  
‚úÖ –í—Å–µ 6 –≤–æ—Ä–∫–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ  
‚úÖ –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–æ 1,000,000 –±–æ—ë–≤ –∑–∞ —Ä–∞–∑  
‚úÖ `/battle/{id}/raw` —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ì–æ—Ç–æ–≤–æ –∫ production!** üéâ





