<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG_HUB ‚Äî –î–µ—Ç–∞–ª–∏ –±–æ—è</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .header {
      background: rgba(28, 28, 30, 0.8);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-md);
    }

    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5em;
      color: var(--text-primary);
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .btn-home {
      padding: 8px 16px;
      background: rgba(58, 58, 60, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      text-decoration: none;
      font-size: 13px;
      transition: var(--transition-fast);
    }

    .btn-home:hover {
      background: rgba(58, 58, 60, 0.6);
      border-color: var(--border-light);
      transform: scale(1.02);
    }

    main {
      flex: 1;
      padding: 32px 0;
    }

    .battle-header-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .battle-title {
      font-size: 2em;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .battle-meta {
      display: flex;
      gap: 24px;
      color: var(--text-muted);
      font-size: 14px;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .section-title {
      font-size: 1.25em;
      font-weight: 700;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: var(--bg-hover);
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      border-bottom: 2px solid var(--border);
    }

    td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--bg-hover);
    }

    .timeline {
      position: relative;
      padding-left: 40px;
    }

    .timeline-item {
      position: relative;
      padding: 12px 0;
      border-left: 2px solid var(--border);
      padding-left: 24px;
      margin-bottom: 12px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 16px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-blue);
      border: 2px solid var(--bg-primary);
    }

    .timeline-turn {
      font-weight: 700;
      color: var(--accent-blue);
      margin-bottom: 4px;
    }

    .timeline-event {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    .player-link {
      color: var(--accent-blue);
      cursor: pointer;
      text-decoration: none;
    }

    .player-link:hover {
      text-decoration: underline;
    }

    /* Hex Map Styles */
    .map-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .map-viewport {
      position: relative;
      width: 100%;
      height: 600px;
      background: #1a1a1a;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .map-container {
      display: inline-block;
      background: transparent;
      position: relative;
      transform-origin: center center;
    }

    .hex-grid {
      position: relative;
      width: 1800px;
      height: 532px;
      margin: 0 auto;
      background: #2a2a2a;
    }

    .hex { 
      position: absolute; 
      width: 36px; 
      height: 19px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 8px; 
      font-weight: bold; 
      color: #fff; 
      background: transparent !important; 
    }

    .hex::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: #000; 
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); 
      z-index: 1; 
    }

    .hex::after { 
      content: ''; 
      position: absolute; 
      top: 1px; 
      left: 1px; 
      right: 1px; 
      bottom: 1px; 
      background: inherit; 
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); 
      z-index: 2; 
    }

    .hex.has-sprite::after { background: transparent; }
    .hex.passable::after { background: #2ECC71; }
    .hex.impassable::after { background: #E74C3C; }
    .hex.exit::after { background: #FFD700; }
    .hex.wall::after { background: #3498DB; }

    .hex-sprite {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }

    .map-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .map-controls .btn {
      padding: 8px 16px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1 id="page-title">–î–µ—Ç–∞–ª–∏ –±–æ—è</h1>
      <a href="javascript:history.back()" class="btn-home">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
  </div>

  <main>
    <div class="container" id="content">
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
    </div>
  </main>

  <div id="error-container"></div>
  <div id="loading-container" class="loading-container flex-center">
    <div class="loading-spinner"></div>
  </div>

  <script src="/assets/js/api-client.js"></script>
  <script src="/assets/js/hex_map.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const battleId = urlParams.get('battle_id');

    if (!battleId) {
      document.getElementById('content').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>–ù–µ —É–∫–∞–∑–∞–Ω battle_id</p>
        </div>
      `;
    } else {
      loadBattleDetails(battleId);
    }

    async function loadBattleDetails(battleId) {
      console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –±–æ—è:', battleId);
      showLoading();
      
      try {
        console.log('üì° API –∑–∞–ø—Ä–æ—Å: /battle/' + battleId);
        const result = await api.client.get(`/battle/${battleId}`);
        console.log('üìä –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API:', result);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
        let battle = null;
        if (result && result.success && result.data) {
          battle = result.data;
        } else if (result && result.id) {
          battle = result;
        } else if (result && result.battle) {
          battle = result.battle;
        } else {
          console.error('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', result);
          throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–æ—è:', battle);
        
        if (!battle || battle.detail || !battle.id) {
          throw new Error(battle?.detail || '–ë–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        console.log('üé® –í—ã–∑–æ–≤ renderBattleDetails...');
        renderBattleDetails(battle);
        console.log('‚úÖ renderBattleDetails –∑–∞–≤–µ—Ä—à–µ–Ω');

      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—è:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>${error.message}</p>
            <p style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p>
            <button class="btn" onclick="window.location.href='/battle-search.html'" style="margin-top: 16px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∏—Å–∫—É</button>
          </div>
        `;
      } finally {
        console.log('üèÅ –°–∫—Ä—ã—Ç–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏...');
        hideLoading();
        console.log('‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä—ã—Ç');
      }
    }

    function renderBattleDetails(battle) {
      try {
        console.log('üé® –ù–∞—á–∞–ª–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–µ—Ç–∞–ª–µ–π –±–æ—è:', battle.id);
        document.getElementById('page-title').textContent = `–ë–æ–π #${battle.id}`;
        
        const startDate = battle.start_ts ? new Date(battle.start_ts).toLocaleString('ru-RU') : '‚Äî';
        
        // –ü–∞—Ä—Å–∏–º JSON –∏–∑ data
        let battleData = null;
        try {
          if (typeof battle.data === 'string') {
            console.log('üìù –ü–∞—Ä—Å–∏–Ω–≥ battle.data –∏–∑ —Å—Ç—Ä–æ–∫–∏...');
            battleData = JSON.parse(battle.data);
          } else if (typeof battle.data === 'object' && battle.data !== null) {
            console.log('üìù battle.data —É–∂–µ –æ–±—ä–µ–∫—Ç');
            battleData = battle.data;
          }
          console.log('‚úÖ battleData —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω:', battleData ? 'OK' : 'NULL');
          if (battleData) {
            console.log('üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ battleData:', Object.keys(battleData));
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ battle.data:', e);
        }

        // ‚úÖ –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–æ—è
        const actualPlayersCnt = battleData?.participants?.length || battle.players_cnt || 0;
        
        // ‚úÖ –î–ª—è –º–æ–Ω—Å—Ç—Ä–æ–≤ —Å—É–º–º–∏—Ä—É–µ–º count –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ .length)
        let actualMonstersCnt = 0;
        if (battleData?.monsters && Array.isArray(battleData.monsters)) {
          actualMonstersCnt = battleData.monsters.reduce((sum, m) => sum + (m.count || 0), 0);
        } else {
          actualMonstersCnt = battle.monsters_cnt || 0;
        }
        
        console.log(`üìä –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –∏–≥—Ä–æ–∫–æ–≤=${actualPlayersCnt}, —Ç–∏–ø–æ–≤ –º–æ–Ω—Å—Ç—Ä–æ–≤=${battleData?.monsters?.length || 0}, –≤—Å–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–æ–≤=${actualMonstersCnt}`);
        
      document.getElementById('content').innerHTML = `
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–æ—è -->
        <div class="battle-header-card">
          <div class="battle-title">–ë–æ–π #${battle.id}</div>
          <div class="battle-meta">
            <span>üìÖ ${startDate}</span>
            <span>üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: (${battle.loc_x}, ${battle.loc_y})</span>
            <span>üéÆ –¢–∏–ø: ${battle.battle_type || '‚Äî'}</span>
            <span>‚è±Ô∏è –•–æ–¥–æ–≤: ${battle.turns || 0}</span>
            <span>üë• –ò–≥—Ä–æ–∫–æ–≤: ${actualPlayersCnt}</span>
            <span>üëæ –ú–æ–Ω—Å—Ç—Ä–æ–≤: ${actualMonstersCnt}</span>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Source ID</div>
            <div class="stat-value">${battle.source_id || '‚Äî'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Entities</div>
            <div class="stat-value">${battle.entities_cnt || 0}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Map Patch</div>
            <div class="stat-value">${battle.map_patch ? '–î–∞' : '‚Äî'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Size</div>
            <div class="stat-value">${formatBytes(battle.size_bytes || 0)}</div>
          </div>
        </div>

        ${(() => { try { return renderBattleMap(battle, battleData); } catch (e) { console.error('‚ùå –û—à–∏–±–∫–∞ renderBattleMap:', e); return ''; } })()}
        ${(() => { try { return renderMonsters(battleData); } catch (e) { console.error('‚ùå –û—à–∏–±–∫–∞ renderMonsters:', e); return '<div class="section"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–Ω—Å—Ç—Ä–æ–≤</p></div>'; } })()}
        ${(() => { try { return renderParticipants(battleData); } catch (e) { console.error('‚ùå –û—à–∏–±–∫–∞ renderParticipants:', e); return '<div class="section"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>'; } })()}
        ${(() => { try { return renderLoot(battleData); } catch (e) { console.error('‚ùå –û—à–∏–±–∫–∞ renderLoot:', e); return ''; } })()}
        ${(() => { try { return renderDataInfo(battle); } catch (e) { console.error('‚ùå –û—à–∏–±–∫–∞ renderDataInfo:', e); return ''; } })()}
      `;
      
      console.log('‚úÖ HTML –∫–æ–Ω—Ç–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
      setTimeout(() => {
        initBattleMap(battle, battleData).catch(err => {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É:', err);
        });
      }, 100);
      
      console.log('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–µ—Ç–∞–ª–µ–π –±–æ—è –∑–∞–≤–µ—Ä—à–µ–Ω');
      
      } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ renderBattleDetails:', error);
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ—è</h3>
            <p>${error.message}</p>
            <p style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π</p>
            <button class="btn" onclick="window.location.href='/battle-search.html'" style="margin-top: 16px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∏—Å–∫—É</button>
          </div>
        `;
        throw error; // Re-throw —á—Ç–æ–±—ã hideLoading() —Å—Ä–∞–±–æ—Ç–∞–ª –≤ –æ—Å–Ω–æ–≤–Ω–æ–º try-catch
      }
    }

    function renderBattleMap(battle, battleData) {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç map_patch
      if (!battle.map_patch) {
        return '';
      }

      return `
        <div class="map-section">
          <div class="section-title">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –±–æ—è</div>
          <div class="map-controls">
            <button class="btn btn-sm" id="btn-zoom-in">üîç + –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å</button>
            <button class="btn btn-sm" id="btn-zoom-out">üîç - –û—Ç–¥–∞–ª–∏—Ç—å</button>
            <button class="btn btn-sm" id="btn-reset-zoom">‚åÇ –°–±—Ä–æ—Å</button>
            <button class="btn btn-sm" id="btn-toggle-labels">üè∑Ô∏è –ú–µ—Ç–∫–∏</button>
          </div>
          <div class="map-viewport">
            <div class="map-container" id="map-container">
              <div class="hex-grid" id="hex-grid"></div>
            </div>
          </div>
        </div>
      `;
    }

    // hexMap –æ–±—ä—è–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ hex_map.js
    let mapScale = 1;

    async function initBattleMap(battle, battleData) {
      console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –±–æ—è...', { battle, battleData });
      
      const mapSection = document.querySelector('.map-section');
      
      if (!battle.map_patch) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã (map_patch)');
        if (mapSection) {
          mapSection.innerHTML = '<div class="empty-state"><p>–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ –±–æ—è</p></div>';
        }
        return;
      }

      try {
        console.log('üéÆ –ü—Ä–æ–≤–µ—Ä–∫–∞ hexMap...');
        if (typeof hexMap === 'undefined' || !hexMap) {
          throw new Error('hexMap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è hexMap
        console.log('üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è hexMap...');
        hexMap.setAssetsConfig({
          spritesBasePath: '/bmap/sprites/',
          tilesBasePath: '/bmap/images/',
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º token sprite map
        console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ token sprite map...');
        await hexMap.loadTokenSpriteMap('/bmap/token_sprite_map.json');
        
        console.log('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è hexMap...');
        hexMap.init();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π XML —Ñ–∞–π–ª –±–æ—è —á–µ—Ä–µ–∑ /battle/{id}/raw
        console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ raw XML –¥–ª—è –±–æ—è ${battle.source_id}...`);
        const rawResponse = await fetch(`/api/battle/${battle.source_id}/raw`);
        
        if (!rawResponse.ok) {
          throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å XML: HTTP ${rawResponse.status}`);
        }
        
        const xmlContent = await rawResponse.text();
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω XML, —Ä–∞–∑–º–µ—Ä: ${xmlContent.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        console.log('üìù –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ XML:', xmlContent.substring(0, 500));

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏–∑ –ø–æ–ª–Ω–æ–≥–æ XML
        console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã –∏–∑ XML...');
        await hexMap.loadMapData(xmlContent);
        console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
        console.log('üéÆ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –∫–∞—Ä—Ç—ã...');
        setupMapControls();
        console.log('‚úÖ –ö–∞—Ä—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!');

      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        if (mapSection) {
          // –ü–∞—Ä—Å–∏–º map_patch –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
          let mapPatch = battle.map_patch;
          if (typeof mapPatch === 'string') {
            try { mapPatch = JSON.parse(mapPatch); } catch (e) {}
          }
          
          mapSection.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üó∫Ô∏è</div>
              <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ</h3>
              <div style="text-align: left; margin-top: 20px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <p style="margin: 8px 0;"><strong>ID –∫–∞—Ä—Ç—ã:</strong> ${mapPatch?.i || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                <p style="margin: 8px 0;"><strong>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞:</strong> ${mapPatch?.cs || '–Ω–µ—Ç'}</p>
                <p style="margin: 8px 0;"><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> (${battle.loc_x}, ${battle.loc_y})</p>
                ${battle.storage_key ? `<p style="margin: 8px 0;"><strong>–§–∞–π–ª:</strong> ${battle.storage_key}</p>` : ''}
              </div>
              <p style="margin-top: 16px; color: var(--text-muted); font-size: 13px;">
                ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ${error.message}
              </p>
            </div>
          `;
        }
      }
    }

    function setupMapControls() {
      const container = document.getElementById('map-container');
      if (!container) return;

      document.getElementById('btn-zoom-in')?.addEventListener('click', () => {
        mapScale = Math.min(mapScale * 1.2, 3);
        container.style.transform = `scale(${mapScale})`;
      });

      document.getElementById('btn-zoom-out')?.addEventListener('click', () => {
        mapScale = Math.max(mapScale / 1.2, 0.3);
        container.style.transform = `scale(${mapScale})`;
      });

      document.getElementById('btn-reset-zoom')?.addEventListener('click', () => {
        mapScale = 1;
        container.style.transform = `scale(${mapScale})`;
      });

      document.getElementById('btn-toggle-labels')?.addEventListener('click', () => {
        const grid = document.getElementById('hex-grid');
        if (grid) {
          grid.classList.toggle('hide-labels');
        }
      });

      // Pan/drag support
      let isPanning = false;
      let startX, startY, translateX = 0, translateY = 0;

      container.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isPanning = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        container.style.cursor = 'grabbing';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        container.style.transform = `scale(${mapScale}) translate(${translateX}px, ${translateY}px)`;
      });

      document.addEventListener('mouseup', () => {
        if (isPanning) {
          isPanning = false;
          container.style.cursor = 'grab';
        }
      });

      container.style.cursor = 'grab';
    }

    function renderMonsters(battleData) {
      console.log('üêõ renderMonsters –≤—ã–∑–≤–∞–Ω, battleData:', battleData);
      if (!battleData) {
        console.warn('‚ö†Ô∏è battleData is null/undefined');
        return '';
      }
      if (!battleData.monsters) {
        console.warn('‚ö†Ô∏è battleData.monsters –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, keys:', Object.keys(battleData));
        return '';
      }
      if (battleData.monsters.length === 0) {
        console.log('‚ÑπÔ∏è battleData.monsters –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤');
        return '';
      }
      console.log('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–æ–Ω—Å—Ç—Ä–æ–≤, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤:', battleData.monsters.length);

      const monsterNames = {
        'zmb': '–ó–æ–º–±–∏',
        'erg': '–≠—Ä–≥',
        'dog': '–°–æ–±–∞–∫–∞',
        'rat': '–ö—Ä—ã—Å–∞',
        'spider': '–ü–∞—É–∫'
      };

      const specNames = {
        'spec': '–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π',
        'elite': '–≠–ª–∏—Ç–∞',
        'boss': '–ë–æ—Å—Å',
        'common': '–û–±—ã—á–Ω—ã–π',
        'rat_spec': '–ö—Ä—ã—Å–∞ (—Å–ø–µ—Ü)',
        'zmb_spec': '–ó–æ–º–±–∏ (—Å–ø–µ—Ü)',
        'erg_spec': '–≠—Ä–≥ (—Å–ø–µ—Ü)',
        'dog_spec': '–°–æ–±–∞–∫–∞ (—Å–ø–µ—Ü)',
        'spider_spec': '–ü–∞—É–∫ (—Å–ø–µ—Ü)'
      };

      return `
        <div class="section">
          <div class="section-title">üëæ –ú–æ–Ω—Å—Ç—Ä—ã (${battleData.monsters.length} —Ç–∏–ø–æ–≤)</div>
          <table>
            <thead>
              <tr>
                <th>–¢–∏–ø</th>
                <th>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th>–£—Ä–æ–≤–µ–Ω—å</th>
              </tr>
            </thead>
            <tbody>
              ${battleData.monsters.map(m => `
                <tr>
                  <td><strong>${monsterNames[m.kind] || m.kind}</strong></td>
                  <td>${m.spec ? specNames[m.spec] || m.spec : '‚Äî'}</td>
                  <td>${m.count}</td>
                  <td>${m.min_level} - ${m.max_level}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderParticipants(battleData) {
      console.log('üêõ renderParticipants –≤—ã–∑–≤–∞–Ω, battleData:', battleData);
      if (!battleData) {
        console.warn('‚ö†Ô∏è battleData is null/undefined');
        return '<div class="section"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–æ–∫–∞—Ö</p></div>';
      }
      if (!battleData.participants) {
        console.warn('‚ö†Ô∏è battleData.participants –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, keys:', Object.keys(battleData));
        return '<div class="section"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–æ–∫–∞—Ö</p></div>';
      }
      if (battleData.participants.length === 0) {
        console.log('‚ÑπÔ∏è battleData.participants –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤');
        return '<div class="section"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–æ–∫–∞—Ö</p></div>';
      }
      console.log('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', battleData.participants.length);

      return `
        <div class="section">
          <div class="section-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (${battleData.participants.length})</div>
          <table>
            <thead>
              <tr>
                <th>–ò–≥—Ä–æ–∫</th>
                <th>–£—Ä–æ–≤–µ–Ω—å</th>
                <th>–£–±–∏–π—Å—Ç–≤</th>
                <th>–£—Ä–æ–Ω –º–æ–Ω—Å—Ç—Ä–∞–º</th>
                <th>–ö—Ä–∏—Ç —É—Ä–æ–Ω</th>
                <th>PvE Points</th>
                <th>–í—ã–∂–∏–ª</th>
              </tr>
            </thead>
            <tbody>
              ${battleData.participants.map(p => `
                <tr>
                  <td>
                    <a href="/players.html?search=${encodeURIComponent(p.login)}" 
                       class="player-link" 
                       target="_blank">
                      ${p.login}
                    </a>
                    ${p.clan ? `<br><span style="font-size: 11px; color: var(--text-muted);">[${p.clan}]</span>` : ''}
                    <br><button class="btn btn-sm" onclick="loadPlayerHistory('${p.login}')" style="margin-top: 4px; font-size: 11px;">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
                  </td>
                  <td>${p.level || '‚Äî'}</td>
                  <td>
                    ${p.kills ? `
                      üëæ ${p.kills.monsters || 0}<br>
                      üë§ ${p.kills.players || 0}
                    ` : '‚Äî'}
                  </td>
                  <td>${p.damage_total?.monsters?.HP ? formatNumber(p.damage_total.monsters.HP) : '‚Äî'}</td>
                  <td>${p.damage_total?.monsters?.critical ? formatNumber(p.damage_total.monsters.critical) : '‚Äî'}</td>
                  <td>${p.pve_points ? formatNumber(p.pve_points) : '‚Äî'}</td>
                  <td>${p.survived ? '‚úÖ' : '‚ùå'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä–æ–∫–∞ -->
          <div id="player-history-container" style="margin-top: 20px;"></div>
        </div>
      `;
    }

    function renderLoot(battleData) {
      console.log('üêõ renderLoot –≤—ã–∑–≤–∞–Ω, battleData:', battleData);
      if (!battleData) {
        console.warn('‚ö†Ô∏è battleData is null/undefined');
        return '';
      }
      if (!battleData.loot_total) {
        console.warn('‚ö†Ô∏è battleData.loot_total –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, keys:', Object.keys(battleData));
        return '';
      }

      const loot = battleData.loot_total;
      console.log('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–æ–±—ã—á–∏, loot:', loot);
      const hasLoot = (loot.resources && loot.resources.length > 0) || 
                      (loot.monster_parts && loot.monster_parts.length > 0) ||
                      (loot.other && loot.other.length > 0);

      if (!hasLoot) return '';

      return `
        <div class="section">
          <div class="section-title">üí∞ –î–æ–±—ã—á–∞</div>
          <div style="display: grid; gap: 12px;">
            ${loot.resources && loot.resources.length > 0 ? `
              <div>
                <strong>–†–µ—Å—É—Ä—Å—ã:</strong>
                <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                  ${loot.resources.map(r => `
                    <span class="badge">${r.name}: ${r.qty}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            ${loot.monster_parts && loot.monster_parts.length > 0 ? `
              <div>
                <strong>–ß–∞—Å—Ç–∏ –º–æ–Ω—Å—Ç—Ä–æ–≤:</strong>
                <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                  ${loot.monster_parts.map(p => `
                    <span class="badge">${p.name}: ${p.qty}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            ${loot.other && loot.other.length > 0 ? `
              <div>
                <strong>–î—Ä—É–≥–æ–µ:</strong>
                <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                  ${loot.other.map(o => `
                    <span class="badge">${o.name}: ${o.qty}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }


    function renderDataInfo(battle) {
      return `
        <div class="section">
          <div class="section-title">üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
          <div style="display: grid; gap: 12px;">
            <div>
              <strong>Storage Key:</strong> <code>${battle.storage_key || '‚Äî'}</code>
            </div>
            <div>
              <strong>SHA256:</strong> <code style="font-size: 10px; word-break: break-all;">${battle.sha256 || '‚Äî'}</code>
            </div>
            <div>
              <strong>Compressed:</strong> ${battle.compressed ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}
            </div>
            ${battle.clans && battle.clans.length > 0 ? `
              <div>
                <strong>–ö–ª–∞–Ω—ã:</strong> ${battle.clans.join(', ')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // ===== –ò–°–¢–û–†–ò–Ø –ò–ì–†–û–ö–ê –ò –¢–ï–ü–õ–û–í–ê–Ø –ö–ê–†–¢–ê =====
    
    async function loadPlayerHistory(login) {
      const container = document.getElementById('player-history-container');
      container.innerHTML = `<div style="padding: 20px; text-align: center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä–æ–∫–∞ ${login}...</div>`;
      
      const days = 30; // –ø–µ—Ä–∏–æ–¥
      
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–æ—ë–≤ –∏–≥—Ä–æ–∫–∞
        const result = await api.client.get(`/analytics/battles/player/${encodeURIComponent(login)}`, {
          limit: 50,
          days: days
        });
        
        const battles = result.success ? result.data : (result.battles || result);
        
        if (!Array.isArray(battles) || battles.length === 0) {
          container.innerHTML = `<div style="padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–æ—è—Ö –∏–≥—Ä–æ–∫–∞ <strong>${login}</strong> –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${days} –¥–Ω–µ–π</p>
          </div>`;
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const heatmapData = createActivityHeatmap(battles);
        
        container.innerHTML = `
          <div style="
            background: linear-gradient(135deg, rgba(30, 30, 32, 0.9) 0%, rgba(28, 28, 30, 0.9) 100%);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 28px;
            margin-top: 24px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
              <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); letter-spacing: -0.3px;">üìä –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä–æ–∫–∞: ${login}</h3>
              <button class="btn btn-sm" onclick="document.getElementById('player-history-container').innerHTML=''" style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 12px; font-size: 12px;">‚úï</button>
            </div>
            
            <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div style="margin-bottom: 32px;">
              <h4 style="margin: 0 0 16px 0; font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.6); letter-spacing: 0.3px;">üïê –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ü–û –í–†–ï–ú–ï–ù–ò (–ü–û–°–õ–ï–î–ù–ò–ï ${days} –î–ù–ï–ô)</h4>
              ${renderActivityHeatmap(heatmapData)}
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –±–æ—ë–≤ -->
            <div>
              <h4 style="margin: 0 0 16px 0; font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.6); letter-spacing: 0.3px;">‚öîÔ∏è –ü–û–°–õ–ï–î–ù–ò–ï –ë–û–ò (${battles.length})</h4>
              <div style="
                max-height: 400px;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.15);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.05);
              ">
                <table style="width: 100%; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">
                  <thead style="position: sticky; top: 0; background: rgba(20, 20, 22, 0.95); backdrop-filter: blur(10px); z-index: 1;">
                    <tr>
                      <th style="padding: 10px 12px; text-align: left; font-weight: 500; font-size: 10px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">Battle ID</th>
                      <th style="padding: 10px 12px; text-align: left; font-weight: 500; font-size: 10px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                      <th style="padding: 10px 12px; text-align: center; font-weight: 500; font-size: 10px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–¢–∏–ø</th>
                      <th style="padding: 10px 12px; text-align: center; font-weight: 500; font-size: 10px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–õ–æ–∫–∞—Ü–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${battles.map(b => {
                      const battleId = b.battle_id || b.id || b.source_id;
                      const date = b.ts || b.start_ts || b.timestamp;
                      const dateStr = date ? new Date(date).toLocaleString('ru-RU', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                      }) : '‚Äî';
                      const type = b.battle_type || b.type || '‚Äî';
                      const locX = b.location?.[0] || b.loc_x || '?';
                      const locY = b.location?.[1] || b.loc_y || '?';
                      return `
                        <tr style="
                          cursor: pointer;
                          transition: background 0.15s ease;
                        " 
                        onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'"
                        onmouseout="this.style.background='transparent'"
                        onclick="window.open('/battle-details.html?battle_id=${battleId}', '_blank')">
                          <td style="padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.03);">
                            <a href="/battle-details.html?battle_id=${battleId}" target="_blank" style="
                              color: rgba(10, 132, 255, 0.9);
                              text-decoration: none;
                              font-weight: 500;
                            ">${battleId}</a>
                          </td>
                          <td style="padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.03); color: rgba(255, 255, 255, 0.7); font-size: 11px;">${dateStr}</td>
                          <td style="padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.03); text-align: center;">
                            <span style="
                              display: inline-block;
                              padding: 2px 8px;
                              background: rgba(94, 92, 230, 0.2);
                              border: 1px solid rgba(94, 92, 230, 0.3);
                              border-radius: 6px;
                              font-size: 10px;
                              font-weight: 600;
                              color: rgba(255, 255, 255, 0.8);
                            ">${type}</span>
                          </td>
                          <td style="padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.03); text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 11px;">(${locX}, ${locY})</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        container.innerHTML = `<div style="padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md); color: var(--danger);">
          <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</p>
        </div>`;
      }
    }
    
    function createActivityHeatmap(battles) {
      // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É 7 –¥–Ω–µ–π √ó 24 —á–∞—Å–∞
      const matrix = Array(7).fill(0).map(() => Array(24).fill(0));
      
      battles.forEach(battle => {
        const date = new Date(battle.ts || battle.start_ts || battle.timestamp);
        if (!isNaN(date.getTime())) {
          const dayOfWeek = date.getDay(); // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
          const hour = date.getHours();
          matrix[dayOfWeek][hour]++;
        }
      });
      
      return matrix;
    }
    
    function renderActivityHeatmap(matrix) {
      const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const maxValue = Math.max(...matrix.flat());
      
      const getColor = (value) => {
        if (value === 0) return 'rgba(255, 255, 255, 0.03)';
        const intensity = Math.min(value / maxValue, 1);
        
        // –ú—è–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ –∫ —Å–∏–Ω–µ–º—É (–∫–∞–∫ –≤ macOS)
        const baseColor = intensity < 0.3 ? 
          [94, 92, 230] : // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
          intensity < 0.6 ? 
          [10, 132, 255] : // —Å–∏–Ω–∏–π
          [48, 209, 88]; // –∑–µ–ª–µ–Ω—ã–π
        
        const alpha = 0.2 + (intensity * 0.6); // –æ—Ç 0.2 –¥–æ 0.8
        return `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${alpha})`;
      };
      
      return `
        <div style="
          background: linear-gradient(135deg, rgba(30, 30, 32, 0.95) 0%, rgba(28, 28, 30, 0.95) 100%);
          backdrop-filter: blur(30px) saturate(180%);
          -webkit-backdrop-filter: blur(30px) saturate(180%);
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.08);
          padding: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        ">
          <div style="overflow-x: auto;">
            <table style="
              border-collapse: separate;
              border-spacing: 2px;
              margin: 0 auto;
              font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            ">
              <thead>
                <tr>
                  <th style="padding: 4px; text-align: center; font-weight: 500; color: rgba(255, 255, 255, 0.4); font-size: 8px; letter-spacing: 0.3px;"></th>
                  ${Array(24).fill(0).map((_, h) => `
                    <th style="
                      padding: 4px 3px;
                      text-align: center;
                      font-weight: 500;
                      color: rgba(255, 255, 255, ${h % 6 === 0 ? '0.5' : '0.35'});
                      font-size: 8px;
                    ">
                      ${h}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${matrix.map((dayData, dayIdx) => `
                  <tr>
                    <td style="
                      padding: 4px 6px;
                      text-align: right;
                      font-weight: 600;
                      color: rgba(255, 255, 255, 0.7);
                      font-size: 9px;
                      letter-spacing: 0.2px;
                    ">
                      ${days[dayIdx]}
                    </td>
                    ${dayData.map((value, hour) => `
                      <td style="padding: 0;">
                        <div 
                          style="
                            width: 16px;
                            height: 16px;
                            background: ${getColor(value)};
                            border-radius: 3px;
                            cursor: ${value > 0 ? 'pointer' : 'default'};
                            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
                            border: 1px solid ${value > 0 ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                          title="${days[dayIdx]} ${hour}:00 - ${value} –±–æ—ë–≤"
                          ${value > 0 ? `
                            onmouseover="this.style.transform='scale(1.15)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)';"
                            onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'; this.style.boxShadow='none';"
                          ` : ''}
                        >
                          ${value > 0 && value < 100 ? `<span style="font-size: 7px; font-weight: 700; color: rgba(255, 255, 255, 0.95); font-variant-numeric: tabular-nums;">${value}</span>` : ''}
                        </div>
                      </td>
                    `).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div style="
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
          ">
            <div style="display: flex; align-items: center; gap: 4px;">
              <div style="width: 10px; height: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.03);"></div>
              <span>–ù–µ—Ç</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <div style="width: 10px; height: 10px; background: rgba(94, 92, 230, 0.4); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
              <span>–ú–∞–ª–æ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <div style="width: 10px; height: 10px; background: rgba(10, 132, 255, 0.6); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
              <span>–°—Ä–µ–¥–Ω–µ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <div style="width: 10px; height: 10px; background: rgba(48, 209, 88, 0.7); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
              <span>–ú–Ω–æ–≥–æ (${maxValue})</span>
            </div>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>

