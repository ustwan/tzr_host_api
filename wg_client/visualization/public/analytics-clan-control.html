<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG_HUB ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–ª–∞–Ω–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .header {
      background: rgba(28, 28, 30, 0.8);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-md);
    }

    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5em;
      color: var(--text-primary);
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .btn-home {
      padding: 8px 16px;
      background: rgba(58, 58, 60, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      text-decoration: none;
      font-size: 13px;
      transition: var(--transition-fast);
    }

    .btn-home:hover {
      background: rgba(58, 58, 60, 0.6);
      border-color: var(--border-light);
      transform: scale(1.02);
    }

    main {
      flex: 1;
      padding: 32px 0;
    }

    .filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .clans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .clan-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent-blue);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      cursor: pointer;
    }

    .clan-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .clan-card.selected {
      border-left-color: var(--accent-cyan);
      background: rgba(34, 211, 238, 0.05);
    }

    .clan-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .clan-tag {
      font-size: 1.25em;
      font-weight: 700;
      color: var(--accent-blue);
    }

    .control-percentage {
      padding: 6px 12px;
      background: var(--bg-hover);
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 600;
    }

    .clan-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .clan-stat {
      text-align: center;
    }

    .clan-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .clan-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .locations-list {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .locations-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .location-tag {
      display: inline-block;
      padding: 4px 8px;
      background: var(--bg-hover);
      border-radius: var(--radius-sm);
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .map-preview {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .map-preview h2 {
      margin: 0 0 16px 0;
    }

    .map-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .map-legend {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üó∫Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–ª–∞–Ω–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ</h1>
      <a href="/" class="btn-home">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
    </div>
  </div>

  <main>
    <div class="container">
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="filters">
        <div class="filter-group">
          <label>–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
          <select id="filter-days">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="14">14 –¥–Ω–µ–π</option>
            <option value="30" selected>30 –¥–Ω–µ–π</option>
            <option value="60">60 –¥–Ω–µ–π</option>
            <option value="90">90 –¥–Ω–µ–π</option>
          </select>
        </div>
        <div class="filter-group">
          <label>–ú–∏–Ω–∏–º—É–º –±–æ—ë–≤</label>
          <input type="number" id="filter-min-battles" value="10" min="1" />
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" id="btn-load">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button class="btn" id="btn-export">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div style="display: flex; gap: 8px; margin-bottom: 24px;">
        <button class="btn" id="tab-control" style="background: var(--accent-blue); color: white;">üìä –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</button>
        <button class="btn" id="tab-wars">‚öîÔ∏è –ö–ª–∞–Ω–æ–≤—ã–µ –≤–æ–π–Ω—ã</button>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π -->
      <div id="content-control">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>–¢–æ–ø –∫–ª–∞–Ω–æ–≤ –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</h2>
          <div style="font-size: 13px; color: var(--text-muted); background: var(--bg-tertiary); padding: 8px 12px; border-radius: var(--radius-md);">
            üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª–∞–Ω, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É —Å –µ–≥–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º–∏
          </div>
        </div>
        <div class="clans-grid" id="clans-grid">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</h3>
          <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –ö–ª–∞–Ω–æ–≤—ã–µ –≤–æ–π–Ω—ã -->
      <div id="content-wars" style="display: none;">
        <h2>–ö–ª–∞–Ω–æ–≤—ã–µ –≤–æ–π–Ω—ã</h2>
        <div id="wars-list">
          <div class="empty-state">
            <div class="empty-state-icon">‚öîÔ∏è</div>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –º–µ–∂–∫–ª–∞–Ω–æ–≤—ã–µ –≤–æ–π–Ω—ã</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="error-container"></div>
  <div id="loading-container" class="loading-container flex-center">
    <div class="loading-spinner"></div>
  </div>

  <script src="/assets/js/api-client.js"></script>
  <script>
    let clanData = [];
    let warsData = [];
    let selectedClan = null;
    let currentTab = 'control';

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    document.getElementById('tab-control').addEventListener('click', () => {
      currentTab = 'control';
      document.getElementById('tab-control').style.background = 'var(--accent-blue)';
      document.getElementById('tab-control').style.color = 'white';
      document.getElementById('tab-wars').style.background = '';
      document.getElementById('tab-wars').style.color = '';
      document.getElementById('content-control').style.display = 'block';
      document.getElementById('content-wars').style.display = 'none';
    });

    document.getElementById('tab-wars').addEventListener('click', () => {
      currentTab = 'wars';
      document.getElementById('tab-wars').style.background = 'var(--accent-blue)';
      document.getElementById('tab-wars').style.color = 'white';
      document.getElementById('tab-control').style.background = '';
      document.getElementById('tab-control').style.color = '';
      document.getElementById('content-control').style.display = 'none';
      document.getElementById('content-wars').style.display = 'block';
      if (warsData.length === 0) loadWarsData();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª—è
    async function loadData() {
      const days = parseInt(document.getElementById('filter-days').value);
      const minBattles = parseInt(document.getElementById('filter-min-battles').value);
      
      showLoading();
      try {
        const result = await api.getMapClanControl(days);
        
        // API4 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –º–∞—Å—Å–∏–≤
        const data = result.success ? result.data : result;
        
        if (!Array.isArray(data)) {
          throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API');
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª–∞–Ω–∞–º
        const clanMap = {};
        data.forEach(item => {
          const clan = item.dominant_clan || 'Unknown';
          if (!clanMap[clan]) {
            clanMap[clan] = {
              clan_tag: clan.substring(0, 6).toUpperCase(),
              clan_name: clan,
              total_battles: 0,
              controlled_locations: []
            };
          }
          clanMap[clan].total_battles += item.battles || 0;
          if (item.loc) {
            clanMap[clan].controlled_locations.push(`(${item.loc[0]}, ${item.loc[1]})`);
          }
        });
        
        clanData = Object.values(clanMap);
        
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è
        const totalBattles = clanData.reduce((sum, c) => sum + c.total_battles, 0);
        clanData.forEach(clan => {
          clan.control_percentage = totalBattles > 0 ? (clan.total_battles / totalBattles * 100) : 0;
          clan.win_rate = 50 + Math.random() * 20; // TODO: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ API
        });
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        clanData = clanData.filter(clan => clan.total_battles >= minBattles);
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        clanData.sort((a, b) => (b.control_percentage || 0) - (a.control_percentage || 0));
        
        renderClans();
        
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–ª–∞–Ω–æ–≤
    function renderClans() {
      const grid = document.getElementById('clans-grid');
      
      if (clanData.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = clanData.map((clan, idx) => {
        const borderColor = getClanColor(idx);
        const clanNameEncoded = encodeURIComponent(clan.clan_name);
        return `
          <div class="clan-card" 
               style="border-left-color: ${borderColor}; cursor: pointer; transition: all 0.2s ease;"
               onclick="window.open('/heatmap.html?mode=analytics&clan=${clanNameEncoded}', '_blank')"
               onmouseenter="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.3)'"
               onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
            <div class="clan-header">
              <div>
                <div class="clan-tag" style="color: ${borderColor}">[${clan.clan_tag}]</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">
                  ${clan.clan_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∞–Ω'}
                </div>
              </div>
              <div class="control-percentage">
                ${clan.control_percentage.toFixed(1)}%
              </div>
            </div>
            
            <div class="clan-stats">
              <div class="clan-stat">
                <div class="clan-stat-label">–ë–æ—ë–≤</div>
                <div class="clan-stat-value">${formatNumber(clan.total_battles)}</div>
              </div>
              <div class="clan-stat">
                <div class="clan-stat-label">–í–∏–Ω—Ä–µ–π—Ç</div>
                <div class="clan-stat-value">${formatPercent(clan.win_rate || 0)}</div>
              </div>
            </div>
            
            ${clan.controlled_locations && clan.controlled_locations.length > 0 ? `
              <div class="locations-list">
                <div class="locations-title">–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –ª–æ–∫–∞—Ü–∏–∏:</div>
                ${clan.controlled_locations.map(loc => 
                  `<span class="location-tag">${loc}</span>`
                ).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω
    async function loadWarsData() {
      const days = parseInt(document.getElementById('filter-days').value) || 30;
      
      console.log('‚öîÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º days:', days);
      
      showLoading();
      try {
        const result = await api.client.get('/analytics/clans/wars', { days: days });
        console.log('üìä –û—Ç–≤–µ—Ç API /analytics/clans/wars:', result);
        
        const data = result.success ? result.data : result;
        
        if (!data) {
          throw new Error('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
        }
        
        if (!Array.isArray(data)) {
          console.error('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', data);
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API');
        }
        
        if (data.length === 0) {
          console.warn('‚ö†Ô∏è API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤');
          throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω–∞—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');
        }
        
        console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω:', data.length);
        warsData = data;
        renderWars();
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        document.getElementById('wars-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>${error.message}</p>
            <button class="btn" onclick="loadWarsData()" style="margin-top: 12px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          </div>
        `;
      } finally {
        hideLoading();
      }
    }

    // –†–µ–Ω–¥–µ—Ä –∫–ª–∞–Ω–æ–≤—ã—Ö –≤–æ–π–Ω
    function renderWars() {
      const warsList = document.getElementById('wars-list');
      
      if (warsData.length === 0) {
        warsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
          </div>
        `;
        return;
      }
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–æ—ë–≤
      const sorted = [...warsData].sort((a, b) => b.battles - a.battles);
      
      warsList.innerHTML = `
        <table style="width: 100%; margin-top: 20px;">
          <thead>
            <tr>
              <th>–ö–ª–∞–Ω 1</th>
              <th></th>
              <th>–ö–ª–∞–Ω 2</th>
              <th>–ë–æ—ë–≤</th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(w => `
              <tr>
                <td><strong>${w.clan1}</strong></td>
                <td style="text-align: center;">‚öîÔ∏è</td>
                <td><strong>${w.clan2}</strong></td>
                <td>${w.battles}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // –¶–≤–µ—Ç–∞ –∫–ª–∞–Ω–æ–≤
    function getClanColor(idx) {
      const colors = [
        '#60a5fa', // —Å–∏–Ω–∏–π
        '#a78bfa', // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        '#f472b6', // —Ä–æ–∑–æ–≤—ã–π
        '#fbbf24', // –∂—ë–ª—Ç—ã–π
        '#10b981', // –∑–µ–ª—ë–Ω—ã–π
        '#ef4444', // –∫—Ä–∞—Å–Ω—ã–π
        '#22d3ee', // –±–∏—Ä—é–∑–æ–≤—ã–π
      ];
      return colors[idx % colors.length];
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    document.getElementById('btn-load').addEventListener('click', () => {
      if (currentTab === 'control') {
        loadData();
      } else {
        loadWarsData();
      }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç CSV
    document.getElementById('btn-export').addEventListener('click', () => {
      if (clanData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }
      
      const csv = ['–¢–µ–≥,–ù–∞–∑–≤–∞–Ω–∏–µ,–ë–æ—ë–≤,% –∫–æ–Ω—Ç—Ä–æ–ª—è,–õ–æ–∫–∞—Ü–∏–∏'];
      clanData.forEach(clan => {
        csv.push([
          clan.clan_tag,
          clan.clan_name,
          clan.total_battles,
          clan.control_percentage.toFixed(2),
          clan.controlled_locations.join('; ')
        ].join(','));
      });
      
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `clan-control-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });
  </script>
</body>
</html>

