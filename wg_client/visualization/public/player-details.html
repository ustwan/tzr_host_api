<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG_HUB ‚Äî –î–µ—Ç–∞–ª–∏ –∏–≥—Ä–æ–∫–∞</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      padding: 16px 0;
      border-bottom: 2px solid var(--accent-blue);
      box-shadow: var(--shadow-md);
    }

    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5em;
      color: #ffffff;
      margin: 0;
    }

    .btn-home {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-md);
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
    }

    main {
      flex: 1;
      padding: 32px 0;
    }

    .player-header-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .player-name-big {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .player-meta {
      color: var(--text-muted);
      display: flex;
      gap: 16px;
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .battles-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .section-title {
      font-size: 1.25em;
      font-weight: 700;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: var(--bg-hover);
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      border-bottom: 2px solid var(--border);
    }

    td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--bg-hover);
    }

    .antibot-details {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 4px solid var(--warning);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
    }

    .antibot-details.safe {
      border-left-color: var(--success);
    }

    .antibot-details.danger {
      border-left-color: var(--danger);
    }

    .reason-item {
      padding: 8px 12px;
      background: var(--bg-hover);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .metric-card {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1 id="page-title">–î–µ—Ç–∞–ª–∏ –∏–≥—Ä–æ–∫–∞</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <label for="days-select" style="color: white; font-size: 14px;">–ü–µ—Ä–∏–æ–¥:</label>
        <select id="days-select" style="padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">
          <option value="7">7 –¥–Ω–µ–π</option>
          <option value="30">30 –¥–Ω–µ–π</option>
          <option value="90" selected>90 –¥–Ω–µ–π</option>
          <option value="180">180 –¥–Ω–µ–π</option>
          <option value="365">365 –¥–Ω–µ–π</option>
        </select>
        <a href="/antibot.html" class="btn-home">‚Üê Antibot</a>
      </div>
    </div>
  </div>

  <main>
    <div class="container" id="content">
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
    </div>
  </main>

  <div id="error-container"></div>
  <div id="loading-container" class="loading-container flex-center">
    <div class="loading-spinner"></div>
  </div>

  <script src="/assets/js/api-client.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const login = urlParams.get('login');

    if (!login) {
      document.getElementById('content').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>–ù–µ —É–∫–∞–∑–∞–Ω login –∏–≥—Ä–æ–∫–∞</p>
        </div>
      `;
    } else {
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∏–∑ URL
      const urlParams2 = new URLSearchParams(window.location.search);
      const initialDays = parseInt(urlParams2.get('days')) || 90;
      document.getElementById('days-select').value = initialDays;
      
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      loadPlayerDetails(login);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
      document.getElementById('days-select').addEventListener('change', (e) => {
        const newDays = e.target.value;
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('days', newDays);
        window.location.href = newUrl.toString();
      });
    }

    async function loadPlayerDetails(login) {
      showLoading();
      try {
        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä days –∏–∑ URL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 90)
        const urlParams = new URLSearchParams(window.location.search);
        const days = parseInt(urlParams.get('days')) || 90;
        
        const [playerRes, antibotRes, battlesRes] = await Promise.allSettled([
          api.client.get(`/analytics/player/${encodeURIComponent(login)}`, { days }),
          api.client.get(`/analytics/antibot/player/${encodeURIComponent(login)}`, { days }),
          api.client.get(`/analytics/battles/player/${encodeURIComponent(login)}`, { limit: 100, days })
        ]);

        const playerData = playerRes.status === 'fulfilled' ? (playerRes.value.success ? playerRes.value.data : playerRes.value) : null;
        const antibotData = antibotRes.status === 'fulfilled' ? (antibotRes.value.success ? antibotRes.value.data : antibotRes.value) : null;
        const battlesData = battlesRes.status === 'fulfilled' ? (battlesRes.value.success ? battlesRes.value.data : battlesRes.value) : null;

        console.log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥:', days, '–¥–Ω–µ–π');
        console.log('üìä PlayerData:', playerData);
        console.log('ü§ñ AntibotData:', antibotData);
        console.log('‚öîÔ∏è BattlesData:', Array.isArray(battlesData) ? `${battlesData.length} –±–æ—ë–≤` : battlesData);

        if (!playerData || playerData.detail) {
          throw new Error('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        renderPlayerDetails(playerData, antibotData, battlesData, days);

      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        hideLoading();
      }
    }

    function renderPlayerDetails(player, antibot, battles, days = 90) {
      document.getElementById('page-title').textContent = `–ò–≥—Ä–æ–∫: ${player.login}`;
      
      const winRate = player.battles_count > 0 ? (player.wins / player.battles_count * 100) : 0;
      const antibotScore = antibot ? ((antibot.score || antibot.suspicion_score || 0) * 100) : 0;
      const isSafe = antibotScore < 50;
      const isDanger = antibotScore >= 80;

      document.getElementById('content').innerHTML = `
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
        <div class="player-header-card">
          <div class="player-name-big">${player.login}</div>
          <div class="player-meta">
            <span>Player ID: ${player.player_id}</span>
            <span>–ë–æ—ë–≤: ${player.battles_count}</span>
            <span>–í–∏–Ω—Ä–µ–π—Ç: ${formatPercent(winRate)}</span>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">–ü–æ–±–µ–¥</div>
            <div class="stat-value">${formatNumber(player.wins)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
            <div class="stat-value">${formatNumber(player.losses)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–£–±–∏—Ç–æ –º–æ–Ω—Å—Ç—Ä–æ–≤</div>
            <div class="stat-value">${formatNumber(player.kills_monsters)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–£–±–∏—Ç–æ –∏–≥—Ä–æ–∫–æ–≤</div>
            <div class="stat-value">${formatNumber(player.kills_players)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">PvE Points (avg)</div>
            <div class="stat-value">${formatNumber(Math.round(player.pve_points_avg || 0))}</div>
          </div>
        </div>

        ${renderAntibotDetails(antibot, days)}
        ${renderBattlesTable(battles)}
      `;
    }

    function renderAntibotDetails(antibot, days = 90) {
      if (!antibot) {
        return `<div class="antibot-details"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω—Ç–∏–±–æ—Ç–∞</p></div>`;
      }

      console.log('ü§ñ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–Ω—Ç–∏–±–æ—Ç–∞, antibot:', antibot);
      console.log('ü§ñ antibot.score:', antibot.score);
      console.log('ü§ñ antibot.suspicion_score:', antibot.suspicion_score);
      console.log('ü§ñ antibot.confidence:', antibot.confidence);
      console.log('ü§ñ antibot.is_bot:', antibot.is_bot);
      console.log('ü§ñ antibot.metrics:', antibot.metrics);
      console.log('ü§ñ antibot.metrics?.heatmap:', antibot.metrics?.heatmap);
      console.log('ü§ñ antibot.metrics?.ultra_short_ratio:', antibot.metrics?.ultra_short_ratio);
      console.log('ü§ñ antibot.metrics?.marathon_count:', antibot.metrics?.marathon_count);
      console.log('ü§ñ –í—Å–µ –∫–ª—é—á–∏ antibot:', Object.keys(antibot));
      console.log('ü§ñ –í—Å–µ –∫–ª—é—á–∏ antibot.metrics:', antibot.metrics ? Object.keys(antibot.metrics) : 'null');

      // ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç score —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 0-1 (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.95 = 95%)
      const rawScore = antibot.score || antibot.suspicion_score || antibot.confidence || 0;
      const score = rawScore > 1 ? rawScore : (rawScore * 100);
      console.log(`üìä Score calc: raw=${rawScore}, final=${score}%`);
      const isSafe = score < 50;
      const isDanger = score >= 80;
      const statusClass = isSafe ? 'safe' : (isDanger ? 'danger' : '');

      return `
        <div class="antibot-details ${statusClass}">
          <div class="section-title">ü§ñ –ê–Ω—Ç–∏–±–æ—Ç –∞–Ω–∞–ª–∏–∑ (${days} –¥–Ω–µ–π)</div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <strong>–°—Ç–∞—Ç—É—Å:</strong> ${antibot.is_bot ? 'üî¥ –ë–æ—Ç' : 'üü¢ –ù–µ –±–æ—Ç'}
            </div>
            <div class="badge ${isSafe ? 'badge-success' : (isDanger ? 'badge-danger' : 'badge-warning')}">
              –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${score.toFixed(1)}%
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <strong>–ü—Ä–∏—á–∏–Ω—ã:</strong>
          </div>
          ${antibot.reasons && antibot.reasons.length > 0 ? antibot.reasons.map(r => `
            <div class="reason-item">${r}</div>
          `).join('') : '<p>–ù–µ—Ç –ø—Ä–∏—á–∏–Ω</p>'}

          ${antibot.metrics ? `
            <div style="margin-top: 20px;">
              <strong>–ú–µ—Ç—Ä–∏–∫–∏:</strong>
            </div>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">SR</div>
                <div class="metric-value">${(antibot.metrics.sr || 0).toFixed(2)}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">KPM PvP</div>
                <div class="metric-value">${(antibot.metrics.kpm_pvp || 0).toFixed(1)}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">KPM PvE</div>
                <div class="metric-value">${(antibot.metrics.kpm_pve || 0).toFixed(1)}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Max Gap</div>
                <div class="metric-value">${(antibot.metrics.max_gap_hours || 0).toFixed(1)}—á</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">–°–µ—Å—Å–∏–π</div>
                <div class="metric-value">${antibot.metrics.sessions_count || 0}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Avg Turns</div>
                <div class="metric-value">${(antibot.metrics.avg_turns || 0).toFixed(1)}</div>
              </div>
              ${(antibot.metrics.ultra_short_ratio !== undefined && antibot.metrics.ultra_short_ratio > 0) ? `
              <div class="metric-card">
                <div class="metric-label">ü§ñ –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã < 0.5 —Å–µ–∫</div>
                <div class="metric-value">${(antibot.metrics.ultra_short_ratio * 100).toFixed(1)}%</div>
              </div>
              ` : ''}
              ${(antibot.metrics.marathon_count !== undefined && antibot.metrics.marathon_count > 0) ? `
              <div class="metric-card">
                <div class="metric-label">üèÉ –ú–∞—Ä–∞—Ñ–æ–Ω—ã (3+—á)</div>
                <div class="metric-value">${antibot.metrics.marathon_count}</div>
              </div>
              ` : ''}
              ${antibot.metrics.longest_marathon_hours ? `
              <div class="metric-card">
                <div class="metric-label">–ú–∞–∫—Å –º–∞—Ä–∞—Ñ–æ–Ω</div>
                <div class="metric-value">${antibot.metrics.longest_marathon_hours.toFixed(1)}—á</div>
              </div>
              ` : ''}
              ${antibot.detection_method ? `
              <div class="metric-card">
                <div class="metric-label">–ú–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏</div>
                <div class="metric-value">${antibot.detection_method}</div>
              </div>
              ` : ''}
            </div>
            
            ${(() => {
              const hasHeatmap = antibot.metrics.heatmap && Array.isArray(antibot.metrics.heatmap) && antibot.metrics.heatmap.length > 0;
              console.log('üó∫Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ heatmap:', {
                exists: !!antibot.metrics.heatmap,
                isArray: Array.isArray(antibot.metrics.heatmap),
                length: antibot.metrics.heatmap?.length,
                hasHeatmap
              });
              
              if (hasHeatmap) {
                return `
                  <div style="margin-top: 28px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.6); letter-spacing: 0.3px;">üìä –¢–ï–ü–õ–û–í–ê–Ø –ö–ê–†–¢–ê –ê–ö–¢–ò–í–ù–û–°–¢–ò (24√ó7)</h4>
                    ${renderHeatmap(antibot.metrics.heatmap, antibot.metrics.hour_hist, antibot.metrics.weekday_hist)}
                  </div>
                `;
              } else {
                console.warn('‚ö†Ô∏è –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, heatmap:', antibot.metrics.heatmap);
                return '';
              }
            })()}
          ` : ''}
        </div>
      `;
    }
    
    function renderHeatmap(heatmap, hourHist, weekdayHist) {
      // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É 24 —á–∞—Å–∞ x 7 –¥–Ω–µ–π
      const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      const maxBattles = Math.max(...heatmap.map(h => h.battles), 1);
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
      const heatmapMap = {};
      heatmap.forEach(h => {
        const key = `${h.hour}-${h.weekday}`;
        heatmapMap[key] = h.battles;
      });
      
      const getColor = (value) => {
        if (value === 0) return 'rgba(255, 255, 255, 0.03)';
        const intensity = Math.min(value / maxBattles, 1);
        
        // –ú—è–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ –∫ —Å–∏–Ω–µ–º—É (–∫–∞–∫ –≤ macOS)
        const baseColor = intensity < 0.3 ? 
          [94, 92, 230] : // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
          intensity < 0.6 ? 
          [10, 132, 255] : // —Å–∏–Ω–∏–π
          [48, 209, 88]; // –∑–µ–ª–µ–Ω—ã–π
        
        const alpha = 0.2 + (intensity * 0.6);
        return `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${alpha})`;
      };
      
      let html = `
        <div style="
          background: linear-gradient(135deg, rgba(30, 30, 32, 0.95) 0%, rgba(28, 28, 30, 0.95) 100%);
          backdrop-filter: blur(30px) saturate(180%);
          -webkit-backdrop-filter: blur(30px) saturate(180%);
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.08);
          padding: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        ">
          <div style="overflow-x: auto;">
            <table style="
              border-collapse: separate;
              border-spacing: 2px;
              margin: 0 auto;
              font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            ">
              <thead>
                <tr>
                  <th style="padding: 4px; text-align: center; font-weight: 500; color: rgba(255, 255, 255, 0.4); font-size: 8px; letter-spacing: 0.3px;"></th>
      `;
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ - —á–∞—Å—ã (0-23)
      for (let hour = 0; hour < 24; hour++) {
        html += `<th style="padding: 4px 3px; text-align: center; font-weight: 500; color: rgba(255, 255, 255, ${hour % 6 === 0 ? '0.5' : '0.35'}); font-size: 8px;">${hour}</th>`;
      }
      html += '</tr></thead><tbody>';
      
      // –°—Ç—Ä–æ–∫–∏ - –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ (0-6, –≥–¥–µ 0 = –ü–Ω)
      for (let day = 0; day < 7; day++) {
        html += `<tr><td style="padding: 4px 6px; text-align: right; font-weight: 600; color: rgba(255, 255, 255, 0.7); font-size: 9px; letter-spacing: 0.2px;">${days[day]}</td>`;
        
        // –Ø—á–µ–π–∫–∏ - —á–∞—Å—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
        for (let hour = 0; hour < 24; hour++) {
          const key = `${hour}-${day}`;
          const battles = heatmapMap[key] || 0;
          html += `
            <td style="padding: 0;">
              <div 
                style="
                  width: 16px;
                  height: 16px;
                  background: ${getColor(battles)};
                  border-radius: 3px;
                  cursor: ${battles > 0 ? 'pointer' : 'default'};
                  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
                  border: 1px solid ${battles > 0 ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
                title="${days[day]}, ${hour}:00 - ${battles} –±–æ—ë–≤"
                ${battles > 0 ? `
                  onmouseover="this.style.transform='scale(1.15)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)';"
                  onmouseout="this.style.transform='scale(1)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'; this.style.boxShadow='none';"
                ` : ''}
              >
                ${battles > 0 && battles < 100 ? `<span style="font-size: 7px; font-weight: 700; color: rgba(255, 255, 255, 0.95); font-variant-numeric: tabular-nums;">${battles}</span>` : ''}
              </div>
            </td>
          `;
        }
        html += '</tr>';
      }
      
      html += '</tbody></table></div>';
      html += `
        <div style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          font-size: 8px;
          color: rgba(255, 255, 255, 0.5);
        ">
          <div style="display: flex; align-items: center; gap: 4px;">
            <div style="width: 10px; height: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.03);"></div>
            <span>–ù–µ—Ç</span>
          </div>
          <div style="display: flex; align-items: center; gap: 4px;">
            <div style="width: 10px; height: 10px; background: rgba(94, 92, 230, 0.4); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
            <span>–ú–∞–ª–æ</span>
          </div>
          <div style="display: flex; align-items: center; gap: 4px;">
            <div style="width: 10px; height: 10px; background: rgba(10, 132, 255, 0.6); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
            <span>–°—Ä–µ–¥–Ω–µ</span>
          </div>
          <div style="display: flex; align-items: center; gap: 4px;">
            <div style="width: 10px; height: 10px; background: rgba(48, 209, 88, 0.7); border-radius: 2px; border: 1px solid rgba(255, 255, 255, 0.1);"></div>
            <span>–ú–Ω–æ–≥–æ (${maxBattles})</span>
          </div>
        </div>
      </div>
      `;
      return html;
    }

    function renderBattlesTable(battles) {
      if (!battles || !Array.isArray(battles) || battles.length === 0) {
        return `
          <div class="battles-section">
            <div class="section-title">‚öîÔ∏è –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–æ–∏</div>
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–æ—è—Ö</p>
          </div>
        `;
      }

      return `
        <div class="battles-section">
          <div class="section-title">‚öîÔ∏è –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 –±–æ—ë–≤</div>
          <table>
            <thead>
              <tr>
                <th>Battle ID</th>
                <th>Service ID</th>
                <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
              </tr>
            </thead>
            <tbody>
              ${battles.slice(0, 100).map(b => `
                <tr style="cursor: pointer;" onclick="window.open('/battle-details.html?battle_id=${b.battle_id}', '_blank')">
                  <td><a href="/battle-details.html?battle_id=${b.battle_id}" target="_blank" style="color: var(--accent-blue);">${b.battle_id}</a></td>
                  <td>${b.service_id || '‚Äî'}</td>
                  <td>${b.ts ? new Date(b.ts).toLocaleString('ru-RU') : '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
  </script>
</body>
</html>

