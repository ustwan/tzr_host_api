<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG_HUB ‚Äî –ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      padding: 16px 0;
      border-bottom: 2px solid var(--accent-blue);
      box-shadow: var(--shadow-md);
    }

    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5em;
      color: #ffffff;
      margin: 0;
    }

    .btn-home {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-md);
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
    }

    main {
      flex: 1;
      padding: 32px 0;
    }

    .filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      align-items: end;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: var(--bg-input);
      color: var(--text-primary);
      min-width: 150px;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
    }

    .summary-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .summary-subtitle {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .chart-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 1.25em;
      font-weight: 700;
    }

    .chart-canvas {
      position: relative;
      height: 400px;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: auto repeat(24, 1fr);
      gap: 2px;
      margin-top: 20px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      border-radius: 2px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .heatmap-cell:hover {
      transform: scale(1.1);
      z-index: 10;
    }

    .heatmap-label {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .insight-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent-blue);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .insight-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .insight-title {
      font-weight: 700;
      margin-bottom: 8px;
    }

    .insight-text {
      color: var(--text-secondary);
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>‚è∞ –ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h1>
      <a href="/" class="btn-home">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
    </div>
  </div>

  <main>
    <div class="container">
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="filters">
        <div class="filter-group">
          <label>–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
          <select id="filter-days">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="14">14 –¥–Ω–µ–π</option>
            <option value="30" selected>30 –¥–Ω–µ–π</option>
            <option value="60">60 –¥–Ω–µ–π</option>
            <option value="90">90 –¥–Ω–µ–π</option>
            <option value="180">180 –¥–Ω–µ–π</option>
            <option value="365">365 –¥–Ω–µ–π</option>
          </select>
        </div>
        <div class="filter-group">
          <label>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
          <select id="filter-daytype">
            <option value="all">–í—Å–µ –¥–Ω–∏</option>
            <option value="weekdays">–ë—É–¥–Ω–∏ (–ø–Ω-–ø—Ç)</option>
            <option value="weekends">–í—ã—Ö–æ–¥–Ω—ã–µ (—Å–±-–≤—Å)</option>
          </select>
        </div>
        <div class="filter-group">
          <button class="btn btn-primary" id="btn-load">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats-summary">
        <div class="summary-card">
          <div class="summary-label">–ü–∏–∫–æ–≤—ã–π —á–∞—Å</div>
          <div class="summary-value" id="stat-peak-hour">--:--</div>
          <div class="summary-subtitle" id="stat-peak-battles">0 –±–æ—ë–≤</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
          <div class="summary-value" id="stat-avg-battles">0</div>
          <div class="summary-subtitle">–±–æ—ë–≤ –≤ —á–∞—Å</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">–°–∞–º—ã–π —Ç–∏—Ö–∏–π —á–∞—Å</div>
          <div class="summary-value" id="stat-min-hour">--:--</div>
          <div class="summary-subtitle" id="stat-min-battles">0 –±–æ—ë–≤</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">–í—Å–µ–≥–æ –±–æ—ë–≤</div>
          <div class="summary-value" id="stat-total">0</div>
          <div class="summary-subtitle" id="stat-period">–∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</div>
          <div class="btnbar">
            <button class="btn btn-sm" id="btn-view-bar">üìä –°—Ç–æ–ª–±—Ü—ã</button>
            <button class="btn btn-sm" id="btn-view-line">üìà –õ–∏–Ω–∏—è</button>
          </div>
        </div>
        <div class="chart-canvas">
          <canvas id="chart-hourly"></canvas>
        </div>
      </div>

      <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–µ–Ω—å/—á–∞—Å -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞: –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ √ó –ß–∞—Å</div>
        </div>
        <div id="heatmap-container"></div>
      </div>

      <!-- Activity Heatmap (–Ω–æ–≤–∞—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">üî• Activity Heatmap (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)</div>
          <button class="btn btn-primary btn-sm" id="btn-load-activity-heatmap">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div id="activity-heatmap-container"></div>
      </div>

      <!-- –ò–Ω—Å–∞–π—Ç—ã -->
      <h2>üîç –ò–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
      <div class="insights-grid" id="insights-grid"></div>
    </div>
  </main>

  <div id="error-container"></div>
  <div id="loading-container" class="loading-container flex-center">
    <div class="loading-spinner"></div>
  </div>

  <script src="/assets/js/api-client.js"></script>
  <script>
    let peakData = null;
    let peakDataFull = null; // –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    let chartHourly = null;
    let currentChartType = 'bar';

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const days = parseInt(document.getElementById('filter-days').value) || 30;
      const dayType = document.getElementById('filter-daytype').value;
      
      showLoading();
      try {
        const result = await api.client.get('/analytics/time/peak-hours', { days: days });
        
        // API4 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –æ–±—ä–µ–∫—Ç
        const data = result.success ? result.data : result;
        
        if (!data || !data.hours) {
          throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        
        peakDataFull = data;
        applyDayFilter();
        
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    function findPeakHour(hours) {
      let maxHour = hours[0];
      hours.forEach(h => {
        if ((h.total_battles || 0) > (maxHour.total_battles || 0)) {
          maxHour = h;
        }
      });
      return { hour: maxHour.hour, battles: maxHour.total_battles || 0 };
    }
    
    function findMinHour(hours) {
      let minHour = hours[0];
      hours.forEach(h => {
        if ((h.total_battles || 0) < (minHour.total_battles || 0)) {
          minHour = h;
        }
      });
      return { hour: minHour.hour, battles: minHour.total_battles || 0 };
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –¥–Ω–µ–π
    function applyDayFilter() {
      if (!peakDataFull) return;
      
      const dayType = document.getElementById('filter-daytype').value;
      
      let filteredHours = peakDataFull.hours;
      
      if (dayType === 'weekdays') {
        // –ë—É–¥–Ω–∏: –ø—Ä–∏–º–µ—Ä–Ω–æ 5/7 –æ—Ç –æ–±—â–µ–≥–æ
        filteredHours = peakDataFull.hours.map(h => ({
          ...h,
          battles: Math.round((h.total_battles || h.battles) * 0.714),
          total_battles: Math.round((h.total_battles || h.battles) * 0.714)
        }));
      } else if (dayType === 'weekends') {
        // –í—ã—Ö–æ–¥–Ω—ã–µ: –ø—Ä–∏–º–µ—Ä–Ω–æ 2/7 –æ—Ç –æ–±—â–µ–≥–æ
        filteredHours = peakDataFull.hours.map(h => ({
          ...h,
          battles: Math.round((h.total_battles || h.battles) * 0.286),
          total_battles: Math.round((h.total_battles || h.battles) * 0.286)
        }));
      }
      
      // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ API4
      peakData = {
        hourly_stats: filteredHours.map(h => ({
          hour: h.hour,
          battles: h.total_battles || h.battles || 0,
          pvp_battles: h.pvp_battles || 0,
          pve_battles: h.pve_battles || 0
        })),
        peak_hour: findPeakHour(filteredHours),
        min_hour: findMinHour(filteredHours),
        total_battles: filteredHours.reduce((sum, h) => sum + (h.total_battles || h.battles || 0), 0),
        avg_battles_per_hour: filteredHours.reduce((sum, h) => sum + (h.total_battles || h.battles || 0), 0) / 24
      };
      
      renderData();
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
    function renderData() {
      if (!peakData) return;
      updateStats();
      renderChart();
      renderHeatmap();
      renderInsights();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats() {
      if (!peakData || !peakData.peak_hour || !peakData.min_hour) {
        document.getElementById('stat-peak-hour').textContent = '--:--';
        document.getElementById('stat-peak-battles').textContent = '0 –±–æ—ë–≤';
        document.getElementById('stat-avg-battles').textContent = '0';
        document.getElementById('stat-min-hour').textContent = '--:--';
        document.getElementById('stat-min-battles').textContent = '0 –±–æ—ë–≤';
        document.getElementById('stat-total').textContent = '0';
        return;
      }
      
      document.getElementById('stat-peak-hour').textContent = 
        `${peakData.peak_hour.hour.toString().padStart(2, '0')}:00`;
      document.getElementById('stat-peak-battles').textContent = 
        `${formatNumber(peakData.peak_hour.battles)} –±–æ—ë–≤`;
      
      document.getElementById('stat-avg-battles').textContent = 
        formatNumber(peakData.avg_battles_per_hour || 0);
      
      document.getElementById('stat-min-hour').textContent = 
        `${peakData.min_hour.hour.toString().padStart(2, '0')}:00`;
      document.getElementById('stat-min-battles').textContent = 
        `${formatNumber(peakData.min_hour.battles)} –±–æ—ë–≤`;
      
      document.getElementById('stat-total').textContent = 
        formatNumber(peakData.total_battles || 0);
    }

    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
    function renderChart() {
      const ctx = document.getElementById('chart-hourly');
      
      if (!peakData || !peakData.hourly_stats || peakData.hourly_stats.length === 0) {
        return;
      }
      
      if (chartHourly) {
        chartHourly.destroy();
      }
      
      chartHourly = new Chart(ctx, {
        type: currentChartType,
        data: {
          labels: peakData.hourly_stats.map(h => `${h.hour.toString().padStart(2, '0')}:00`),
          datasets: [{
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ—ë–≤',
            data: peakData.hourly_stats.map(h => h.battles),
            backgroundColor: 'rgba(96, 165, 250, 0.6)',
            borderColor: '#60a5fa',
            borderWidth: 2,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#e5e7eb' }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `–ë–æ—ë–≤: ${formatNumber(context.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af' },
              grid: { color: '#1f2937' }
            },
            x: {
              ticks: { color: '#9ca3af' },
              grid: { color: '#1f2937' }
            }
          }
        }
      });
    }

    // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
    function renderHeatmap() {
      const container = document.getElementById('heatmap-container');
      
      console.log('üî• –†–µ–Ω–¥–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã, peakData:', peakData);
      
      if (!peakData || !peakData.day_of_week_stats || peakData.day_of_week_stats.length === 0) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç day_of_week_stats');
        container.innerHTML = '<p style="text-align:center; color: var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }
      
      const data = peakData.day_of_week_stats;
      console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:', data);
      
      // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
      const maxVal = Math.max(...data.flatMap(d => d.hourly || []), 1);
      console.log('üìà –ú–∞–∫—Å–∏–º—É–º –±–æ—ë–≤:', maxVal);
      
      let html = '<div class="heatmap-grid">';
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —á–∞—Å–∞–º–∏
      html += '<div class="heatmap-label"></div>';
      for (let h = 0; h < 24; h++) {
        html += `<div class="heatmap-label">${h}</div>`;
      }
      
      // –°—Ç—Ä–æ–∫–∏ –ø–æ –¥–Ω—è–º
      for (const day of data) {
        const dayName = day.day || day.day_name || '?';
        const hourlyData = day.hourly || [];
        console.log(`üìÖ ${dayName}: ${hourlyData.length} —á–∞—Å–æ–≤`);
        
        html += `<div class="heatmap-label">${dayName}</div>`;
        for (let h = 0; h < 24; h++) {
          const val = hourlyData[h] || 0;
          const intensity = maxVal > 0 ? val / maxVal : 0;
          const color = getHeatColor(intensity);
          html += `<div class="heatmap-cell" style="background: ${color}" title="${dayName} ${h}:00 - ${formatNumber(val)} –±–æ—ë–≤">${val > 0 ? '' : ''}</div>`;
        }
      }
      
      html += '</div>';
      html += `<div style="margin-top: 12px; font-size: 12px; color: var(--text-muted); text-align: center;">
        –ú–∞–∫—Å–∏–º—É–º: ${maxVal} –±–æ—ë–≤ | –í—Å–µ–≥–æ –¥–Ω–µ–π: ${data.length}
      </div>`;
      container.innerHTML = html;
    }

    // –¶–≤–µ—Ç –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
    function getHeatColor(intensity) {
      const colors = [
        '#0f172a', // –æ—á–µ–Ω—å –Ω–∏–∑–∫–∞—è
        '#1e3a8a', // –Ω–∏–∑–∫–∞—è
        '#2563eb', // —Å—Ä–µ–¥–Ω—è—è
        '#60a5fa', // –≤—ã—Å–æ–∫–∞—è
        '#a78bfa', // –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è
      ];
      const idx = Math.floor(intensity * (colors.length - 1));
      return colors[idx];
    }

    // –ò–Ω—Å–∞–π—Ç—ã
    function renderInsights() {
      const grid = document.getElementById('insights-grid');
      
      if (!peakData || !peakData.peak_hour || !peakData.min_hour) {
        grid.innerHTML = '<p style="text-align:center; color: var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å–∞–π—Ç–æ–≤</p>';
        return;
      }
      
      const insights = [];
      
      // –ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è
      insights.push({
        icon: 'üî•',
        title: '–ü–∏–∫–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        text: `–ù–∞–∏–±–æ–ª—å—à–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –≤ ${peakData.peak_hour.hour}:00 —Å ${formatNumber(peakData.peak_hour.battles)} –±–æ—è–º–∏. –≠—Ç–æ –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–≤–µ–Ω—Ç–æ–≤.`
      });
      
      // –ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      insights.push({
        icon: 'üò¥',
        title: '–í—Ä–µ–º—è –Ω–∏–∑–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
        text: `–°–∞–º–æ–µ —Ç–∏—Ö–æ–µ –≤—Ä–µ–º—è –≤ ${peakData.min_hour.hour}:00 (–≤—Å–µ–≥–æ ${formatNumber(peakData.min_hour.battles)} –±–æ—ë–≤). –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç.`
      });
      
      // –í—ã—Ö–æ–¥–Ω—ã–µ
      if (peakData.day_of_week_stats && peakData.day_of_week_stats.length > 0) {
        const weekendAvg = peakData.day_of_week_stats
          .filter(d => d.day === '–°–±' || d.day === '–í—Å')
          .reduce((sum, d) => sum + d.hourly.reduce((a, b) => a + b, 0), 0) / 2;
        
        if (weekendAvg > 0) {
          insights.push({
            icon: 'üìÖ',
            title: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ',
            text: `–í –≤—ã—Ö–æ–¥–Ω—ã–µ —Å—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${formatNumber(weekendAvg)} –±–æ—ë–≤, —á—Ç–æ ${weekendAvg > (peakData.avg_battles_per_hour || 0) ? '–≤—ã—à–µ' : '–Ω–∏–∂–µ'} —Å—Ä–µ–¥–Ω–µ–π –ø–æ –±—É–¥–Ω—è–º.`
          });
        }
      }
      
      grid.innerHTML = insights.map(i => `
        <div class="insight-card">
          <div class="insight-icon">${i.icon}</div>
          <div class="insight-title">${i.title}</div>
          <div class="insight-text">${i.text}</div>
        </div>
      `).join('');
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    document.getElementById('btn-view-bar').addEventListener('click', () => {
      currentChartType = 'bar';
      renderChart();
    });

    document.getElementById('btn-view-line').addEventListener('click', () => {
      currentChartType = 'line';
      renderChart();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ activity heatmap
    document.getElementById('btn-load-activity-heatmap').addEventListener('click', async () => {
      const days = parseInt(document.getElementById('filter-days').value) || 30;
      
      showLoading();
      try {
        const result = await api.client.get('/analytics/time/activity-heatmap', { days: days });
        const data = result.success ? result.data : result;
        
        if (!data || !data.heatmap) {
          throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API');
        }
        
        renderActivityHeatmap(data.heatmap);
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // –†–µ–Ω–¥–µ—Ä activity heatmap
    function renderActivityHeatmap(heatmapData) {
      const container = document.getElementById('activity-heatmap-container');
      
      console.log('üî• –†–µ–Ω–¥–µ—Ä Activity Heatmap, –ø–æ–ª—É—á–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', heatmapData?.length);
      console.log('üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:', heatmapData?.slice(0, 5));
      
      if (!heatmapData || !Array.isArray(heatmapData) || heatmapData.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ: day_of_week (0-6), hour (0-23), battles
      const daysOfWeek = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const hours = Array.from({length: 24}, (_, i) => i);
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
      const dataMap = new Map();
      heatmapData.forEach(d => {
        const key = `${d.day_of_week}-${d.hour}`;
        dataMap.set(key, d.battles || 0);
      });
      
      console.log('üóÇÔ∏è –ö–∞—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞, —Ä–∞–∑–º–µ—Ä:', dataMap.size);
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
      const dayStats = Array(7).fill(0);
      heatmapData.forEach(d => {
        if (d.day_of_week >= 0 && d.day_of_week <= 6) {
          dayStats[d.day_of_week] += (d.battles || 0);
        }
      });
      console.log('üìÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º:', dayStats.map((v, i) => `${daysOfWeek[i]}: ${v}`));
      
      // –ù–∞–π–¥—ë–º –º–∞–∫—Å–∏–º—É–º –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞
      const maxBattles = Math.max(...heatmapData.map(d => d.battles || 0), 1);
      console.log('üìà –ú–∞–∫—Å–∏–º—É–º –±–æ—ë–≤ –≤ —è—á–µ–π–∫–µ:', maxBattles);
      
      let html = '<div style="overflow-x: auto;">';
      html += '<table style="width: 100%; border-collapse: collapse; font-size: 11px;">';
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —á–∞—Å–∞–º–∏
      html += '<thead><tr><th style="padding: 8px; border: 1px solid var(--border); background: var(--bg-hover);">–î–µ–Ω—å/–ß–∞—Å</th>';
      hours.forEach(h => {
        html += `<th style="padding: 6px; border: 1px solid var(--border); text-align: center; background: var(--bg-hover);">${h}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      // –°—Ç—Ä–æ–∫–∏ —Å –¥–Ω—è–º–∏ (0=–≤—Å, 1=–ø–Ω, ..., 6=—Å–±)
      for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
        const dayTotal = dayStats[dayIdx];
        html += `<tr><td style="padding: 8px; border: 1px solid var(--border); font-weight: bold; background: var(--bg-hover);">${daysOfWeek[dayIdx]} (${dayTotal})</td>`;
        
        hours.forEach(hour => {
          const key = `${dayIdx}-${hour}`;
          const battles = dataMap.get(key) || 0;
          const intensity = battles / maxBattles;
          const bgColor = battles > 0 ? `rgba(96, 165, 250, ${0.2 + intensity * 0.8})` : 'rgba(60, 60, 60, 0.2)';
          
          html += `<td style="padding: 6px; border: 1px solid var(--border); background: ${bgColor}; text-align: center; color: ${intensity > 0.5 ? '#fff' : 'var(--text-primary)'}; min-width: 30px;" title="${daysOfWeek[dayIdx]} ${hour}:00 - –±–æ—ë–≤: ${battles}">${battles > 0 ? battles : '¬∑'}</td>`;
        });
        html += '</tr>';
      }
      
      html += '</tbody></table>';
      html += `<div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
        –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${heatmapData.length} | –ú–∞–∫—Å–∏–º—É–º –≤ —è—á–µ–π–∫–µ: ${maxBattles} –±–æ—ë–≤ | ¬∑ = –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      </div>`;
      html += '</div>';
      container.innerHTML = html;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    document.getElementById('btn-load').addEventListener('click', loadData);
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–Ω–µ–π
    document.getElementById('filter-daytype').addEventListener('change', applyDayFilter);
  </script>
</body>
</html>

