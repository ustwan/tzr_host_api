# game_bridge - TCP Proxy для Game Server
# Изолирует Game Server, разрешая подключения только из HOST_API

stream {
    # Формат логирования
    log_format game_proxy '$remote_addr [$time_local] '
                          '$protocol $status $bytes_sent $bytes_received '
                          '$session_time "$upstream_addr" '
                          '$upstream_bytes_sent $upstream_bytes_received '
                          '$upstream_connect_time';
    
    # Логи
    access_log /var/log/nginx/game_bridge_access.log game_proxy;
    error_log  /var/log/nginx/game_bridge_error.log warn;
    
    # Upstream - Game Server
    # PROD: 127.0.0.1:5190 (Game Server на том же хосте)
    # TEST: game_server_mock:5190 (Docker container)
    upstream game_server {
        server game_server_mock:5190;  # для локальных тестов
        
        # В проде заменить на:
        # server 127.0.0.1:5190;
        
        # Keepalive для переиспользования соединений
        # keepalive 8;
    }
    
    # Основной сервер
    server {
        listen 5191;
        
        # IP whitelist - только HOST_API (10.8.0.1)
        # В проде раскомментировать:
        # allow 10.8.0.1;
        # deny all;
        
        # Проксирование на Game Server
        proxy_pass game_server;
        
        # Таймауты
        proxy_connect_timeout 5s;
        proxy_timeout 10s;
        
        # Размеры буферов
        proxy_buffer_size 16k;
        
        # Включить proxy protocol (опционально)
        # proxy_protocol on;
    }
}

# События
events {
    worker_connections 1024;
}

