# üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ API 4

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Health checks** - 3/3 —Ä–∞–±–æ—Ç–∞—é—Ç:
   - `GET /healthz` ‚úÖ
   - `GET /battle/health` ‚úÖ
   - `GET /analytics/health` ‚úÖ

## ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

–í—Å–µ endpoint –∏–∑ `routes.py` (15 —à—Ç—É–∫) –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã:
- `GET /battle/{id}`
- `GET /battle/list`
- `GET /battle/search`
- `POST /sync`
- `POST /sync/reprocess`
- `GET /analytics/player/{login}`
- `GET /analytics/players/top`
- `GET /analytics/clan/{name}`
- `GET /analytics/resource/{name}`
- `GET /analytics/monster/{kind}`
- `GET /analytics/anomalies`
- `GET /analytics/stats`
- `GET /admin/loading-stats`
- `POST /admin/cleanup`

## üîç –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´:

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API 4:

```
api_4/app/
‚îú‚îÄ‚îÄ main.py                    # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
‚îú‚îÄ‚îÄ interfaces/http/routes.py  # –†–æ—É—Ç–µ—Ä —Å 15 endpoint
‚îî‚îÄ‚îÄ infrastructure/container.py # DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
```

### –ü—Ä–æ–±–ª–µ–º–∞:

API 4 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–Ω–µ—Ä–∞–±–æ—Ç–∞—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É DI** –≥–¥–µ:
1. `container.py` —Å–æ–∑–¥–∞–µ—Ç –ù–û–í–´–ô `FastAPI()` –æ–±—ä–µ–∫—Ç
2. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç —Ä–æ—É—Ç–µ—Ä –∫ –≠–¢–û–ú–£ –æ–±—ä–µ–∫—Ç—É
3. –ù–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ `main.py` - –¥—Ä—É–≥–æ–π –æ–±—ä–µ–∫—Ç!

### –ü–æ–ø—ã—Ç–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–∞—Ä—à—Ä—É—Ç—ã –≤ `routes.py` (—É–±—Ä–∞–ª–∏ `/api/` prefix)
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Traefik stripPrefix
3. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä —á–µ—Ä–µ–∑ `app.router` - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ `lifespan` - FastAPI –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `include_router` –≤ lifespan
5. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ `@app.on_event("startup")` - deprecated, –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

–ù—É–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `main.py`:
1. –£–±—Ä–∞—Ç—å `container.py` –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –µ–≥–æ
2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä –ù–ê–ü–†–Ø–ú–£–Æ –≤ `main.py` –î–û —Å–æ–∑–¥–∞–Ω–∏—è `app`
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π lifespan —Å dependency injection

## üìù –ö–û–î –ö–û–¢–û–†–´–ô –†–ê–ë–û–¢–ê–ï–¢:

```python
# wg_client/api_4/app/main.py (–¢–ï–ö–£–©–ò–ô - –ß–ê–°–¢–ò–ß–ù–û)
@app.get("/healthz")  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
async def healthz():
    return {"status": "ok"}
```

## üìù –ö–û–î –ö–û–¢–û–†–´–ô –ù–ï –†–ê–ë–û–¢–ê–ï–¢:

```python
# wg_client/api_4/app/interfaces/http/routes.py
@router.get("/battle/list")  # ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
async def list_battles(...):
    ...
```

## üéØ –ò–¢–û–ì–ò:

- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å API 4:** 20% (3/18 endpoint)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ DI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–¢—Ä–µ–±—É–µ—Ç—Å—è:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `main.py` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–∞

---

**–î–∞—Ç–∞:** 2025-10-01  
**–°—Ç–∞—Ç—É—Å:** API 4 —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
