# WG_HUB - Сводные данные проекта

## Общее описание

**WG_HUB** - это комплексная система клиента, работающего внутри WireGuard VPN без TLS, с единой точкой доступа к базе данных и маршрутизацией через Traefik. Проект предназначен для работы с игровыми данными и предоставления API для различных сервисов.

## Архитектура системы

### Сетевые компоненты
- **`apinet`** — внешняя docker-сеть (общая для Traefik + WG + доступ из VPN)
- **`backnet`** — внутренняя сеть API_* ↔ API_FATHER (internal)
- **`dbnet`** — внутренняя сеть API_FATHER ↔ DB (internal)

### Основные сервисы
- **`wg_vpn`** — WireGuard-клиент (linuxserver/wireguard)
- **`traefik`** — маршрутизация и UI (доступ только из VPN), HTTP на :80
- **`api_father`** — единая точка доступа к БД + Redis
- **`worker`** — фоновые задачи (читает Redis-очередь)
- **`api_1`, `api_2`, `api_4`** — бизнес-API сервисы

## API Сервисы

### API_1 - Server Status
- **Назначение**: Мониторинг статуса игрового сервера
- **Эндпоинты**: `/server/status`, `/healthz`
- **Функции**: Получение статуса сервера, курсов валют, клиентского статуса
- **Порт**: 8081

### API_2 - Registration & Bonus
- **Назначение**: Регистрация игроков и система бонусов
- **Эндпоинты**: `/register`, `/bonus`, `/healthz`
- **Функции**: Регистрация новых игроков, управление бонусами
- **Порт**: 8082

### API_4 - Battle Analytics (Самый сложный сервис)
- **Назначение**: Анализ логов боёв и игровой аналитики
- **Основные возможности**:
  - Парсинг XML файлов (.tzb) с логами боёв
  - Извлечение метаданных и нормализация данных
  - 13 витрин данных (data marts) для быстрого доступа
  - Аналитика включая антибот, экономику, командную динамику
  - REST API для поиска и анализа боёв
- **Эндпоинты**: `/battle/*`, `/analytics/*`, `/sync/*`, `/admin/*`
- **Порт**: 8084

### API_FATHER - Центральный сервис
- **Назначение**: Единая точка доступа к базе данных и Redis
- **Функции**: Управление подключениями к БД, работа с Redis очередями
- **Порт**: 9000

## Веб-интерфейсы

### Traefik Dashboard
- **URL**: `http://<WG_IP_CLIENTA>:80/dashboard`
- **Доступ**: Только из VPN с basic auth
- **Функции**: Мониторинг маршрутизации, статистика запросов

### API Эндпоинты (доступны через VPN)
- `GET http://<WG_IP_CLIENTA>/api/server/status` - статус сервера
- `GET http://<WG_IP_CLIENTA>/api/register/*` - регистрация
- `GET http://<WG_IP_CLIENTA>/api/bonus/*` - бонусы
- `GET http://<WG_IP_CLIENTA>/api/info/*` - информация
- `GET http://<WG_IP_CLIENTA>/api/battle/*` - данные боёв
- `GET http://<WG_IP_CLIENTA>/api/analytics/*` - аналитика

## Сетевая инфраструктура

### WireGuard VPN
- **Тип**: Клиентский конфигурационный файл `wg0.conf`
- **Сеть**: 10.8.0.0/24
- **DNS**: 1.1.1.1
- **Endpoint**: Настраивается в конфигурации

### Docker Networks
- **apinet**: Внешняя сеть для доступа из VPN
- **backnet**: Внутренняя сеть для API сервисов (internal)
- **dbnet**: Внутренняя сеть для доступа к БД (internal)

### Traefik маршрутизация
- **Entrypoint**: `vpn` на порту 80
- **File Provider**: Динамическая конфигурация через `apis.yml`
- **Middleware**: Strip prefix для API роутов

## База данных

### Режимы работы
- **test**: Тестовая БД с авто-миграциями
- **prod**: Продакшн БД в локальной сети

### Миграции
- **Flyway**: Управление схемой БД
- **Расположение**: `wg_client/db/migrations/`
- **Автоматические**: При запуске в test режиме

### API_4 База данных
- **Нормализованная схема** с справочниками
- **Справочники**: игроки, кланы, монстры, ресурсы
- **Витрины**: 13 предрассчитанных таблиц для аналитики

## Управление

### Скрипты управления
- `tools/ctl.sh up` - запуск без тестовой БД
- `tools/ctl.sh up-testdb` - запуск с тестовой БД
- `tools/ctl.sh migrate-prod` - миграции продакшн

### Peer Management (WireGuard)
- `scripts/peer_admin.sh` - управление пирами WireGuard
- Автоматическое назначение IP адресов
- Генерация клиентских конфигураций

## Безопасность

- **VPN-only доступ**: Все API доступны только через WireGuard VPN
- **Basic Auth**: Traefik dashboard защищен аутентификацией
- **Internal networks**: API сервисы изолированы внутренними сетями
- **No TLS**: Работа без TLS внутри VPN (доверенная среда)

## Развертывание

### Требования
- Linux хост с Docker и Docker Compose
- Доступ к `/dev/net/tun` для WireGuard
- WireGuard клиентская конфигурация

### Быстрый старт
1. Клонирование репозитория
2. Копирование `env.example` в `.env`
3. Настройка переменных окружения
4. Создание сети: `docker network create apinet`
5. Запуск: `bash tools/ctl.sh up` или `up-testdb`

## Особенности

- **Microservices архитектура**: Каждый API сервис независим
- **Service mesh**: Все API работают через `network_mode: "service:wg_vpn"`
- **File-based routing**: Traefik использует файловый провайдер
- **Redis очереди**: Асинхронная обработка задач через worker
- **Аналитический движок**: API_4 с мощными возможностями анализа данных
