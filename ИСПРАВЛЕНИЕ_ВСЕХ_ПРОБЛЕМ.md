# 🔧 Исправление всех проблем на сервере

## 🚨 Текущие проблемы:

1. **WG-Easy** - падает с ошибкой PASSWORD_HASH
2. **api_father** - не может занять порт 9000 (занят старым Portainer)

---

## ✅ ПОЛНОЕ РЕШЕНИЕ (копипаста для сервера):

```bash
cd /mnt/docker/tzr_host_api

# ====== Шаг 1: Остановить ВСЁ старое ======
echo "Остановка всех старых контейнеров..."
sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true

# ====== Шаг 2: Удалить проблемные контейнеры ======
echo "Удаление проблемных контейнеров..."
sudo docker rm -f wg-easy portainer 2>/dev/null || true

# ====== Шаг 3: Обновить код ======
echo "Обновление с GitHub..."
sudo git pull origin main

# ====== Шаг 4: Установить WG-Easy правильно ======
echo "Установка WG-Easy..."
cd wg_client
sudo bash setup_wg_hub.sh

# ====== Шаг 5: Запустить API и мониторинг ======
echo "Запуск API сервисов..."
sudo bash tools/ctl.sh start-all

# ====== Шаг 6: Проверка ======
echo
echo "Проверка статуса..."
sudo bash tools/ctl.sh status
echo
sudo bash tools/ctl.sh wg-hub-status

echo
echo "═══════════════════════════════════════════════════"
echo "  ✅ ГОТОВО!"
echo "═══════════════════════════════════════════════════"
echo
echo "🌐 Админки доступны:"
echo "  http://172.16.16.117:2019  - WG-Easy (VPN, пароль: admin)"
echo "  http://172.16.16.117:9100  - Portainer (Docker)"
echo "  http://172.16.16.117:9107  - Swagger (API)"
echo
echo "🔍 Из VPN (после подключения):"
echo "  http://10.8.0.1:9107  - Swagger"
echo "  http://10.8.0.1:9100  - Portainer"
echo "  http://10.8.0.1:8082  - API_2"
echo
```

---

## 📋 Или по шагам:

### 1. Остановить старые контейнеры

```bash
# Остановить всё
sudo docker ps -q | xargs -r sudo docker stop

# ИЛИ остановить только проблемные
sudo docker stop portainer wg-easy
sudo docker rm portainer wg-easy
```

### 2. Обновить код

```bash
cd /mnt/docker/tzr_host_api
sudo git pull origin main
```

### 3. Установить WG-Easy

```bash
cd wg_client
sudo bash setup_wg_hub.sh
```

**Скрипт создаст правильный конфиг с PASSWORD_HASH!**

### 4. Запустить API

```bash
sudo bash tools/ctl.sh start-all
```

### 5. Проверить

```bash
sudo bash tools/ctl.sh status

# Должны быть UP:
# ✅ api_father (порт 9000)
# ✅ api_1, api_2
# ✅ api_4
# ✅ portainer (порт 9100)
# ✅ wg-easy (порт 2019)
```

---

## 🎯 Самое простое - одна команда:

Скопируйте на сервер и выполните:

```bash
cd /mnt/docker/tzr_host_api && \
sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true && \
sudo docker rm -f wg-easy portainer 2>/dev/null || true && \
sudo git pull origin main && \
cd wg_client && \
sudo bash setup_wg_hub.sh && \
sudo bash tools/ctl.sh start-all && \
sudo bash tools/ctl.sh status
```

**Это исправит всё автоматически!** 🚀

