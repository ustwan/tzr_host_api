# üöÄ –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ (API + VPN)

## üìã –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ —Å GitHub

```bash
cd /mnt/docker/tzr_host_api
sudo git pull origin main
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WG_HUB (VPN)

```bash
# –ü–µ—Ä–µ–π—Ç–∏ –≤ WG_HUB
cd WG_HUB_/wg-easy

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
sudo cp ../../WG_HUB_/env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
sudo nano .env
```

**–ò–∑–º–µ–Ω–∏—Ç—å:**
```bash
WG_HOST=172.16.16.117   # –í–∞—à IP —Å–µ—Ä–≤–µ—Ä–∞
WG_PORT=2020            # WireGuard UDP –ø–æ—Ä—Ç
PORT=2019               # –í–µ–±-–∞–¥–º–∏–Ω–∫–∞ –ø–æ—Ä—Ç
VPN_CIDR=10.8.0.0/24   # –ü–æ–¥—Å–µ—Ç—å VPN
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å API —Å–µ—Ä–≤–∏—Å—ã

```bash
cd /mnt/docker/tzr_host_api/wg_client

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
sudo cp env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo nano .env
```

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
DB_MODE=test        # –∏–ª–∏ prod
TZ=Europe/Moscow
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–Å –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π!

```bash
cd /mnt/docker/tzr_host_api/wg_client

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–Å (WG_HUB + API + Monitoring)
sudo bash tools/ctl.sh start-full
```

**–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç:**
- ‚úÖ WG_HUB (VPN —Å–µ—Ä–≤–µ—Ä) –Ω–∞ –ø–æ—Ä—Ç—É 2020 UDP
- ‚úÖ WG-Easy (–≤–µ–±-–∞–¥–º–∏–Ω–∫–∞ VPN) –Ω–∞ –ø–æ—Ä—Ç—É 2019
- ‚úÖ –í—Å–µ Docker —Å–µ—Ç–∏
- ‚úÖ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (Redis, PostgreSQL, MySQL)
- ‚úÖ API Father (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)
- ‚úÖ –í—Å–µ API —Å–µ—Ä–≤–∏—Å—ã (API_1-5)
- ‚úÖ Workers –∏ XML Workers
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Portainer, Netdata, Dozzle)

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
# –°—Ç–∞—Ç—É—Å API —Å–µ—Ä–≤–∏—Å–æ–≤
sudo bash tools/ctl.sh status

# –°—Ç–∞—Ç—É—Å WG_HUB
sudo bash tools/ctl.sh wg-hub-status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
sudo docker ps
```

---

## üéõÔ∏è –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∫–∞–º

### WireGuard VPN (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π VPN)

```
http://172.16.16.117:2019
```

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –°–æ–∑–¥–∞—Ç—å VPN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å QR –∫–æ–¥–∞–º–∏)
- ‚úÖ –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –°–∫–∞—á–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏

**–ü–∞—Ä–æ–ª—å:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ `WG_HUB_/wg-easy/.env`

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API

```
http://172.16.16.117:9100  - Portainer (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker)
http://172.16.16.117:9102  - Dozzle (–ª–æ–≥–∏)
http://172.16.16.117:1010  - Traefik (HTTP —Ä–æ—É—Ç–∏–Ω–≥)
http://172.16.16.117:9101  - Netdata (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã)
```

---

## üîß –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### WG_HUB (VPN):

```bash
cd /mnt/docker/tzr_host_api/wg_client

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ WG_HUB
sudo bash tools/ctl.sh wg-hub

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WG_HUB
sudo bash tools/ctl.sh wg-hub-stop

# –õ–æ–≥–∏ WG_HUB
sudo bash tools/ctl.sh wg-hub-logs

# –°—Ç–∞—Ç—É—Å WG_HUB
sudo bash tools/ctl.sh wg-hub-status

# –ü–æ–∫–∞–∑–∞—Ç—å URL –∞–¥–º–∏–Ω–∫–∏
sudo bash tools/ctl.sh wg-hub-ui
```

### API —Å–µ—Ä–≤–∏—Å—ã:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ API (–±–µ–∑ WG_HUB)
sudo bash tools/ctl.sh start-all

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ PROD —Ä–µ–∂–∏–º–µ
sudo bash tools/ctl.sh start-prod

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ TEST —Ä–µ–∂–∏–º–µ
sudo bash tools/ctl.sh start-test

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
sudo bash tools/ctl.sh stop-all
```

### Site Agent (–¥–ª—è —Å–∞–π—Ç–∞):

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Site Agent
sudo bash tools/ctl.sh site-agent

# –õ–æ–≥–∏ Site Agent
sudo bash tools/ctl.sh site-agent-logs

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
sudo bash tools/ctl.sh site-agent-restart
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
sudo bash tools/ctl.sh monitoring

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
sudo bash tools/ctl.sh logs api_father
sudo bash tools/ctl.sh logs api_4

# –í—Å–µ –ª–æ–≥–∏
sudo bash tools/ctl.sh logs
```

---

## üìä –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –∑–∞–ø—É—Å–∫–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í—Å—ë —Å—Ä–∞–∑—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
sudo bash tools/ctl.sh start-full
```

–ó–∞–ø—É—Å—Ç–∏—Ç:
1. WG_HUB (VPN —Å–µ—Ä–≤–µ—Ä) ‚úÖ
2. API —Å–µ—Ä–≤–∏—Å—ã ‚úÖ
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚úÖ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏

```bash
# 1. –°–Ω–∞—á–∞–ª–∞ VPN
sudo bash tools/ctl.sh wg-hub

# 2. –ü–æ—Ç–æ–º API
sudo bash tools/ctl.sh start-all

# 3. –ü–æ—Ç–æ–º Site Agent (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
sudo bash tools/ctl.sh site-agent
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä

```bash
# –¢–æ–ª—å–∫–æ API –±–µ–∑ VPN –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
sudo bash tools/ctl.sh infrastructure
sudo bash tools/ctl.sh father
sudo bash tools/ctl.sh lightweight
```

---

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### api_4 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (Restarting)

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
sudo docker logs host-api-service-api_4-1 --tail 100

# –ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
# 1. –ù–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL
# 2. –ù–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ë–î
# 3. –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ

# –†–µ—à–µ–Ω–∏–µ:
sudo bash tools/ctl.sh stop-all
sudo bash tools/ctl.sh start-all

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
sudo bash tools/ctl.sh migrate
```

### Permission denied (Docker)

```bash
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker $USER

# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
exit  # –∏ –∑–∞–Ω–æ–≤–æ –∑–∞–π—Ç–∏ –ø–æ SSH

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑ sudo
bash tools/ctl.sh start-all
```

### WG_HUB –Ω–µ –Ω–∞–π–¥–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
ls -la /mnt/docker/tzr_host_api/

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# WG_HUB_/    ‚Üê VPN —Å–µ—Ä–≤–µ—Ä
# wg_client/  ‚Üê API —Å–µ—Ä–≤–∏—Å—ã

# –ï—Å–ª–∏ –Ω–µ—Ç WG_HUB_, —Å–∫–∞—á–∞—Ç—å —Å GitHub
cd /mnt/docker/tzr_host_api
sudo git pull origin main --recurse-submodules
```

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–æ—Å–ª–µ `sudo bash tools/ctl.sh start-full` –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

- [ ] WG_HUB –∑–∞–ø—É—â–µ–Ω (`sudo docker ps | grep wg-easy`)
- [ ] –í–µ–±-–∞–¥–º–∏–Ω–∫–∞ VPN: http://172.16.16.117:2019
- [ ] API Father —Ä–∞–±–æ—Ç–∞–µ—Ç (`curl http://localhost:9000/internal/health`)
- [ ] API_2 —Ä–∞–±–æ—Ç–∞–µ—Ç (`curl http://localhost:8082/health`)
- [ ] Portainer –¥–æ—Å—Ç—É–ø–µ–Ω: http://172.16.16.117:9100
- [ ] –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã UP (`sudo bash tools/ctl.sh status`)

---

## üéØ –ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–≥–æ

```bash
cd /mnt/docker/tzr_host_api
sudo git pull origin main
cd wg_client
sudo bash tools/ctl.sh start-full
sudo bash tools/ctl.sh status
```

**–ì–æ—Ç–æ–≤–æ!** –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É! üéâ

---

**–í–µ–±-–∞–¥–º–∏–Ω–∫–∏:**
- VPN: http://172.16.16.117:2019 (—Å–æ–∑–¥–∞–Ω–∏–µ VPN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- Docker: http://172.16.16.117:9100 (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏)
- –õ–æ–≥–∏: http://172.16.16.117:9102 (–ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤)

