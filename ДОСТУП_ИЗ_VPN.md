# 🌐 Доступ к админкам из VPN

## 🎯 Как это работает

### Ваш сервер имеет ДВА IP:

1. **LAN IP:** `172.16.16.117` (локальная сеть)
2. **VPN IP:** `10.8.0.1` (интерфейс wg0)

### Из VPN доступ по LAN IP хоста:

```
VPN клиент (10.8.0.2)
  ↓ routing через WireGuard
  ↓ может достучаться до хоста
  ↓ http://172.16.16.117:XXXX
  ✅ РАБОТАЕТ!
```

**Важно:** Порты на `0.0.0.0` слушают на **ВСЕХ** интерфейсах хоста, включая:
- `eth0` (172.16.16.117)
- `wg0` (10.8.0.1)
- `lo` (127.0.0.1)

---

## 📊 Таблица доступа

| Админка | Порт | Из локальной сети | Из VPN | По VPN IP |
|---------|------|-------------------|--------|-----------|
| **Swagger** | 9107 | http://172.16.16.117:9107 | ✅ Да | http://172.16.16.117:9107 |
| **Portainer** | 9100 | http://172.16.16.117:9100 | ✅ Да | http://172.16.16.117:9100 |
| **Dozzle** | 9102 | http://172.16.16.117:9102 | ✅ Да | http://172.16.16.117:9102 |
| **Traefik** | 1010 | http://172.16.16.117:1010 | ✅ Да | http://172.16.16.117:1010 |
| **Netdata** | 9101 | http://172.16.16.117:9101 | ✅ Да | http://172.16.16.117:9101 |
| **WG-Easy** | 2019 | http://172.16.16.117:2019 | ✅ Да | http://172.16.16.117:2019 |
| **API_1** | 8081 | http://172.16.16.117:8081 | ✅ Да | http://172.16.16.117:8081 |
| **API_2** | 8082 | http://172.16.16.117:8082 | ✅ Да | http://172.16.16.117:8082 |
| **API_Father** | 9000 | http://172.16.16.117:9000 | ✅ Да | http://172.16.16.117:9000 |

**Вывод:** Используйте **LAN IP хоста** (172.16.16.117), не VPN IP (10.8.0.1)!

---

## 🔍 Почему не по 10.8.0.1?

### Техническая причина:

```
10.8.0.1 - это IP интерфейса wg0 на хосте
  ↓
Но Docker контейнеры слушают на bridge сети
  ↓
Порты пробрасываются на IP хоста (172.16.16.117)
  ↓
НЕ на IP интерфейса wg0 (10.8.0.1)
```

**Исключение:** Если контейнер в `network_mode: host`, он может слушать на 10.8.0.1.

---

## ✅ Как будет работать (после исправлений)

### 1. Подключаетесь к VPN (WireGuard клиент)

```
Ваш компьютер
  ↓ WireGuard подключение
  ↓ Получаете IP: 10.8.0.2
  ↓ Routing: 10.8.0.0/24 → через VPN
```

### 2. Открываете админки по LAN IP сервера

```
В браузере (вы в VPN):
http://172.16.16.117:9107  - Swagger ✅
http://172.16.16.117:9100  - Portainer ✅
http://172.16.16.117:1010  - Traefik ✅
http://172.16.16.117:2019  - WG-Easy ✅
```

**Работает потому что:**
- ✅ Вы в VPN (10.8.0.2)
- ✅ Routing через WireGuard до хоста (172.16.16.117)
- ✅ Порты на 0.0.0.0 (доступны для VPN клиентов)
- ✅ IP forwarding включен
- ✅ iptables разрешает wg0 → хост

### 3. Альтернативно по VPN IP (если нужно)

Если хотите доступ именно по `10.8.0.1:XXXX`, нужно дополнительно пробросить:

```bash
# На сервере добавить DNAT правила
sudo iptables -t nat -A PREROUTING -i wg0 -d 10.8.0.1 -p tcp --dport 9107 -j DNAT --to-destination 172.16.16.117:9107
sudo iptables -t nat -A PREROUTING -i wg0 -d 10.8.0.1 -p tcp --dport 9100 -j DNAT --to-destination 172.16.16.117:9100
# И так для каждого порта...

# Проще использовать LAN IP хоста!
```

---

## 🎯 Итоговая схема доступа

```
┌──────────────────────────────────────────────────┐
│ Ваш компьютер (подключен к VPN)                  │
│ IP в VPN: 10.8.0.2                               │
└────────────────┬─────────────────────────────────┘
                 │
                 │ WireGuard tunnel
                 ↓
┌──────────────────────────────────────────────────┐
│ Сервер 172.16.16.117                             │
│ wg0: 10.8.0.1 (VPN интерфейс)                    │
├──────────────────────────────────────────────────┤
│                                                  │
│ Порты на 0.0.0.0 (все интерфейсы):              │
│   :1010  - Traefik                               │
│   :8081  - API_1                                 │
│   :8082  - API_2                                 │
│   :9000  - API_Father                            │
│   :9100  - Portainer                             │
│   :9107  - Swagger                               │
│   :2019  - WG-Easy админка                       │
│                                                  │
│ Доступно из VPN по 172.16.16.117:XXXX ✅         │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## 📝 Ответ на ваш вопрос:

**Да, все админки (Swagger, Portainer, Dozzle и т.д.) будут доступны из VPN!**

Но **по IP хоста** (172.16.16.117), а не по IP wg0 интерфейса (10.8.0.1).

**Проще говоря:**
- Подключаетесь к VPN ✅
- Открываете `http://172.16.16.117:9107` ✅
- Все работает! ✅

---

## ⚡ На сервере выполните:

```bash
# 1. Обновить с GitHub
cd /mnt/docker/tzr_host_api
sudo git pull origin main

# 2. IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# 3. iptables для VPN
sudo iptables -A INPUT -i wg0 -j ACCEPT
sudo iptables -A FORWARD -i wg0 -j ACCEPT

# 4. Запустить
cd wg_client
sudo bash tools/ctl.sh start-full

# 5. Проверить
sudo bash tools/ctl.sh status
```

**Теперь ВСЁ будет работать правильно!** 🎉

