# โ๏ธ ะัะพะฑะปะตะผะฐ ะธะฝัะตะณัะฐัะธะธ WG_HUB ั API

## ๐ด ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ

**WG_HUB ะธ API ัะตัะฒะธัั ะะ ะธะฝัะตะณัะธัะพะฒะฐะฝั ะฟัะฐะฒะธะปัะฝะพ!**

### ะงัะพ ัะตะนัะฐั:

```
WG-Easy (network_mode: host)
  โ ัะพะทะดะฐะตั wg0 ะฝะฐ ัะพััะต
  โ VPN ัะตัั: 10.8.0.0/24
  โ ะะปะธะตะฝัั VPN: 10.8.0.2, 10.8.0.3, ...
  
Traefik (ะฒ Docker bridge ัะตัะธ)
  โ ะฟะพัั 1010
  โ ัะตัั: host-api-network
  
API ัะตัะฒะธัั (ะฒ Docker bridge ัะตัะธ)
  โ ะฟะพััั 8081-8085, 9000
  โ ัะตัั: host-api-network
```

**ะัะพะฑะปะตะผะฐ:** ะะปะธะตะฝัั VPN (10.8.0.x) **ะะ ัะผะพะณัั** ะดะพััััะฐัััั ะดะพ API ัะตัะฒะธัะพะฒ!

---

## โ ะะตัะตะฝะธั

### ะะตัะตะฝะธะต 1: ะัะฑะปะธะบะพะฒะฐัั ะฟะพััั ะฝะฐ 0.0.0.0 (ะะะะกะขะะ)

**ะกััั:** API ัะตัะฒะธัั ัะปััะฐัั ะฝะฐ ะฒัะตั ะธะฝัะตััะตะนัะฐั ัะพััะฐ (ะฒะบะปััะฐั wg0)

#### ะะทะผะตะฝะตะฝะธั ะฒ compose ัะฐะนะปะฐั:

```yaml
# HOST_API_SERVICE_LIGHT_WEIGHT_API.yml
services:
  api_1:
    ports:
      - "0.0.0.0:8081:8081"  # ะะผะตััะพ ะฟัะพััะพ "8081:8081"
  
  api_2:
    ports:
      - "0.0.0.0:8082:8082"

# HOST_API_SERVICE_FATHER_API.yml
services:
  api_father:
    ports:
      - "0.0.0.0:9000:9000"  # ะะผะตััะพ "8080:9000"

# HOST_API_SERVICE_INFRASTRUCTURE.yml
services:
  traefik:
    ports:
      - "0.0.0.0:1010:1010"
```

**ะะพัะปะต ััะพะณะพ:**
```
VPN ะบะปะธะตะฝั (10.8.0.2)
  โ http://172.16.16.117:8081
  โ http://172.16.16.117:9000
  โ ะะะะะขะะะข!
```

**ะะปััั:**
- โ ะัะพััะพ
- โ ะะฐะฑะพัะฐะตั ััะฐะทั

**ะะธะฝััั:**
- โ๏ธ ะะพััั ะพัะบัััั ะฝะฐ ะฒัะตั ะธะฝัะตััะตะนัะฐั (ะฝัะถะตะฝ firewall)

---

### ะะตัะตะฝะธะต 2: Traefik ะฒ host mode (ะะะะะะะฌะะะ ะฟะพ WG_HUB ะปะพะณะธะบะต)

**ะกััั:** Traefik ัะปััะฐะตั ะฝะฐะฟััะผัั ะฝะฐ wg0 ะธะฝัะตััะตะนัะต (10.8.0.1:8081)

#### ะะทะผะตะฝะตะฝะธั:

```yaml
# HOST_API_SERVICE_INFRASTRUCTURE.yml
services:
  traefik:
    image: traefik:v3.1
    network_mode: "host"  # โ ะะผะตััะพ bridge ัะตัะธ
    command:
      - "--entrypoints.vpn.address=10.8.0.1:8081"  # โ ะกะปััะฐะตะผ ะฝะฐ VPN IP
    # ports: ัะฑัะฐัั (host mode ะฝะต ะฝัะถะฝั)
```

**API ัะตัะฒะธัั ะพััะฐัััั ะฒ bridge ัะตัะธ**, ะฝะพ Traefik ะธั ะฒะธะดะธั ัะตัะตะท Docker provider.

**ะะพัะปะต ััะพะณะพ:**
```
VPN ะบะปะธะตะฝั (10.8.0.2)
  โ http://10.8.0.1:8081/api/...
  โ Traefik ะผะฐัััััะธะทะธััะตั ะฒ Docker bridge
  โ ะะะะะขะะะข!
```

**ะะปััั:**
- โ ะะตะทะพะฟะฐัะฝะพ (ะดะพัััะฟ ัะพะปัะบะพ ะธะท VPN)
- โ ะกะพะพัะฒะตัััะฒัะตั Mode A ะธะท WG_HUB ะดะพะบัะผะตะฝัะฐัะธะธ

**ะะธะฝััั:**
- โ๏ธ ะัะถะฝะพ ะฒะบะปััะธัั Docker provider ะฒ Traefik
- โ๏ธ API ะดะพะปะถะฝั ะฑััั ะฒ apinet ัะตัะธ

---

### ะะตัะตะฝะธะต 3: ะะธะฑัะธะดะฝะพะต (ะะะะะะะะะฃะฎ)

**ะกััั:** API ะฟัะฑะปะธะบััััั ะฝะฐ ัะพัั IP, ะฝะพ ะทะฐัะธัะตะฝั firewall

#### 1. ะัะฑะปะธะบัะตะผ API ะฝะฐ ัะพัั

```yaml
# ะะพััั ะฝะฐ 0.0.0.0 (ะฒัะต ะธะฝัะตััะตะนัั)
ports:
  - "0.0.0.0:8081:8081"
  - "0.0.0.0:8082:8082"
  - "0.0.0.0:9000:9000"
  - "0.0.0.0:1010:1010"
```

#### 2. ะะฐัะธัะฐะตะผ firewall

```bash
# ะะฐะทัะตัะธัั ัะพะปัะบะพ VPN ะธ ะปะพะบะฐะปัะฝัั ัะตัั
sudo ufw allow from 10.8.0.0/24 to any port 8081  # API_1
sudo ufw allow from 10.8.0.0/24 to any port 8082  # API_2
sudo ufw allow from 10.8.0.0/24 to any port 9000  # API_Father
sudo ufw allow from 10.8.0.0/24 to any port 1010  # Traefik

sudo ufw allow from 172.16.16.0/24 to any port 8081
sudo ufw allow from 172.16.16.0/24 to any port 8082
sudo ufw allow from 172.16.16.0/24 to any port 9000
sudo ufw allow from 172.16.16.0/24 to any port 1010

# ะะฐะฟัะตัะธัั ะพััะฐะปัะฝัะผ
sudo ufw default deny incoming
sudo ufw enable
```

**ะะพัะปะต ััะพะณะพ:**
```
VPN ะบะปะธะตะฝั (10.8.0.2)
  โ http://172.16.16.117:8081  โ ะะฐะทัะตัะตะฝะพ firewall
  โ http://172.16.16.117:9000  โ ะะฐะทัะตัะตะฝะพ firewall

ะะฝะตัะฝะธะน ะทะปะพัะผััะปะตะฝะฝะธะบ
  โ http://172.16.16.117:8081  โ ะะฐะฑะปะพะบะธัะพะฒะฐะฝะพ firewall
```

---

## ๐ฏ ะงัะพ ะฝัะถะฝะพ ัะดะตะปะฐัั

### ะััััะพะต ัะตัะตะฝะธะต (ะดะปั ัะตััะฐ):

```bash
# ะะฐ ัะตัะฒะตัะต ะฒะบะปััะธัั IP forwarding (ะตัะปะธ ะตัะต ะฝะต ะฒะบะปััะตะฝะพ)
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.conf.all.forwarding=1

# ะะพะฑะฐะฒะธัั ะฟัะฐะฒะธะปะพ iptables ะดะปั ะดะพัััะฟะฐ ะธะท VPN ะบ ัะพััั
sudo iptables -A INPUT -i wg0 -j ACCEPT
sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -A FORWARD -o wg0 -j ACCEPT

# ะกะพััะฐะฝะธัั ะฟัะฐะฒะธะปะฐ
sudo apt install iptables-persistent
sudo netfilter-persistent save
```

**ะะพัะปะต ััะพะณะพ VPN ะบะปะธะตะฝัั ัะผะพะณัั ะดะพััััะฐัััั ะดะพ ะฟะพััะพะฒ ะฝะฐ ัะพััะต!**

---

## ๐ ะัะพะฒะตัะบะฐ ัะฐะฑะพัั VPN โ API

### ะะพัะปะต ะทะฐะฟััะบะฐ:

**1. ะะฐ ัะตัะฒะตัะต:**
```bash
# ะะฐะฟัััะธัั WG_HUB
sudo bash tools/ctl.sh wg-hub

# ะะฐะฟัััะธัั API
sudo bash tools/ctl.sh start-all

# ะัะพะฒะตัะธัั ััะพ wg0 ัะพะทะดะฐะปัั
ip addr show wg0

# ะะพะปะถะฝะพ ะฟะพะบะฐะทะฐัั:
# wg0: inet 10.8.0.1/24
```

**2. ะกะพะทะดะฐัั VPN ะฟะพะปัะทะพะฒะฐัะตะปั:**
```
http://172.16.16.117:2019
โ ะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปั
โ ะกะบะฐัะฐัั ะบะพะฝัะธะณ
โ ะะพะดะบะปััะธัััั ะบ VPN
```

**3. ะะพัะปะต ะฟะพะดะบะปััะตะฝะธั ะบ VPN:**
```bash
# ะก ะฒะฐัะตะณะพ ะบะพะผะฟัััะตัะฐ (ะฒ VPN)
ping 10.8.0.1          # ะะพะปะถะตะฝ ะพัะฒะตัะฐัั
ping 172.16.16.117     # ะะพะปะถะตะฝ ะพัะฒะตัะฐัั

# ะัะพะฒะตัะธัั ะดะพัััะฟ ะบ API
curl http://172.16.16.117:8082/health
curl http://172.16.16.117:9000/internal/health
curl http://172.16.16.117:1010
```

---

## โก ะัะฐะฒะธะปัะฝะฐั ะฐััะธัะตะบัััะฐ

### ะกะตะนัะฐั ะฝัะถะฝะฐ ัะฐะบะฐั ััะตะผะฐ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ VPN ะะปะธะตะฝั (10.8.0.2)                   โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ WireGuard VPN
                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะตัะฒะตั (172.16.16.117)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                         โ
โ wg0 ะธะฝัะตััะตะนั: 10.8.0.1/24             โ
โ   โ iptables FORWARD                   โ
โ   โ                                     โ
โ Docker bridge (host-api-network)       โ
โ   โโ Traefik :1010                     โ
โ   โโ API_Father :9000                  โ
โ   โโ API_1 :8081                       โ
โ   โโ API_2 :8082                       โ
โ                                         โ
โ ะะพััั ะพะฟัะฑะปะธะบะพะฒะฐะฝั ะฝะฐ 0.0.0.0          โ
โ Firewall ัะฐะทัะตัะฐะตั 10.8.0.0/24         โ
โ                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ ะัะพะณะพะฒัะน ะฟะปะฐะฝ ะดะตะนััะฒะธะน

### 1. ะะฑะฝะพะฒะธัั compose ัะฐะนะปั (ั ััะพ ัะดะตะปะฐั)

ะะทะผะตะฝะธัั ะฟะพััั ะฝะฐ `0.0.0.0:XXXX` ะดะปั ะดะพัััะฟะฐ ะธะท VPN

### 2. ะะฐ ัะตัะฒะตัะต ะฝะฐัััะพะธัั firewall

```bash
# ะะบะปััะธัั IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# ะะฐะทัะตัะธัั VPN โ ัะพัั
sudo iptables -A INPUT -i wg0 -j ACCEPT
sudo iptables -A FORWARD -i wg0 -j ACCEPT

# ะกะพััะฐะฝะธัั
sudo apt install iptables-persistent
sudo netfilter-persistent save
```

### 3. ะะฐะฟัััะธัั

```bash
sudo bash tools/ctl.sh start-full
```

---

**ะกะตะนัะฐั ั ะธัะฟัะฐะฒะปั compose ัะฐะนะปั ััะพะฑั API ะฑัะปะธ ะดะพัััะฟะฝั ะธะท VPN!**

